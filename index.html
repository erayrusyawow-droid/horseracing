<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horse Manager Sim - STABIL FULL V32 - KESÄ°N Ã‡Ã–ZÃœM</title>
    <style>
	/* --- YARIÅ PÄ°STÄ° VE ANÄ°MASYON STÄ°LLERÄ° --- */
.race-track-container {
    width: 100%;
    height: 350px;
    background: #556B2F; /* Koyu yeÅŸil pist */
    border: 5px solid #8B4513; /* Pist kenarÄ± */
    position: relative;
    overflow: hidden;
    margin-top: 20px;
}
/* --- SABÄ°T TRÄ°BÃœN ALANI (Pistten BaÄŸÄ±msÄ±z - DÃœZELTÄ°LMÄ°Å ZOOMLU HALÄ°) --- */
.tribune-panel {
    width: 100%;
    /* YÃ¼kseklik: Bunu artÄ±rÄ±rsan (Ã¶rn: 200px) tribÃ¼n daha yÃ¼ksek gÃ¶rÃ¼nÃ¼r */
    height: 160px; 
    
    background-image: url('resimler/tribun.jpg'); 
    
    /* Ã–NEMLÄ° DEÄÄ°ÅÄ°KLÄ°K BURADA: */
    /* 'cover' yerine bunu kullanÄ±yoruz. Resmi yÃ¼ksekliÄŸe gÃ¶re sÄ±ÄŸdÄ±rÄ±r, bÃ¶ylece zoom yapmaz. */
    background-size: auto 100%; 
    
    /* Resim ekrana yetmezse yan yana tekrar etsin ki boÅŸluk kalmasÄ±n */
    background-repeat: repeat-x; 
    
    /* Resmin tam ortasÄ±nÄ± hizala */
    background-position: center center; 

    border-top: 5px solid #8B4513; /* Pist ile uyumlu kenarlÄ±k */
    margin-top: -5px; /* Piste tam yapÄ±ÅŸmasÄ± iÃ§in */
    position: relative;
    z-index: 99; /* Her ÅŸeyin Ã¼stÃ¼nde ve net */
    /* GÃ¶lgelik ekleyerek derinlik katalÄ±m */
    box-shadow: inset 0 10px 20px rgba(0,0,0,0.3);
}
/* --- SABÄ°T REKLAM PANOLARI --- */
.ad-boards-container {
    position: absolute;
    bottom: 5px;
    left: 0;
    width: 100%; /* Kayma olmadÄ±ÄŸÄ± iÃ§in tam geniÅŸlik yeterli */
    height: 45px;
    display: flex;
    justify-content: space-around; /* TabelalarÄ± pist boyunca eÅŸit daÄŸÄ±tÄ±r */
    padding: 5px;
    background: rgba(0, 0, 0, 0.5);
    z-index: 4;
}

.ad-board {
    flex: 1; /* TÃ¼m kutular aynÄ± boyutta olur */
    max-width: 110px;
    height: 35px;
    background-color: #fff;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    border-bottom: 3px solid #ccc; /* Derinlik hissi verir */
}

@keyframes adScroll {
    from { transform: translateX(0); }
    to { transform: translateX(-50%); }
}
.lane {
    width: 100%;
    height: 25px; /* Her ÅŸerit yÃ¼ksekliÄŸi */
    border-bottom: 1px dashed #fff;
    position: relative;
}

.horse-container {
    position: absolute;
    top: 0;
    left: 0%;
    width: 15%; /* AtÄ±n kapladÄ±ÄŸÄ± alan */
    display: flex;
    align-items: center;
    transition: left 1s linear; /* Animasyon hÄ±zÄ± (SimulateRace'deki duration ile ayarlanacak) */
}

.horse-gif {
    height: 25px;
    width: auto;
}

.finish-line {
    position: absolute;
    right: 15%; /* BitiÅŸ Ã§izgisinin yeri */
    top: 0;
    height: 100%;
    width: 2px;
    background-color: white;
    border-left: 2px dashed red;
    z-index: 5;
}

/* Hava Durumu Efektleri (Opsiyonel ama iyi durur) */
.rain-overlay, .mud-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10;
    pointer-events: none;
}
.rain-overlay {
    background: rgba(100, 149, 237, 0.3); /* AÃ§Ä±k Mavi (YaÄŸmur) */
    opacity: 0.7;
}
.mud-overlay {
    background: rgba(139, 69, 19, 0.4); /* Kahverengi (Ã‡amur) */
    opacity: 0.8;
}
        /* --- GENEL TASARIM (AT06 ORÄ°JÄ°NAL) --- */
        body { 
            background-color: #2c3e50; 
            color: #ecf0f1; 
            font-family: 'Courier New', Courier, monospace; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            user-select: none; 
            overflow: hidden; 
            background-image: url('horsebg.jpeg'); 
            background-size: cover; 
            background-position: center center; 
            background-attachment: fixed; 
        }
        .game-container { 
            width: 98%;           
            height: 98%;          
            max-width: none;      
            max-height: none;     
            background-color: #000; 
            border: 4px solid #95a5a6; 
            display: grid; 
            grid-template-columns: 250px 1fr; 
            grid-template-rows: 60px 30px 1fr 80px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.8); 
            position: relative; 
        }
        
        /* HEADER & SIDEBAR */
        .header { grid-column: 1 / -1; background-color: #2c3e50; border-bottom: 2px solid #7f8c8d; display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: bold; padding: 0 10px; }
        .stat-box { background: #000; color: #2ecc71; padding: 10px 20px; border: 1px solid #7f8c8d; min-width: 150px; text-align: center; }
        .sidebar { grid-row: 3 / 4; background-color: #34495e; padding: 10px; border-right: 2px solid #7f8c8d; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        .menu-btn { background-color: #bdc3c7; color: #000; border: 2px solid #ecf0f1; border-bottom-color: #7f8c8d; border-right-color: #7f8c8d; padding: 15px; font-weight: bold; cursor: pointer; text-align: left; transition: all 0.1s; }
        .menu-btn:active { transform: translate(1px, 1px); border-color: #7f8c8d; }
        .menu-category { font-size: 12px; color: #f1c40f; margin-top: 10px; border-bottom: 1px dashed #7f8c8d; padding-bottom: 3px; }

        /* YENÄ°: MENÃœ BUTONU HOVER EFECTÄ° (PARLAMA) */
        .sidebar .menu-btn:hover {
            background-color: #3498db !important; 
            color: #fff !important;
            padding-left: 20px; 
            box-shadow: 0 0 12px rgba(52, 152, 219, 0.8); 
        }


        /* MAIN VIEW */
        .main-view { grid-row: 3 / 4; background-color: #222; padding: 20px; overflow: auto; position: relative; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { text-align: left; border-bottom: 2px solid #2ecc71; color: #2ecc71; padding: 5px; }
        td { border-bottom: 1px dotted #555; padding: 8px 5px; color: #ccc; }
        tr:hover { background-color: #333; cursor: pointer; }
        
        .elite-horse { color: #f1c40f !important; text-shadow: 0 0 5px #f39c12; }
        .injured-horse { color: #e74c3c !important; text-decoration: line-through; }
        .btn-action { background-color: #e67e22; color: white; border: 1px solid #d35400; padding: 5px 10px; cursor: pointer; font-size: 12px; margin-right: 5px; }
        .btn-sell { background-color: #c0392b; border-color: #e74c3c; } 
        .rating-badge { background: #fff; color: #000; font-weight: bold; padding: 2px 5px; border-radius: 4px; font-size: 11px; }

        /* FOOTER */
        .footer { 
            grid-row: 4 / -1; 
            grid-column: 1 / -1; 
            background-color: #2c3e50; 
            border-top: 2px solid #7f8c8d; 
            display: flex; 
            justify-content: flex-start; 
            align-items: center; 
            padding: 0 20px;
            font-size: 10px; 
            color: #7f8c8d;
        }
        
        .next-btn { 
            background-color: #e74c3c; 
            color: white; 
            padding: 15px 20px; 
            font-size: 18px; 
            font-weight: bold; 
            border: 3px solid #c0392b; 
            cursor: pointer; 
            box-shadow: 4px 4px 0px #000;
            margin-left: 20px; 
            white-space: nowrap;
        }

        /* --- MODAL VE AÃ‡IK ARTIRMA MODAL STÄ°LLERÄ° (KESÄ°N KÄ°LÄ°TLEME) --- */

        /* 1. GENEL MODAL (Karne, YarÄ±ÅŸ Kurulumu, Galop vb.) */
        .modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.95); 
            z-index: 99999; 
            justify-content: center; 
            align-items: center; 
        }
        .modal-content { 
            background: #2c3e50; 
            border: 2px solid #ecf0f1; 
            width: 90%; 
            max-width: 800px; 
            max-height: 90%; 
            overflow: auto; 
            padding: 30px; 
            box-shadow: 0 0 30px #000; 
            position: relative; 
            border-radius: 8px; 
            display:flex; 
            flex-direction: column;
        }
        .close-btn { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            background: #c0392b; 
            color: white; 
            border: none; 
            padding: 8px 12px; 
            cursor: pointer; 
            font-weight: bold; 
            border-radius: 4px; 
            font-size: 14px; 
            z-index: 1001; 
        }
        .close-btn:hover { background: #e74c3c; }

        /* 2. AÃ‡IK ARTIRMA MODALI (auctionModal) */
        .modal-auction { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.95); 
            z-index: 100000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }

        /* --- YENÄ° KART TASARIMI (AHIR/PAZAR/ANTRENMAN) --- */
        .stable-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px;
            padding: 10px;
        }

        .horse-card-new {
            background: linear-gradient(145deg, #1a252f, #2c3e50); 
            border: 2px solid #34495e;
            border-radius: 12px;
            padding: 15px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .horse-card-new:hover {
            transform: translateY(-5px); 
            border-color: #f1c40f; 
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .horse-name-title {
            font-size: 16px;
            font-weight: bold;
            color: #ecf0f1;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-body-flex {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        .big-horse-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            background: rgba(0,0,0,0.3);
            border-radius: 50%; 
            border: 2px solid #7f8c8d;
        }

        .stat-lines {
            flex-grow: 1;
            font-size: 12px;
            color: #F39C12; 
        }
        
        /* KART Ä°Ã‡Ä° DETAY GÃ–RÃœNÃœRLÃœÄÃœ */
        .stat-lines small { 
            color: #F1C40F !important; 
            font-weight: bold;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            gap: 5px;
            margin-top: auto;
        }

        .edit-btn-style {
            background: none; 
            border: none; 
            cursor: pointer; 
            font-size: 18px; 
            padding: 0;
            transition: transform 0.2s;
        }
        
        /* --- NEON HABER BANDI STÄ°LLERÄ° --- */
        .ticker-wrap {
            grid-column: 1 / -1; 
            background-color: #000;
            overflow: hidden;
            height: 30px;
            border-top: 2px solid #333;
            border-bottom: 2px solid #333;
            position: relative;
            box-shadow: 0 0 10px #0f0; 
            grid-row: 2 / 3; 
        }

        .ticker {
            display: inline-block;
            height: 30px;
            line-height: 30px;
            white-space: nowrap;
            padding-right: 100%;
            box-sizing: content-box;
            animation: ticker 30s linear infinite; 
        }

        .ticker-item {
            display: inline-block;
            padding: 0 2rem;
            font-size: 16px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            color: #39ff14; 
            text-shadow: 0 0 5px #39ff14, 0 0 10px #39ff14; 
        }

        @keyframes ticker {
            0% { transform: translate3d(100%, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }
/* --- TESÄ°S KARTLARI --- */
.facility-card {
    background: linear-gradient(145deg, #2c3e50, #000);
    border: 2px solid #95a5a6;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    transition: transform 0.2s;
}
.facility-card:hover {
    border-color: #f1c40f;
    transform: translateX(5px);
}
.facility-info h3 { margin: 0 0 5px 0; color: #f1c40f; font-size: 16px; }
.facility-info p { margin: 0; color: #bdc3c7; font-size: 12px; }
.facility-level {
    background: #e67e22; color: #fff; padding: 2px 8px; 
    border-radius: 4px; font-weight: bold; font-size: 11px; margin-left: 10px;
}
/* --- YENÄ° PROFESYONEL JOKEY KARTLARI --- */
.jockey-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 15px;
    padding: 10px;
}

.jockey-card-pro {
    background: linear-gradient(135deg, #1a252f 0%, #000 100%);
    border: 1px solid #444;
    border-left: 5px solid #bdc3c7; /* VarsayÄ±lan Gri */
    border-radius: 8px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    transition: transform 0.2s;
    position: relative;
}

.jockey-card-pro:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.7);
}

/* Efsane Jokeyler Ä°Ã§in AltÄ±n Ã‡erÃ§eve */
.jockey-card-pro.legend {
    border: 2px solid #f1c40f;
    border-left: 5px solid #f1c40f;
    box-shadow: 0 0 15px rgba(241, 196, 15, 0.2);
}

.jockey-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #333;
    padding-bottom: 8px;
    margin-bottom: 10px;
}

.jockey-name {
    font-size: 16px;
    font-weight: bold;
    color: #ecf0f1;
}

.jockey-type {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 10px;
    font-weight: bold;
    text-transform: uppercase;
}
.type-usta { background: #27ae60; color: white; }
.type-efsane { background: #f1c40f; color: black; box-shadow: 0 0 10px #f1c40f; }
.type-apranti { background: #7f8c8d; color: white; }

.skill-bar-container {
    background: #333;
    height: 6px;
    border-radius: 3px;
    margin-top: 5px;
    overflow: hidden;
}
.skill-bar-fill {
    height: 100%;
    background: #3498db;
}
/* --- GAZETE MODÃœLÃœ STÄ°LLERÄ° --- */
.newspaper-modal {
    background-color: #f4e4bc; /* Saman kaÄŸÄ±dÄ± rengi */
    background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
    color: #2c3e50;
    font-family: 'Times New Roman', Times, serif; /* Gazete fontu */
    padding: 20px;
    border: 1px solid #d3c4a0;
    box-shadow: 0 0 50px rgba(0,0,0,0.8);
    max-width: 700px;
    width: 90%;
    margin: auto;
    position: relative;
    border-radius: 2px;
}

.newspaper-header {
    border-bottom: 3px double #000;
    text-align: center;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.newspaper-name {
    font-size: 42px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin: 0;
    color: #000;
    text-shadow: 1px 1px 0px #aaa;
}

.newspaper-meta {
    font-size: 12px;
    font-style: italic;
    border-top: 1px solid #000;
    border-bottom: 1px solid #000;
    padding: 5px;
    margin-top: 5px;
    display: flex;
    justify-content: space-between;
}

.headline {
    font-size: 32px;
    line-height: 1.1;
    font-weight: bold;
    text-align: center;
    margin: 20px 0;
    color: #1a1a1a;
}

.main-article {
    display: flex;
    gap: 15px;
    border-bottom: 2px solid #000;
    padding-bottom: 15px;
    margin-bottom: 15px;
}

.article-text {
    font-size: 16px;
    text-align: justify;
    line-height: 1.4;
}

.side-news {
    background: rgba(0,0,0,0.05);
    padding: 10px;
    font-size: 13px;
    border: 1px solid #aaa;
}

.continue-btn {
    background: #000;
    color: #fff;
    border: none;
    padding: 10px 20px;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    margin-top: 10px;
    transition: all 0.2s;
}
.continue-btn:hover {
    background: #c0392b;
    transform: scale(1.02);
}    
/* --- ÅAMPÄ°YONLUK EKRANI VE KONFETÄ° STÄ°LLERÄ° --- */
.champion-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 200000;
    display: none; justify-content: center; align-items: center; flex-direction: column;
}

.champion-card {
    background: linear-gradient(135deg, #f1c40f 0%, #d35400 100%);
    padding: 5px; border-radius: 20px;
    box-shadow: 0 0 50px #f1c40f;
    animation: popIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.champion-inner {
    background: #000; padding: 40px; border-radius: 15px; text-align: center;
    border: 2px solid #f39c12;
}

.champ-title {
    font-size: 40px; color: #f1c40f; margin: 0; text-transform: uppercase;
    text-shadow: 0 0 20px #f1c40f; letter-spacing: 2px;
    animation: glowText 1s infinite alternate;
}

.champ-horse-name {
    font-size: 32px; color: #fff; margin: 20px 0; font-weight: bold;
}

.champ-prize {
    font-size: 24px; color: #2ecc71; font-weight: bold; background: #222;
    padding: 10px 20px; border-radius: 50px; display: inline-block;
}

/* Konfeti ParÃ§acÄ±klarÄ± */
.confetti {
    position: absolute; width: 10px; height: 10px; background-color: #f00;
    animation: fall linear forwards;
}

@keyframes popIn {
    0% { transform: scale(0) rotate(-20deg); opacity: 0; }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
}

@keyframes glowText {
    from { text-shadow: 0 0 10px #f1c40f; transform: scale(1); }
    to { text-shadow: 0 0 30px #f1c40f, 0 0 10px #fff; transform: scale(1.05); }
}

@keyframes fall {
    to { transform: translateY(100vh) rotate(720deg); }
}
/* --- GANYAN BAYÄ°Ä° STÄ°LLERÄ° --- */
.ganyan-ticket {
    background: #fff; color: #000; font-family: 'Courier New', monospace;
    padding: 20px; border-radius: 5px; border-top: 10px solid #e74c3c;
    box-shadow: 0 0 20px #000; max-width: 900px; margin: 0 auto;
}
.ganyan-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
    margin-top: 15px;
}
.ganyan-leg {
    background: #eee; padding: 10px; border: 1px solid #999;
}
.ganyan-leg h4 { margin: 0 0 5px 0; border-bottom: 1px dashed #000; }
.ganyan-select { width: 100%; padding: 5px; font-weight: bold; }
.jackpot-display {
    background: #000; color: #f1c40f; font-size: 24px; text-align: center;
    padding: 10px; margin-bottom: 10px; border: 2px solid #fff;
    text-shadow: 0 0 10px #f1c40f; animation: pulse 1.5s infinite;
}
.result-check { font-size: 20px; float: right; }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
/* --- [YENÄ°] V33 ELÄ°T MÃœZAYEDE TASARIMI (NEON GOLD) --- */

/* 1. MÃ¼zayede Ana Kutusu (Ferah ve ÅÄ±k) */
.auction-container {
    background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%); /* Derin Siyah Zemin */
    border: 3px solid #f1c40f; /* AltÄ±n Ã‡erÃ§eve */
    box-shadow: 0 0 50px rgba(241, 196, 15, 0.3); /* AltÄ±n Parlama */
    border-radius: 20px;
    padding: 30px;
    width: 90%;
    max-width: 900px;
    color: #fff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    position: relative;
    overflow: hidden;
}

/* 2. BaÅŸlÄ±k (YanÄ±p SÃ¶nen Neon) */
.auction-container h1 {
    color: #f1c40f;
    text-align: center;
    font-size: 32px;
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 3px;
    text-shadow: 0 0 10px #f1c40f, 0 0 20px #d35400;
    animation: neonPulse 1.5s infinite alternate;
}

@keyframes neonPulse {
    from { text-shadow: 0 0 10px #f1c40f, 0 0 20px #f1c40f; }
    to { text-shadow: 0 0 20px #f1c40f, 0 0 40px #ff00de; }
}

/* 3. AtÄ±n KartÄ± (Ortada Dev Gibi) */
.auction-horse-card {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 30px;
    background: rgba(255, 255, 255, 0.05); /* YarÄ± Saydam */
    border: 1px solid #444;
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 20px;
    backdrop-filter: blur(5px);
}

.auction-horse-img {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    border: 4px solid #f1c40f;
    box-shadow: 0 0 20px #f1c40f;
    object-fit: contain;
    background: #000;
}

.auction-horse-info h3 {
    font-size: 28px;
    margin: 0 0 10px 0;
    color: #fff;
}

.stat-pill {
    background: #333;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 14px;
    margin-right: 5px;
    border: 1px solid #555;
    color: #f1c40f;
    font-weight: bold;
}

/* 4. Teklif AlanÄ± (Fiyatlar Dev Gibi) */
.bid-area {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    background: #111;
    padding: 20px;
    border-radius: 15px;
    border: 1px dashed #f1c40f;
    margin-bottom: 20px;
}

.bid-info-box {
    text-align: center;
}

.bid-label {
    font-size: 14px;
    color: #888;
    display: block;
    margin-bottom: 5px;
}

.bid-value {
    font-size: 36px;
    font-weight: bold;
    color: #2ecc71; /* Para YeÅŸili */
    font-family: 'Courier New', monospace;
}

.bid-leader {
    font-size: 18px;
    color: #e74c3c;
    font-weight: bold;
    margin-top: 5px;
}

/* 5. Kontrol Paneli (Input ve Butonlar) */
.bid-controls {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.bid-input {
    flex: 1;
    padding: 15px;
    font-size: 20px;
    background: #000;
    border: 2px solid #555;
    color: #fff;
    border-radius: 8px;
    text-align: center;
}

.bid-btn {
    flex: 1;
    background: linear-gradient(to bottom, #f1c40f, #d35400);
    border: none;
    color: #000;
    font-weight: bold;
    font-size: 18px;
    cursor: pointer;
    border-radius: 8px;
    transition: transform 0.1s;
    box-shadow: 0 5px 15px rgba(241, 196, 15, 0.4);
}

.bid-btn:active {
    transform: scale(0.95);
}

/* 6. Log Kutusu (Matrix TarzÄ±) */
#log {
    height: 150px;
    overflow-y: auto;
    background: #000;
    border: 1px solid #333;
    padding: 10px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    color: #0f0; /* Matrix YeÅŸili */
    border-radius: 8px;
    box-shadow: inset 0 0 10px #000;
}

/* Scrollbar TasarÄ±mÄ± */
#log::-webkit-scrollbar { width: 8px; }
#log::-webkit-scrollbar-track { background: #000; }
#log::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
/* --- [YENÄ°] V33 MODERN AHIR KARTLARI (NEON & METALÄ°K) --- */

.stable-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* Daha geniÅŸ kartlar */
    gap: 25px;
    padding: 20px;
}

.modern-horse-card {
    /* KartÄ±n Zemini: Siyah deÄŸil, Koyu Metalik Gri/Lacivert */
    background: linear-gradient(145deg, #2c3e50, #1a252f); 
    border: 2px solid #444; /* VarsayÄ±lan Ã§erÃ§eve */
    border-radius: 15px;
    padding: 15px;
    position: relative;
    box-shadow: 0 10px 20px rgba(0,0,0,0.5); /* Derinlik gÃ¶lgesi */
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* YumuÅŸak animasyon */
    overflow: hidden;
}

/* Ãœzerine gelince at Ã¶ne Ã§Ä±ksÄ±n */
.modern-horse-card:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 15px 30px rgba(0,0,0,0.7);
    border-color: #fff; /* Ã‡erÃ§eve parlasÄ±n */
    z-index: 10;
}

/* Elit Atlar iÃ§in AltÄ±n Ã‡erÃ§eve */
.modern-horse-card.elite {
    border: 2px solid #f1c40f;
    box-shadow: 0 0 15px rgba(241, 196, 15, 0.1);
}
.modern-horse-card.elite:hover {
    box-shadow: 0 0 30px rgba(241, 196, 15, 0.4);
}

/* BaÅŸlÄ±k AlanÄ± */
.m-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.m-horse-name {
    font-size: 18px;
    font-weight: bold;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Orta KÄ±sÄ±m (Resim ve Statlar) */
.m-card-body {
    display: flex;
    gap: 15px;
    align-items: center;
}

.m-horse-img {
    width: 90px;
    height: 90px;
    border-radius: 10px;
    border: 2px solid rgba(255,255,255,0.2);
    background: #000;
    object-fit: contain;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}

.m-stat-box {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

/* Ä°lerleme BarlarÄ± (Daha ÅŸÄ±k) */
.m-progress-bg {
    background: rgba(0,0,0,0.5);
    height: 6px;
    border-radius: 3px;
    width: 100%;
    overflow: hidden;
}
.m-progress-fill {
    height: 100%;
    border-radius: 3px;
    box-shadow: 0 0 5px currentColor; /* BarÄ±n renginde parlama */
}

/* Alt Butonlar */
.m-card-footer {
    display: flex;
    gap: 8px;
    margin-top: 15px;
}

.m-btn {
    flex: 1;
    padding: 8px;
    font-size: 11px;
    font-weight: bold;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-transform: uppercase;
    color: #fff;
    transition: filter 0.2s;
}
.m-btn:hover { filter: brightness(1.2); }

.m-tag {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 10px;
    font-weight: bold;
    background: #333;
    color: #aaa;
}
/* --- PEDÄ°GRÄ° (SOY AÄACI) TASARIMI --- */
.pedigree-modal-content {
    background: #1a1a1a;
    width: 95%;
    max-width: 1000px; /* GeniÅŸ ekran */
    border: 2px solid #f1c40f;
    border-radius: 15px;
    padding: 20px;
    position: relative;
    box-shadow: 0 0 50px rgba(0,0,0,0.8);
}

.pedigree-tree {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    margin-top: 20px;
    overflow-x: auto; /* Telefondan taÅŸarsa kaydÄ±r */
    padding-bottom: 20px;
}

/* SÃ¼tunlar (KuÅŸaklar) */
.gen-col {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    gap: 10px;
    flex: 1;
}

/* Ä°sim KutularÄ± */
.ped-box {
    background: linear-gradient(to bottom, #333, #222);
    border: 1px solid #555;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    position: relative;
    min-width: 120px;
    transition: all 0.3s;
}

.ped-box:hover {
    border-color: #f1c40f;
    background: #444;
    transform: scale(1.05);
}

.ped-role { font-size: 10px; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
.ped-name { font-size: 14px; font-weight: bold; color: #fff; margin: 3px 0; }
.ped-stat { font-size: 10px; color: #f1c40f; }

/* BaÄŸlantÄ± Ã‡izgileri */
.ped-box::after {
    content: '';
    position: absolute;
    right: -20px;
    top: 50%;
    width: 20px;
    height: 1px;
    background: #666;
    z-index: -1;
}
.gen-col:last-child .ped-box::after { display: none; } /* En saÄŸdakilerin Ã§izgisi olmasÄ±n */

/* DiÅŸi ve Erkek Renkleri */
.sire-box { border-left: 3px solid #3498db; } /* Erkek tarafÄ± mavi */
.dam-box { border-left: 3px solid #e74c3c; } /* DiÅŸi tarafÄ± kÄ±rmÄ±zÄ± */
</style>
</head>
<body>

    <div class="game-container">
        <header class="header">
            <div class="stat-box">KASA: $<span id="moneyDisplay">50000</span></div>
            <div class="stat-box">YIL: <span id="yearDisplay" style="color:#f1c40f">1</span> | HAFTA: <span id="weekDisplay">1</span>/48</div>
            <div class="stat-box" style="color:#f1c40f">AHIR: <span id="stableCount">0</span>/30</div>
            <button class="next-btn" onclick="checkWeekReport()">HAFTAYI BÄ°TÄ°R >></button> 
        </header>

        <div class="ticker-wrap">
            <div class="ticker" id="neonTicker">
                <div class="ticker-item">ğŸ‡ HORSE MANAGER SIM - HOÅGELDÄ°NÄ°Z!</div>
            </div>
        </div>

        <aside class="sidebar">
            <div class="menu-category">YÃ–NETÄ°M</div>
            <button class="menu-btn" onclick="showFinanceCenter()" style="color:#2ecc71;">ğŸ¦ FÄ°NANS MERKEZÄ°</button>
            <button class="menu-btn" onclick="showStable()">ğŸ AhÄ±rÄ±m (AtlarÄ±m)</button>
            <button class="menu-btn" onclick="showBreeding()">ğŸ§¬ Hara (AÅŸÄ±m)</button>
            <button class="menu-btn" onclick="showMarket()">ğŸ”„ Transfer PazarÄ±</button>
            <button class="menu-btn" onclick="showFacilities()">ğŸ—ï¸ Tesisler</button>
            <button class="menu-btn" onclick="showStaff()">ğŸ¤µ Personel</button>
            <div class="menu-category">TESÄ°SLER</div>
            <button class="menu-btn" onclick="showHippodromeTycoon()" style="color:#00ffff; border-right: 3px solid #00ffff;">ğŸŸï¸ HÄ°PODROMUM (Tycoon)</button>
            <button class="menu-btn" onclick="showTraining()">ğŸ‹ï¸ Antrenman SahasÄ±</button>
            <div class="menu-category">YARIÅ</div>
            <button class="menu-btn" onclick="showRaceCenter()">ğŸ YarÄ±ÅŸ BÃ¼lteni</button>
            <button class="menu-btn" onclick="showScoutingCenter()">ğŸ” Rakip Haralar (Scouting)</button> 
            <button class="menu-btn" onclick="showJockeys()">ğŸ‡ Jokey Listesi</button>
            <button class="menu-btn" onclick="showLeaderboard()">ğŸ† Liderlik Tablosu</button>
            <button class="menu-btn" onclick="showMuseum()" style="color:#ffd700; border-right: 3px solid #ffd700;">ğŸ›ï¸ Efsaneler MÃ¼zesi</button>
            <div class="menu-category">SÄ°STEM</div>
            <button class="menu-btn" onclick="openAuctionModal()">ğŸ’° AÃ‡IK ARTIRMA</button>
            <button class="menu-btn" onclick="showAdminPanel()" style="color:#e74c3c; border-left:4px solid #e74c3c;">âš™ï¸ ADMIN PANELÄ°</button>
 <button class="menu-btn" id="musicBtn" onclick="toggleMusic()">ğŸµ MÃ¼zik: KAPALI</button>
	    <button class="menu-btn" onclick="openGanyanModal()" style="color:#f39c12; border-left:4px solid #f39c12;">ğŸ« GANYAN BAYÄ°Ä° (6'LI)</button>
            <button class="menu-btn" style="background:#2980b9; color:white; font-size:12px;" onclick="downloadSaveFile()">ğŸ’¾ Oyunu Kaydet (Ä°ndir)</button>
            <input type="file" id="uploadInput" style="display:none" onchange="uploadSaveFile(this)">
            <button class="menu-btn" style="background:#8e44ad; color:white; font-size:12px;" onclick="document.getElementById('uploadInput').click()">ğŸ“‚ Oyunu YÃ¼kle</button>
            <button class="menu-btn" style="background:#c0392b; color:white; font-size:12px;" onclick="resetGame()">ğŸ—‘ï¸ SÄ±fÄ±rla</button>
        </aside>

        <main class="main-view" id="mainDisplay">
            </main>

        <footer class="footer">
            <span id="autoSaveMsg" class="save-info">Oyun otomatik kaydediliyor...</span>
        </footer>
    </div>
    
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-content" id="modalBody"></div>
    </div>
    
    <div id="auctionModal" class="modal-auction" style="display:none;">
        <div class="auction-container">
            <h1>ğŸ† VAKIF HARASI BÃœYÃœK AÃ‡IK ARTIRMASI ğŸ†</h1>
            <div id="auctionTimerDisplay" style="text-align:center; font-size:32px; color:#f1c40f; margin-bottom:20px; font-weight:bold; text-shadow: 0 0 5px #f1c40f;">3. VURUÅ Ä°Ã‡Ä°N GERÄ° SAYIM: 3</div>

            <div id="horseDisplay"></div>

            <div class="image-upload-area">
                <label for="imageUpload">
                    <span class="upload-label">RESÄ°M YÃœKLE:</span>
                    <input type="file" id="imageUpload" accept="image/*">
                </label>
                <button class="bid-btn" onclick="applyUploadedImage()" id="applyImageBtn">GÃ–RSELÄ° UYGULA</button>
            </div>
            <div class="bid-area">
                <div class="bid-info">
                    <span>BAÅLANGIÃ‡ FÄ°YATI: $<span id="minBidDisplay">0</span></span>
                    <span>HARANIZIN KASASI: $<span id="playerMoney">100000</span></span>
                </div>
                <div class="bid-info">
                    <span style="color:#f1c40f">MEVCUT TEKLÄ°F: $<span id="currentBid">0</span></span>
                    <span id="leadingBidder">--</span>
                </div>

                <div class="bid-controls">
                    <input type="number" id="playerBidInput" class="bid-input" placeholder="Min. Teklif">
                    <button id="bidButton" class="bid-btn" onclick="placePlayerBid()">TEKLÄ°F VER</button>
                </div>
                <button class="bid-btn" style="background:#00ffff; color: #000" onclick="skipAuction()">PAS GEÃ‡ / DEVAM ET</button>
            </div>

            <div id="log"></div>

            <div id="result" class="result-message" style="display:none;">
                <button class="bid-btn" style="background:#00ffff; color: #000; margin-top: 15px;" onclick="closeAuctionModal()">KAPAT VE DEVAM ET</button>
            </div>
        </div>
    </div>

    <audio id="bgMusic" loop>
        <source src="sound/horse.mp3" type="audio/mpeg">
        TarayÄ±cÄ±nÄ±z ses elementini desteklemiyor.
    </audio>
    
    
<script>
// --- SES AYARLARI ---
const sesNal = new Audio('horse.mp3'); 
sesNal.loop = true;  // YarÄ±ÅŸ bitene kadar dÃ¶ngÃ¼ye girsin
sesNal.volume = 0.7; // Ses seviyesi (0.0 ile 1.0 arasÄ±)
const JOKEY_TRAINING_COST = {
    'TempolamaDersi': { cost: 5000, weeks: 4, skill: 5, target: 'paceControl' },
    'SprintAntr': { cost: 10000, weeks: 8, skill: 8, target: 'sprintFinish' },
    'KÄ±rbaÃ§UstalÄ±ÄŸÄ±': { cost: 20000, weeks: 12, skill: 12, target: 'whipUsage' }
};
// === EKONOMÄ° MOTORU (DÃœZELTÄ°LMÄ°Å HALÄ°) ===
const Economy = {
    money: 50000000,

    set(amount) {
        this.money = Number(amount);
        if (isNaN(this.money)) this.money = 0;
        updateUI();
    },

    add(amount) {
        let val = Number(amount);
        if (!isNaN(val)) {
            this.money += val;
        }
        updateUI();
    },

    spend(amount) {
        let val = Number(amount);
        if (isNaN(val)) return false;
        
        if (this.money < val) {
            alert("Yetersiz bakiye!");
            return false;
        }
        this.money -= val;
        updateUI();
        return true;
    }
};

// GLOBAL YARDIMCI FONKSÄ°YONLAR (Kodun geri kalanÄ± bunlarÄ± kullanÄ±yor)
function addMoney(amount) {
    Economy.add(amount);
}

function spendMoney(amount) {
    return Economy.spend(amount);
}

    // --- SABÄ°TLER ---
    const HOME_CITY = 'Ä°stanbul';
    const TRANSPORT_COST = 1500;
    const SEASON_LENGTH = 48;
    const TRAINER_SALARY = 5000;
    const MANAGER_SALARY = 2500; 
    const WEATHER_TYPES = ['GÃ¼neÅŸli', 'YaÄŸmurlu', 'Ã‡amurlu'];
    const MAX_HIRED_JOCKEYS = 3; 
    const NUM_RACES_PER_WEEK = 8;
    const JOKEY_BASE_SALARY = 10000;
    const JOKEY_COMMISSION = { 'Usta': 0.10, 'Apranti': 0.05, 'Emekli': 0.08 };
    // --- YENÄ° EKLENEN SAKATLIK TÄ°PLERÄ° ---
const INJURY_TYPES = [
    { id: 'muscle', name: 'Hafif Kas SertleÅŸmesi', severity: 1, min: 1, max: 2, cost: 1000, desc: 'Dinlenirse geÃ§er.' },
    { id: 'hoof', name: 'TÄ±rnak Ã‡atlaÄŸÄ±', severity: 2, min: 3, max: 5, cost: 3000, desc: 'Nalbant mÃ¼dahalesi ÅŸart.' },
    { id: 'joint', name: 'Eklem Ä°ltihabÄ±', severity: 2, min: 4, max: 6, cost: 5000, desc: 'AÄŸrÄ±lÄ± sÃ¼reÃ§.' },
    { id: 'tendon', name: 'Tendon ZorlanmasÄ±', severity: 3, min: 8, max: 12, cost: 15000, desc: 'Ciddi sakatlÄ±k.' },
    { id: 'fracture', name: 'KEMÄ°K KIRIÄI', severity: 4, min: 52, max: 100, cost: 0, desc: 'Kariyer biter.' }
];

function applyInjury(horse) {
    let roll = Math.random() * 100;
    let injury;
    if (roll < 60) injury = INJURY_TYPES[0];
    else if (roll < 85) injury = INJURY_TYPES[1];
    else if (roll < 95) injury = INJURY_TYPES[2];
    else if (roll < 99) injury = INJURY_TYPES[3];
    else injury = INJURY_TYPES[4];

    let duration = rand(injury.min, injury.max);
    let clinicBonus = facilities.clinic ? facilities.clinic.level * 0.10 : 0;
    duration = Math.ceil(duration * (1 - clinicBonus));

    horse.isInjured = true;
    horse.injuryData = { name: injury.name, weeks: duration, severity: injury.severity, cost: injury.cost };
    horse.injuryWeeks = duration;
    return injury;
}
// --- YENÄ° EKLENEN DEV YARIÅ LÄ°STELERÄ° ---

    // 1. DÃœNYA DEVLERÄ° VE Ã–ZEL KUPALAR (Haftalara SabitlenmiÅŸ)
    const WORLD_RACE_CALENDAR = {
        4:  { name: "ğŸ‡ºğŸ‡¸ PEGASUS WORLD CUP", city: "Miami", dist: 1800, surface: "Kum", prize: 3000000, minRating: 90, grade: "G1" },
        8:  { name: "ğŸ‡¸ğŸ‡¦ THE SAUDI CUP", city: "Riyad", dist: 1800, surface: "Kum", prize: 20000000, minRating: 95, grade: "G1" },
        10: { name: "ğŸ‡¦ğŸ‡ª DUBAI SHEEMA CLASSIC", city: "Dubai", dist: 2400, surface: "Ã‡im", prize: 6000000, minRating: 95, grade: "G1" },
        12: { name: "ğŸ‡¦ğŸ‡ª DUBAI WORLD CUP", city: "Dubai", dist: 2000, surface: "Kum", prize: 12000000, minRating: 100, grade: "G1 (Elite)" },
        15: { name: "ğŸ‡¯ğŸ‡µ OSAKA HAI", city: "Osaka", dist: 2000, surface: "Ã‡im", prize: 2000000, minRating: 90, grade: "G1" },
        18: { name: "ğŸ‡ºğŸ‡¸ KENTUCKY DERBY", city: "Louisville", dist: 2000, surface: "Kum", prize: 3000000, minRating: 85, ageLimit: 3, grade: "G1" },
        20: { name: "ğŸ‡ºğŸ‡¸ PREAKNESS STAKES", city: "Baltimore", dist: 1900, surface: "Kum", prize: 1500000, minRating: 85, ageLimit: 3, grade: "G1" },
        22: { name: "ğŸ‡¬ğŸ‡§ EPSOM DERBY", city: "Londra", dist: 2400, surface: "Ã‡im", prize: 2000000, minRating: 90, ageLimit: 3, grade: "G1" },
        24: { name: "ğŸ‡¬ğŸ‡§ ROYAL ASCOT GOLD CUP", city: "Ascot", dist: 4000, surface: "Ã‡im", prize: 1000000, minRating: 90, grade: "G1" },
        26: { name: "ğŸ‡¹ğŸ‡· 99. GAZÄ° KOÅUSU", city: "Ä°stanbul", dist: 2400, surface: "Ã‡im", prize: 10000000, minRating: 80, ageLimit: 3, grade: "G1 (TR)" },
        28: { name: "ğŸ‡«ğŸ‡· GRAND PRIX DE PARIS", city: "Paris", dist: 2400, surface: "Ã‡im", prize: 800000, minRating: 85, grade: "G1" },
        30: { name: "ğŸ‡¬ğŸ‡§ KING GEORGE VI", city: "Ascot", dist: 2400, surface: "Ã‡im", prize: 1500000, minRating: 95, grade: "G1" },
        32: { name: "ğŸ‡ºğŸ‡¸ ARLINGTON MILLION", city: "Chicago", dist: 2000, surface: "Ã‡im", prize: 1000000, minRating: 90, grade: "G1" },
        34: { name: "ğŸ‡©ğŸ‡ª DEUTSCHES DERBY", city: "Hamburg", dist: 2400, surface: "Ã‡im", prize: 800000, minRating: 85, grade: "G1" },
        36: { name: "ğŸ‡®ğŸ‡ª IRISH CHAMPION STAKES", city: "Dublin", dist: 2000, surface: "Ã‡im", prize: 1200000, minRating: 90, grade: "G1" },
        40: { name: "ğŸ‡«ğŸ‡· PRIX DE L'ARC DE TRIOMPHE", city: "Paris", dist: 2400, surface: "Ã‡im", prize: 5000000, minRating: 100, grade: "G1 (Elite)" },
        42: { name: "ğŸ‡¦ğŸ‡º CAULFIELD CUP", city: "Melbourne", dist: 2400, surface: "Ã‡im", prize: 3000000, minRating: 90, grade: "G1" },
        44: { name: "ğŸ‡¦ğŸ‡º MELBOURNE CUP", city: "Melbourne", dist: 3200, surface: "Ã‡im", prize: 5000000, minRating: 90, grade: "G1" },
        45: { name: "ğŸ‡ºğŸ‡¸ BREEDERS' CUP CLASSIC", city: "New York", dist: 2000, surface: "Kum", prize: 6000000, minRating: 100, grade: "G1 (Elite)" },
        46: { name: "ğŸ‡¯ğŸ‡µ JAPAN CUP", city: "Tokyo", dist: 2400, surface: "Ã‡im", prize: 4000000, minRating: 95, grade: "G1" },
        48: { name: "ğŸ‡­ğŸ‡° HONG KONG VASE", city: "Hong Kong", dist: 2400, surface: "Ã‡im", prize: 2500000, minRating: 95, grade: "G1" }
    };

    // 2. YEREL VE STANDART KUPA Ä°SÄ°MLERÄ°
    const LOCAL_CUP_NAMES = [
        "Vali KupasÄ±", "Belediye BaÅŸkanlÄ±ÄŸÄ±", "Emniyet MÃ¼dÃ¼rlÃ¼ÄŸÃ¼", "Jokey KulÃ¼bÃ¼", 
        "Sonbahar BÃ¼yÃ¼k HandikapÄ±", "Yaz HandikapÄ±", "Ã‡aldÄ±ran", "Sakarya", 
        "Ä°nÃ¶nÃ¼", "Fatih Sultan Mehmet", "Yavuz Sultan Selim", "Kanuni", 
        "Ankara Kalesi", "Ä°zmir Kordon", "Adana Portakal Ã‡iÃ§eÄŸi", "Bosphorus", 
        "HaliÃ§", "KÄ±z Kulesi", "Galata", "DolmabahÃ§e", "Ã‡Ä±raÄŸan"
    ];
    // --- OYUN VERÄ°LERÄ° ---
    let money = 50000000;
    let year = 1; 
    let week = 1;
    let myHorses = [];
    let marketHorses = [];
    let activeRaces = []; 
    let allJockeys = [];
    let activeRace = null; 
    let activeBets = []; 
    let hiredTrainer = false; 
    let hiredManager = false; 
    let weeklyLogs = []; 
    let hiredJockeys = []; 
    let allOpponents = [];
    let raceReplays = {};
    let museumHorses = []; // MÃ¼zedeki efsaneler burada saklanacak 
    let scheduledRaces = []; // Gelecek yarÄ±ÅŸlar
// --- FÄ°NANS SÄ°STEMÄ° DEÄÄ°ÅKENLERÄ° ---
    let bankLoan = 0; // Mevcut BorÃ§
    let investments = { gold: 0, forex: 0, stocks: 0 }; // Sahip olunan miktarlar
    let marketRates = { gold: 2000, forex: 30, stocks: 5000 }; // GÃ¼ncel piyasa fiyatlarÄ±
    let stableSponsor = { name: null, weeklyIncome: 0, weeksLeft: 0 }; // Ana Sponsor
    let creditScore = 1000; // Kredi Notu (BorÃ§ Ã¶dedikÃ§e artar)
    
    // HÄ°PODROM VERÄ°LERÄ° (VarsayÄ±lan)
    let myHippodrome = { 
        name: "VakÄ±f Park", 
        level: 1, 
        capacity: 1000, 
        ticketPrice: 50, 
        restaurantLevel: 0, 
        popularity: 10, 
        weeklyIncome: 0
    };

    // MINIGAME & SPIKER DEÄÄ°ÅKENLERÄ°
    let gallopInterval;
    let gallopProgress = 0;
    let gallopHorse = null;
    let gallopScore = 0;
    let whipCooldown = false;
    let commentaryInterval;

    const TRAITS = [
        { id: 'cimci', name: 'ğŸŒ¿ Ã‡imci', desc: 'Ã‡im pistte performans artar.', type: 'pos' },
        { id: 'kumcu', name: 'ğŸœï¸ Kumcu', desc: 'Kum pistte performans artar.', type: 'pos' },
        { id: 'sprinter', name: 'âš¡ Sprinter', desc: '1200-1400m mesafede uÃ§ar.', type: 'pos' },
        { id: 'maraton', name: 'ğŸ”ï¸ Maratoncu', desc: '2000m ve Ã¼zeri yorulmaz.', type: 'pos' },
        { id: 'hirsli', name: 'ğŸ˜¡ HÄ±rslÄ±', desc: 'Her yarÄ±ÅŸta +5 Puan ekstrasÄ± var.', type: 'pos' },
        { id: 'dengesiz', name: 'ğŸ’¢ Dengesiz', desc: 'PerformansÄ± Ã§ok dalgalÄ± olur.', type: 'neg' }
    ];

    let facilities = {
        clinic: { level: 1, name: "Veteriner KliniÄŸi", desc: "SakatlÄ±klarÄ±n iyileÅŸmesini hÄ±zlandÄ±rÄ±r.", cost: 10000, max: 5 },
        transport: { level: 1, name: "LÃ¼ks Nakliye", desc: "YarÄ±ÅŸa giderken yorgunluÄŸu azaltÄ±r.", cost: 15000, max: 5 },
        training: { level: 1, name: "YÃ¼ksek Ä°rtifa Merkezi", desc: "Antrenman verimliliÄŸini artÄ±rÄ±r.", cost: 20000, max: 5 },
        stud: { level: 1, name: "Ã–zel Hara", desc: "YetiÅŸtirilen taylarÄ±n kalitesini artÄ±rÄ±r.", cost: 50000, max: 3 }
    };

    const legendarySires = [
        { name: "Bold Pilot", sprint: 180, stamina: 170, fee: 350000 },
        { name: "Turbo", sprint: 190, stamina: 150, fee: 400000 },
        { name: "Karayel", sprint: 160, stamina: 190, fee: 450000 },
        { name: "Ribella", sprint: 185, stamina: 180, fee: 500000 },
        { name: "Pan River", sprint: 190, stamina: 180, fee: 650000 },
        { name: "Secretariat", sprint: 200, stamina: 200, fee: 2000000 },
        { name: "Frankel", sprint: 195, stamina: 185, fee: 3500000 },
        { name: "Galileo", sprint: 170, stamina: 195, fee: 4000000 },
        { name: "Northern Dancer", sprint: 175, stamina: 180, fee: 5000000 },
        { name: "Sea The Stars", sprint: 198, stamina: 198, fee: 6000000 }
    ];

    const CITIES = ['Ä°stanbul', 'Ankara', 'Ä°zmir', 'Adana'];
    const DISTANCES = [1200, 1600, 2000, 2400];

    function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
    function getColor(val) { return val > 70 ? '#2ecc71' : (val > 30 ? '#f1c40f' : '#e74c3c'); }

    // --- YENÄ° GELÄ°ÅMÄ°Å Ä°SÄ°M MOTURU ---
    const enPrefixes = ["Royal", "Golden", "Dark", "Secret", "Iron", "Velvet", "Midnight", "Wind", "Desert", "Noble", "Blue", "Red", "Storm", "Magic", "Shadow", "Brave", "Flying", "Grand", "Crazy", "Wild", "Ocean", "Silent", "Ghost", "King's", "Bold", "Swift", "Mighty", "Eternal", "Epic", "Mystic", "Cyber", "Neon", "Solar", "Lunar", "Arctic", "Crimson", "Azure", "Savage", "Thunder", "Lightning"];
    const enSuffixes = ["Thunder", "Ghost", "Spirit", "Arrow", "Storm", "Heart", "Rose", "Runner", "Chaser", "King", "Warrior", "Legend", "Sky", "Fire", "Dancer", "Hunter", "Eagle", "Bullet", "Boy", "Girl", "Hero", "Strike", "Force", "Dream", "Star", "Bolt", "Flame", "River", "Knight", "Queen", "Prince", "Rebel", "Soul", "Wish", "Glory", "Victory", "Champion", "Master", "Wizard", "Titan"];
    const trPrefixes = ["Anadolu", "Kuzey", "Kara", "Asi", "Deli", "Son", "BÃ¼yÃ¼k", "Åah", "Efsane", "Mavi", "KÄ±zÄ±l", "Demir", "AltÄ±n", "GÃ¼mÃ¼ÅŸ", "Siyah", "Beyaz", "Gece", "Åafak", "FÄ±rtÄ±na", "Poyraz", "Lodos", "Cesur", "HÄ±rÃ§Ä±n", "Sessiz", "VahÅŸi", "Zalim", "Kral", "Prens", "Prenses", "Baron", "DÃ¼k", "Kont", "Åampiyon", "Zafer", "Umut", "Hayal", "GerÃ§ek", "Ezel", "Ebed", "Yaman", "Ã‡Ä±lgÄ±n", "BozkÄ±r", "Deniz", "Okyanus", "DaÄŸ", "Kaya", "AteÅŸ", "Su", "Toprak", "Hava", "YÄ±ldÄ±z", "GÃ¼neÅŸ", "Ay"];
    const trSuffixes = ["RÃ¼zgarÄ±", "FÄ±rtÄ±nasÄ±", "ÅimÅŸeÄŸi", "YÄ±ldÄ±zÄ±", "GÃ¼neÅŸi", "KartalÄ±", "AslanÄ±", "KaplanÄ±", "Kurdu", "Åahini", "DoÄŸanÄ±", "Beyi", "SultanÄ±", "KÄ±zÄ±", "OÄŸlu", "Efsanesi", "DestanÄ±", "GÃ¼cÃ¼", "AteÅŸi", "Alevi", "IÅŸÄ±ÄŸÄ±", "GÃ¶lgesi", "Ruhu", "Hayali", "Umudu", "Zaferi", "Darbesi", "YumruÄŸu", "PenÃ§esi", "KanadÄ±", "Yelesi", "NalÄ±", "KoÅŸusu", "DansÄ±", "BakÄ±ÅŸÄ±", "Sesi", "Nefesi", "Ã–fkesi", "Ä°ntikamÄ±", "Adaleti", "Cesareti", "Onuru", "Gururu"];
    const singleNames = ["Poyraz", "Karayel", "Lodos", "BozkÄ±r", "ÅimÅŸek", "FÄ±rtÄ±na", "Barut", "Gaddar", "Zalim", "Cesur", "Yaman", "Duman", "Bulut", "YaÄŸmur", "Toprak", "Kaya", "Pars", "Panter", "Ceylan", "Kartal", "Åahin", "DoÄŸan", "Atmaca", "HanÃ§er", "KÄ±lÄ±Ã§", "Kalkan", "ZÄ±rh", "MÄ±zrak", "Ok", "Yay", "Hedef", "Zirve", "Doruk", "Efsane", "Destan", "Masal", "Ã–ykÃ¼", "Åiir", "Roman", "Sanat", "Resim", "MÃ¼zik", "Nota", "Beste", "GÃ¼fte", "ÅarkÄ±", "TÃ¼rkÃ¼", "AÄŸÄ±t", "Destan", "KaÅŸif", "Reis", "Kaptan", "Pilot", "Jokey", "Start", "Finish", "Sprint", "Tempo", "Vurgun", "Balyoz", "Ã‡ekiÃ§", "Ã–rs", "KÄ±vÄ±lcÄ±m", "Alev", "Kor", "KÃ¼l", "Duman", "Sis", "Boran", "Ayaz", "Zemheri", "Nevruz", "Bahar", "Yaz", "GÃ¼z", "KÄ±ÅŸ"];

    const raceNames = ["Cumhuriyet", "Anavatan", "Ã‡anakkale", "Anadolu", "Saroz", "Trakya", "Lozan", "Truva", "Mars", "Artemis", "Apollo", "Osmangazi", "Sakarya", "DumlupÄ±nar", "Malazgirt", "Ä°stiklal", "Marmara", "FÄ±rat"];
    const raceSuffixes = ["KupasÄ±", "KoÅŸusu", "Derby", "Memorial", "Sprint", "Challenge", "Stakes"];
    const jockeySampleNames = ["Alaric Storm","Kael Brighthoof","Dorian Windrider","Corvin Quickstride","Elio Longcaster","Rowan Derbyheart","Magnus Trackman","Niko Spurtking","Arin Milestoner","Cedric Tempoer","Baran Pilotaj","Tarvos Stratus","Diego Vivaldi","Leon Favori","Short Åerif","Diego Calabria","Marathon AktÃ¼r","Rising Eraykan","Sprinter Emika","Distance Oracle","Jumping Furkan","Uzuncu BorsacÄ±","KÄ±sacÄ± Rengar","Oracle Miles","Veyron Ladin","Emir Saroz Reis","Sel Kader","Taha Turbodin","Can Rolling","YÄ±ldÄ±zer Go","Hand of Strategy","Whipmaster Zey","Spurt Queen Mira","Glory Pacer","Tempo Lord Kai","Strategy Ace Orion","Lightfoot Jero","Wind Dash Efe","Quick Whip Ali","Spurt Kadir","Pace Bishop Torg","Lucky Rider Cato","Sprint Paladin Rho","Distance Khan Tor","Pist Wizard Ediz","Tempo Monk Sadi","Jump Hammer Aras","Pace Engine Eren","Whip Caster Nato","Track Sage Lio"];
    
    function generateHorseName() {
        let strategy = Math.random();
        if (strategy < 0.35) return pick(trPrefixes) + " " + pick(trSuffixes);
        else if (strategy < 0.65) return pick(enPrefixes) + " " + pick(enSuffixes);
        else if (strategy < 0.90) return pick(singleNames);
        else return pick(trPrefixes) + " " + pick(enSuffixes);
    }
    function generateRaceName() { return pick(raceNames) + " " + pick(raceSuffixes); }
    function getHorseColorStyle() { return pick(['brightness(0.2)', 'sepia(1) saturate(5) brightness(0.5)', 'sepia(1) saturate(7) hue-rotate(-50deg) brightness(0.6)', 'grayscale(1) brightness(0.6)', 'brightness(0.95)']); }
    function generateRandomParentName(gender) {
        if(gender === 'AygÄ±r' && Math.random() > 0.7) return pick(legendarySires).name;
        return generateHorseName();
    }

    // --- YENÄ°LENMÄ°Å VE GERÃ‡EKÃ‡Ä° JOKEY SÄ°STEMÄ° ---
function generateJockeys() {
    allJockeys = [];
    
    // 1. GERÃ‡EK EFSANELER (Bunlar artÄ±k oyunda var!)
    const legends = [
        { name: "Halis KarataÅŸ", skill: 98, age: 48, type: "Efsane" },
        { name: "Selim Kaya", skill: 95, age: 44, type: "Efsane" },
        { name: "Ahmet Ã‡elik", skill: 94, age: 34, type: "Efsane" },
        { name: "GÃ¶khan Kocakaya", skill: 92, age: 33, type: "Efsane" },
        { name: "Ã–zcan YÄ±ldÄ±rÄ±m", skill: 90, age: 35, type: "Usta" }
    ];

    // Efsaneleri ekle
    legends.forEach((l, i) => {
        allJockeys.push({
            id: 1000 + i, // Ã–zel ID
            name: l.name,
            age: l.age,
            skill: l.skill,
            baseSkill: l.skill,
            paceControl: l.skill - rand(0, 5),
            sprintFinish: l.skill,
            whipUsage: l.skill - rand(0, 5),
            rainSkill: 100, // Efsaneler yaÄŸmur Ã§amur dinlemez
            type: l.type,
            fee: l.skill * 200, // PahalÄ±dÄ±rlar
            isContracted: false,
            contractWeeks: 0,
            trainingWeeks: 0,
            trainingTarget: 0,
            trainingTargetKey: null,
            sponsor: "TÃ¼rkiye Jokey KulÃ¼bÃ¼"
        });
    });

    // 2. RASTGELE JOKEYLER (Apranti ve Ustalar)
    for(let i=0; i<40; i++) {
        let name = pick(jockeySampleNames) + " " + rand(100, 999);
        let age = rand(17, 38);
        let skillBase = rand(45, 85); // Normal jokeyler
        
        let type = "Apranti";
        if(skillBase > 75) type = "Usta";
        if(age > 35 && skillBase < 60) type = "Emekli";

        allJockeys.push({ 
            id: i, 
            name: name, 
            age: age, 
            skill: skillBase, 
            baseSkill: skillBase, 
            paceControl: rand(skillBase * 0.8, skillBase * 1.1), 
            sprintFinish: rand(skillBase * 0.8, skillBase * 1.1), 
            whipUsage: rand(skillBase * 0.8, skillBase * 1.1), 
            rainSkill: rand(50, 90), 
            type: type, 
            fee: skillBase * 10, 
            isContracted: false, 
            contractWeeks: 0, 
            trainingWeeks: 0, 
            trainingTarget: 0, 
            trainingTargetKey: null, 
            sponsor: null 
        });
    }
    
    // Listeyi yeteneÄŸe gÃ¶re sÄ±rala ki efsaneler Ã¼stte Ã§Ä±ksÄ±n
    allJockeys.sort((a,b) => b.skill - a.skill);
}

    function createHorse(isElite = false, isOpponent = false) {
        let base = isElite ? 110 : 50;
        let sprint = rand(base, isElite ? 180 : 130);
        let stamina = rand(base, isElite ? 180 : 130);
        let maxPot = isElite ? rand(170, 210) : rand(130, 180);
        let maxSprint = sprint + rand(10, maxPot - sprint);
        let maxStamina = stamina + rand(10, maxPot - stamina);
        let trait = Math.random() > 0.5 ? pick(TRAITS) : null;
        let horse = {
            id: Date.now() + Math.random(), name: generateHorseName(), age: rand(2, 3), gender: Math.random() > 0.5 ? "AygÄ±r" : "KÄ±srak",
            sprint: sprint, stamina: stamina, maxSprint: maxSprint, maxStamina: maxStamina, surface: Math.random() > 0.5 ? "Ã‡im" : "Kum",
            price: (sprint + stamina) * 20 * (isElite ? 4 : 1), isElite: isElite, condition: 100, history: [], colorFilter: getHorseColorStyle(),
            rating: rand(40, 60), trait: trait, isInjured: false, injuryWeeks: 0, sireName: generateRandomParentName('AygÄ±r'), damName: generateRandomParentName('KÄ±srak')
        };
        if (isOpponent) {
            horse.trainer = pick(["Ahmet T.", "BÃ¼lent K.", "Cemil D.", "Zeynep S."]);
            horse.stable = pick(["HÄ±zlÄ± Taylar", "Anadolu AtÃ§Ä±lÄ±k", "Efsane HarasÄ±"]);
            horse.rating = rand(60, 100); 
        }
        return horse;
    }
// --- MEVCUT createHorse FONKSÄ°YONUNUN BÄ°TTÄ°ÄÄ° YERÄ°N ALTINA BUNU EKLE ---

// --- Ã–ZEL ELÄ°T MÃœZAYEDE ATI ÃœRETÄ°CÄ°SÄ° (FERRARÄ°LER BURADA) ---
// --- Ã–ZEL ELÄ°T MÃœZAYEDE ATI ÃœRETÄ°CÄ°SÄ° (VÄ°DEO ENTEGRELÄ°) ---
// --- BU FONKSÄ°YONU ESKÄ°SÄ°YLE DEÄÄ°ÅTÄ°R ---
function createAuctionMonster() {
    const elitePrefixes = ["Royal", "Imperial", "Grand", "Crown", "Majestic", "Supreme", "Eternal", "Golden"];
    const eliteSuffixes = ["Emperor", "Sultan", "King", "Legend", "Pegasus", "Titan", "Phantom", "Dragon"];
    let name = pick(elitePrefixes) + " " + pick(eliteSuffixes);

    // GÃ¼Ã§ AyarlarÄ±
    let bestPlayerSprint = myHorses.length > 0 ? Math.max(...myHorses.map(h => h.sprint)) : 180;
    let sprint = Math.floor(rand(bestPlayerSprint, bestPlayerSprint * 1.15)); 
    let stamina = Math.floor(rand(bestPlayerSprint, bestPlayerSprint * 1.15));
    let maxSprint = sprint + rand(20, 50);
    let maxStamina = stamina + rand(20, 50);

    // --- Ä°ÅTE EKSÄ°K OLAN KISIM BURASIYDI ---
    const auctionStyles = [
        { filter: 'sepia(1) saturate(5) brightness(1.2) hue-rotate(10deg)', video: 'at_doru.mp4' },
        { filter: 'invert(1) hue-rotate(180deg)', video: 'at_kir.mp4' },
        { filter: 'grayscale(100%) brightness(1.5) contrast(1.2)', video: 'at_kir.mp4' },
        { filter: 'hue-rotate(250deg) saturate(3) brightness(0.7)', video: 'at_yagiz.mp4' }
    ];

    let selectedStyle = pick(auctionStyles);

    return {
        id: Date.now() + Math.random(),
        name: name,
        age: 2, 
        gender: Math.random() > 0.5 ? "AygÄ±r" : "KÄ±srak",
        sprint: sprint,
        stamina: stamina,
        maxSprint: maxSprint,
        maxStamina: maxStamina,
        surface: Math.random() > 0.5 ? "Ã‡im" : "Kum",
        price: Math.floor((sprint + stamina) * 50000), 
        isElite: true,
        condition: 100,
        history: [],
        colorFilter: selectedStyle.filter,    
        auctionVideo: selectedStyle.video,    // <-- KRÄ°TÄ°K SATIR BU!
        rating: rand(110, 130), 
        trait: { id: 'hirsli', name: 'ğŸ˜¡ HÄ±rslÄ±', desc: 'Kazanmak iÃ§in doÄŸmuÅŸ.', type: 'pos' },
        isInjured: false,
        injuryWeeks: 0,
        sireName: "Efsane " + pick(["Bold Pilot", "Secretariat", "Frankel"]),
        damName: "Lady " + pick(["Diana", "Victoria", "Elizabeth"])
    };
}
    function generateOpponents() {
        allOpponents = [];
        const bossStables = [
            { name: "Godolphin ğŸ”µ", bonus: 30, color: "hue-rotate(220deg) brightness(0.9)" }, 
            { name: "Coolmore ğŸŸ£", bonus: 25, color: "hue-rotate(270deg) brightness(1.1)" }, 
            { name: "Juddmonte ğŸŸ¢", bonus: 20, color: "hue-rotate(100deg) brightness(0.9)" }, 
            { name: "Shadwell ğŸŸ¡", bonus: 18, color: "hue-rotate(50deg) brightness(1.4)" },   
            { name: "AÄŸa Han HarasÄ± ğŸ”´", bonus: 15, color: "hue-rotate(0deg) brightness(0.8)" } 
        ];

        bossStables.forEach(stable => {
            for(let i=0; i<4; i++) {
                let horse = createHorse(true, true); 
                horse.name = stable.name.split(" ")[0] + " " + pick(["Storm", "Thunder", "King", "Legend", "Strike", "Warrior", "Ghost", "Empire"]);
                horse.stable = stable.name; 
                horse.sprint += stable.bonus;
                horse.stamina += stable.bonus;
                horse.maxSprint += stable.bonus + 10;
                horse.maxStamina += stable.bonus + 10;
                horse.rating = Math.min(120, rand(90, 115)); 
                horse.colorFilter = stable.color;
                allOpponents.push(horse);
            }
        });

        for (let i = 0; i < 35; i++) {
            let isElite = Math.random() > 0.95; 
            let opp = createHorse(isElite, true);
            opp.stable = pick(["Anadolu AtÃ§Ä±lÄ±k", "Efsane HarasÄ±", "RÃ¼zgar Ã‡iftliÄŸi", "Kara ÅimÅŸek EkÃ¼risi", "GÃ¼neÅŸ HarasÄ±"]);
            allOpponents.push(opp);
        }
        shuffle(allOpponents);
    }

   function generateWeeklyRaces() {
        activeRaces = []; // Listeyi temizle

        // 1. PLANLANMIÅ Ã–ZEL YARIÅLARI EKLE (Tycoon'dan gelenler)
        let todaysSpecials = scheduledRaces.filter(s => s.runWeek === week);
        todaysSpecials.forEach(s => {
            activeRaces.push(s.race);
        });
        // Eklenenleri plan listesinden dÃ¼ÅŸ
        scheduledRaces = scheduledRaces.filter(s => s.runWeek !== week);

        let raceCount = 12; // Toplam 12 yarÄ±ÅŸlÄ±k slot var

        // 2. DÃœNYA DEVÄ° YARIÅI VAR MI? (Varsa 1 slotu yer)
        if (WORLD_RACE_CALENDAR[week]) {
            let special = WORLD_RACE_CALENDAR[week];
            let infoText = `ğŸ† DÃœNYA DEVÄ°!\nÃ–dÃ¼l: $${special.prize.toLocaleString()}\nZorluk: ELÄ°T SEVÄ°YE\nÅehir: ${special.city}`;
            
            activeRaces.push({
                id: 'race_special_' + week,
                name: special.name,
                category: special.grade,
                dist: special.dist,
                surface: special.surface,
                city: special.city,
                prize: special.prize,
                minRating: special.minRating,
                maxRating: 9999,
                weather: Math.random() > 0.8 ? (Math.random()>0.5?'YaÄŸmurlu':'Ã‡amurlu') : 'GÃ¼neÅŸli', 
                ageLimit: special.ageLimit || null,
                tooltip: infoText,
                isGazi: special.name.includes("GAZÄ°"),
                registeredUserHorses: []
            });
            raceCount--; 
        }

        // 3. KALAN SLOTLARI DOLDUR (Maiden, Handikap, KV, Grup)
        for(let i=0; i<raceCount; i++) {
            let roll = Math.random();
            let r = { id: 'race_' + Date.now() + '_' + i, city: pick(CITIES), weather: pick(WEATHER_TYPES), registeredUserHorses: [] };
            
            // A) MAIDEN
            if (roll < 0.20) {
                r.name = "Maiden KoÅŸusu"; r.category = "Maiden"; r.prize = 30000; r.minRating = 0; r.maxRating = 45; r.winCountLimit = 0; r.ageLimit = Math.random() > 0.5 ? 2 : 3; r.tooltip = "Åart: HenÃ¼z yarÄ±ÅŸ kazanmamÄ±ÅŸ atlar.";
            } 
            // B) HANDÄ°KAP
            else if (roll < 0.60) {
                let hType = rand(14, 17);
                r.category = `Handikap ${hType}`;
                if(hType === 14) { r.prize = 45000; r.minRating = 0; r.maxRating = 55; }
                else if(hType === 15) { r.prize = 60000; r.minRating = 20; r.maxRating = 70; }
                else if(hType === 16) { r.prize = 85000; r.minRating = 40; r.maxRating = 90; }
                else { r.prize = 120000; r.minRating = 60; r.maxRating = 110; }
                r.name = `${pick(CITIES)} ${pick(["Sonbahar", "KÄ±ÅŸ", "Ä°lkbahar", "Yaz"])} HandikapÄ±`;
                r.tooltip = `Denge: PuanÄ± ${r.minRating}-${r.maxRating} arasÄ± olan atlar.`;
            }
            // C) KV (KISA VADE)
            else if (roll < 0.80) {
                let kvType = rand(6, 9);
                r.category = `KV-${kvType}`;
                r.prize = kvType * 25000;
                r.minRating = 50 + (kvType * 2);
                r.maxRating = 9999;
                r.name = pick(LOCAL_CUP_NAMES);
                if(Math.random() > 0.7) r.name += " KupasÄ±";
                r.tooltip = "Åart: YÃ¼ksek puanlÄ± atlar iÃ§in kÄ±sa vade yarÄ±ÅŸÄ±.";
            }
            // D) CÄ°NSÄ°YET
            else if (roll < 0.90) {
                let isMare = Math.random() > 0.5;
                r.gender = isMare ? "KÄ±srak" : "AygÄ±r";
                r.category = isMare ? "DiÅŸi Tay Deneme" : "Erkek Tay Deneme";
                r.name = isMare ? "KÄ±sraklar KoÅŸusu" : "AygÄ±rlar MÃ¼cadelesi";
                r.prize = 90000;
                r.minRating = 40;
                r.maxRating = 100;
                r.tooltip = `Åart: Sadece ${r.gender} atlar katÄ±labilir.`;
            }
            // E) GRUP (G2, G3)
            else {
                let gType = Math.random() > 0.7 ? "G2" : "G3";
                r.category = gType;
                r.name = "BÃ¼yÃ¼k " + pick(CITIES) + " KoÅŸusu";
                r.prize = gType === "G2" ? 300000 : 180000;
                r.minRating = gType === "G2" ? 90 : 80;
                r.maxRating = 9999;
                r.tooltip = "Prestij: Ãœst dÃ¼zey safkanlarÄ±n mÃ¼cadelesi.";
            }

            r.dist = pick([1200, 1400, 1600, 1900, 2100, 2400]);
            if (r.dist <= 1200 && (r.category.includes("KV") || r.category.includes("G"))) r.name += " Sprint";
            r.surface = Math.random() > 0.5 ? 'Ã‡im' : 'Kum';
            if(!r.tooltip.includes("Ã–dÃ¼l")) r.tooltip += `\nÃ–dÃ¼l: $${r.prize.toLocaleString()}\nMesafe: ${r.dist}m ${r.surface}`;

            activeRaces.push(r);
        }
    }

    // --- SAVE / LOAD & DOSYA SÄ°STEMÄ° ---
    function saveGame() {
        let replayKeys = Object.keys(raceReplays);
        if(replayKeys.length > 20) { let keysToRemove = replayKeys.slice(0, replayKeys.length - 20); keysToRemove.forEach(k => delete raceReplays[k]); }
        const saveData = { money, week, year, myHorses, facilities, activeRaces, allJockeys, hiredTrainer, hiredManager, hiredJockeys, allOpponents, raceReplays, museumHorses, myHippodrome, scheduledRaces, bankLoan, investments, marketRates, stableSponsor, creditScore, };
        localStorage.setItem('horseManagerSave', JSON.stringify(saveData));
        document.getElementById('autoSaveMsg').innerText = "KayÄ±t edildi: " + new Date().toLocaleTimeString();
    }
    function loadGame() { const saved = localStorage.getItem('horseManagerSave'); if(saved) return processLoadData(saved); return false; }
    function processLoadData(jsonString) {
        try {
            const data = JSON.parse(jsonString);
           if(data.bankLoan !== undefined) bankLoan = data.bankLoan;
           if(data.investments) investments = data.investments;
           if(data.marketRates) marketRates = data.marketRates;
           if(data.stableSponsor) stableSponsor = data.stableSponsor;
           if(data.creditScore) creditScore = data.creditScore;
            money = data.money || 50000; week = data.week || 1; year = data.year || 1;
            myHorses = data.myHorses || []; activeRaces = data.activeRaces || [];
            hiredTrainer = data.hiredTrainer || false; hiredManager = data.hiredManager || false; hiredJockeys = data.hiredJockeys || []; allOpponents = data.allOpponents || []; 
            if(data.facilities) facilities = data.facilities; if(data.raceReplays) raceReplays = data.raceReplays;
            if(data.museumHorses) museumHorses = data.museumHorses; else museumHorses = [];
            if(data.myHippodrome) myHippodrome = data.myHippodrome;
            if(data.scheduledRaces) scheduledRaces = data.scheduledRaces; else scheduledRaces = []; 
            if(data.allJockeys && data.allJockeys.length > 0) {
                allJockeys = data.allJockeys;
                allJockeys.forEach(j => {
                    if (j.paceControl === undefined) j.paceControl = j.skill;
                    if (j.sprintFinish === undefined) j.sprintFinish = j.skill;
                    if (j.whipUsage === undefined) j.whipUsage = j.skill;
                    if (j.rainSkill === undefined) j.rainSkill = 80; 
                    if (j.trainingTargetKey === undefined) j.trainingTargetKey = null;
                });
            } else { generateJockeys(); }
            myHorses.forEach(h => { 
                if(!h.history) h.history = []; if(!h.colorFilter) h.colorFilter = getHorseColorStyle(); if(h.rating === undefined) h.rating = 40;
                if(h.trait === undefined) h.trait = Math.random() > 0.7 ? pick(TRAITS) : null;
                if(h.isInjured === undefined) { h.isInjured = false; h.injuryWeeks = 0; }
                if(h.maxSprint === undefined) h.maxSprint = h.sprint + rand(10, 50); if(h.maxStamina === undefined) h.maxStamina = h.stamina + rand(10, 50); 
                if(!h.sireName) h.sireName = generateRandomParentName('AygÄ±r'); if(!h.damName) h.damName = generateRandomParentName('KÄ±srak');
            });
            if (allOpponents.length < 50) generateOpponents();
            return true;
        } catch(e) { console.error("Save dosyasÄ± bozuk", e); return false; }
    }
    
    window.downloadSaveFile = function() {
        saveGame();
        const saveData = { money, week, year, myHorses, facilities, activeRaces, allJockeys, hiredTrainer, hiredManager, hiredJockeys, allOpponents, raceReplays };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(saveData));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "at_yarisi_kayit_yil" + year + "_hafta" + week + ".json");
        document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove();
    }
    window.uploadSaveFile = function(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) { if(processLoadData(e.target.result)) { alert("Oyun baÅŸarÄ±yla yÃ¼klendi!"); saveGame(); updateUI(); showStable(); } else alert("HatalÄ± dosya!"); };
            reader.readAsText(input.files[0]);
        }
    }
    function resetGame() { if(confirm("TÃ¼m ilerlemen silinecek! Emin misin?")) { localStorage.removeItem('horseManagerSave'); location.reload(); } }
    function updateUI() {
    // Economy nesnesinden gÃ¼ncel parayÄ± al
    const currentMoney = Economy.money;
    
    // UI Elementlerini gÃ¼ncelle
    const moneyEl = document.getElementById("moneyDisplay");
    if (moneyEl) {
        moneyEl.innerText = Math.floor(currentMoney).toLocaleString();
    }

    const yearEl = document.getElementById("yearDisplay");
    if (yearEl) yearEl.innerText = year;

    const weekEl = document.getElementById("weekDisplay");
    if (weekEl) weekEl.innerText = week;

    const stableEl = document.getElementById("stableCount");
    if (stableEl) stableEl.innerText = myHorses.length;
    
    // Global deÄŸiÅŸkeni de senkronize et (Eski kodlar bozulmasÄ±n diye)
    money = currentMoney; 

    saveGame();
}

    
    function toggleMusic() {
        const music = document.getElementById("bgMusic");
        const btn = document.getElementById("musicBtn");
        music.volume = 0.3; 

        if (music.paused) {
            music.play().then(() => {
                btn.innerHTML = "ğŸµ MÃ¼zik: AÃ‡IK";
                btn.style.borderRightColor = "#2ecc71"; 
                btn.style.color = "#f1c40f"; 
            }).catch(error => {
                console.log("Ses hatasÄ±:", error);
                alert("MÃ¼zik Ã§alabilmek iÃ§in sayfada herhangi bir yere tÄ±klamÄ±ÅŸ olmanÄ±z gerekiyor (TarayÄ±cÄ± politikasÄ±).");
            });
        } else {
            music.pause();
            btn.innerHTML = "ğŸµ MÃ¼zik: KAPALI";
            btn.style.borderRightColor = "#7f8c8d";
            btn.style.color = "#ecf0f1"; 
        }
    }

    // --- AHIR KARTLARI (YAÅ DÃœZELTÄ°LMÄ°Å VERSÄ°YON) ---
window.showStable = function() {
    let html = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #444; padding-bottom:10px;">
            <div>
                <h2 style="color:#f1c40f; margin:0; text-shadow:0 0 10px rgba(241,196,15,0.5);">ğŸ VAKIF HARASI (${myHorses.length}/30)</h2>
                <small style="color:#aaa;">AtlarÄ±nÄ±zÄ±n durumunu buradan yÃ¶netin.</small>
            </div>
            <div style="background:#222; padding:5px 15px; border-radius:20px; border:1px solid #555;">
                Ortalama GÃ¼Ã§: <span style="color:#2ecc71; font-weight:bold;">${Math.floor(myHorses.reduce((a,b)=>a+(b.rating||0),0)/(myHorses.length||1))} HP</span>
            </div>
        </div>
        <div class="stable-grid">`;

    if (myHorses.length === 0) {
        html += `<div style="grid-column: 1/-1; text-align:center; padding:50px; color:#777; border:2px dashed #444; border-radius:20px;">
            <h1 style="font-size:50px;">ğŸ•¸ï¸</h1>
            <h3>AhÄ±r BomboÅŸ!</h3>
            <p>Transfer pazarÄ±ndan veya mÃ¼zayededen at satÄ±n alÄ±n.</p>
        </div>`;
    }

    myHorses.forEach(h => {
        // SakatlÄ±k Durumu (GeliÅŸmiÅŸ GÃ¶sterim)
        let injuryName = h.injuryData ? h.injuryData.name : 'SakatlÄ±k';
        let statusTag = h.isInjured 
            ? `<span class="m-tag" style="background:#c0392b; color:#fff;">ğŸš‘ ${injuryName} (${h.injuryWeeks}h)</span>` 
            : `<span class="m-tag" style="background:#27ae60; color:#fff;">SAÄLAM</span>`;

        // Ã–zellik (Trait) GÃ¶sterimi
        let traitHtml = h.trait 
            ? `<span class="m-tag" style="background:${h.trait.type==='pos'?'#16a085':'#d35400'}; color:#fff;">â˜… ${h.trait.name}</span>` 
            : `<span class="m-tag">-</span>`;

        let cardClass = h.isElite ? 'modern-horse-card elite' : 'modern-horse-card';
        let nameColor = h.isElite ? '#f1c40f' : '#fff';
        let starIcon = h.isElite ? 'ğŸ‘‘ ' : '';

        // Aksiyon ButonlarÄ± (Sakat ise sadece tedavi Ã§Ä±kar)
        let buttons = '';
        if (h.isInjured) {
            buttons = `<button class="m-btn" style="background:#e74c3c; width:100%;" onclick="healHorse('${h.id}')">ğŸš‘ TEDAVÄ° ET ($${(h.injuryData?.cost || 2000).toLocaleString()})</button>`;
        } else {
            buttons = `
                <button class="m-btn" style="background:#3498db;" onclick="showHorseCard('${h.id}')">ğŸ“„ KARNE</button>
                <button class="m-btn" style="background:#9b59b6;" onclick="openPlayerAuction('${h.id}')">ğŸ”¨ SAT</button>
                <button class="m-btn" style="background:#34495e;" onclick="retireHorse('${h.id}')">ğŸ›ï¸ EMEKLÄ°</button>
            `;
        }

        html += `
        <div class="${cardClass}">
            
            <div class="m-card-header">
                <div>
                    <div class="m-horse-name" style="color:${nameColor}">${starIcon}${h.name}</div>
                    <small style="color:#aaa;">${Math.floor(h.age)} YaÅŸ | ${h.gender}</small>
                </div>
                <button class="edit-btn-style" onclick="editHorse('${h.id}')" title="DÃ¼zenle">âœï¸</button>
            </div>

            <div class="m-card-body">
                <img src="resimler/at.gif" class="m-horse-img" style="filter:${h.colorFilter || 'none'}; border-color:${nameColor}">
                
                <div class="m-stat-box">
                    ${statusTag}
                    
                    <div style="font-size:11px; color:#aaa; margin-top:5px; display:flex; justify-content:space-between;">
                        <span>HIZ</span> <span style="color:#fff">${h.sprint.toFixed(0)}</span>
                    </div>
                    <div class="m-progress-bg"><div class="m-progress-fill" style="width:${(h.sprint/h.maxSprint)*100}%; background:#3498db;"></div></div>
                    
                    <div style="font-size:11px; color:#aaa; margin-top:3px; display:flex; justify-content:space-between;">
                        <span>GÃœÃ‡</span> <span style="color:#fff">${h.stamina.toFixed(0)}</span>
                    </div>
                    <div class="m-progress-bg"><div class="m-progress-fill" style="width:${(h.stamina/h.maxStamina)*100}%; background:#e67e22;"></div></div>
                    
                    <div style="margin-top:5px;">${traitHtml}</div>
                </div>
            </div>

            <div class="m-card-footer">
                ${buttons}
            </div>
            
            <div style="height:3px; background:#333; margin-top:10px; border-radius:2px; overflow:hidden;">
                <div style="height:100%; width:${h.condition}%; background:${getColor(h.condition)}; box-shadow:0 0 5px ${getColor(h.condition)};"></div>
            </div>
        </div>`;
    });

    html += `</div>`; 
    document.getElementById("mainDisplay").innerHTML = html;
}

    window.healHorse = function(horseId) {
        let h = myHorses.find(x => x.id == horseId);
        if (!h || !h.isInjured) return;
        if (!h.injuryData) h.injuryData = { name: 'Bilinmeyen SakatlÄ±k', cost: 2000, severity: 2 };

        if (h.injuryData.severity === 4) return alert(`${h.name} kemik kÄ±rÄ±ÄŸÄ± yaÅŸadÄ±. Tedavisi yok, emekli edilmeli.`);

        let clinicLvl = facilities.clinic ? facilities.clinic.level : 0;
        let successChance = 50 + (clinicLvl * 10); 
        let cost = h.injuryData.cost;

        if (money < cost) return alert(`Tedavi masrafÄ± ($${cost.toLocaleString()}) yetersiz!`);
        if (!confirm(`${h.name} tedavisi: ${h.injuryData.name}\nÃœcret: $${cost}\nÅans: %${successChance}\nOnaylÄ±yor musun?`)) return;

        spendMoney(cost);

        if (Math.random() * 100 < successChance) {
            let reduction = Math.ceil(h.injuryWeeks / 2);
            h.injuryWeeks -= reduction;
            if (h.injuryWeeks <= 0) {
                h.isInjured = false; h.injuryData = null;
                alert(`âœ… MUCÄ°ZE! ${h.name} tamamen iyileÅŸti!`);
            } else {
                alert(`âœ… Tedavi iyi gitti. SÃ¼re ${reduction} hafta kÄ±saldÄ±.`);
            }
        } else {
            alert(`âŒ Tedavi iÅŸe yaramadÄ±. Veteriner kliniÄŸini geliÅŸtir.`);
        }
        updateUI(); showStable();
    }

    window.sellHorse = function(horseId, price) {
        if(!confirm(`Bu atÄ± $${price.toLocaleString()} karÅŸÄ±lÄ±ÄŸÄ±nda satmak istediÄŸine emin misin?`)) return;
        let index = myHorses.findIndex(h => h.id == horseId);
        if(index > -1) { myHorses.splice(index, 1); addMoney( price); alert("At satÄ±ldÄ±."); updateUI(); showStable(); }
    }

    // --- SAÄLAMLAÅTIRILMIÅ KARNE FONKSÄ°YONU ---
window.showHorseCard = function(horseId) {
    const h = myHorses.find(x => x.id == horseId);
    if (!h) return;

    // HATA Ã–NLEYÄ°CÄ°: KazancÄ± direkt burada hesaplÄ±yoruz (DÄ±ÅŸarÄ±ya muhtaÃ§ deÄŸil)
    let totalMoney = 0;
    if (h.history && h.history.length > 0) {
        totalMoney = h.history.reduce((total, race) => total + (race.earnings || 0), 0);
    }

    // GeÃ§miÅŸ yarÄ±ÅŸlarÄ± hazÄ±rla
    let historyRows = "";
    if (h.history && h.history.length > 0) {
        historyRows = h.history.slice().reverse().map(r => 
            `<tr>
                <td style="padding:5px;">${r.week}.H</td>
                <td style="color:#fff">${r.raceName}</td>
                <td style="color:#f1c40f;">${r.degree}</td>
                <td><span class="rank-badge rank-${r.rank}">${r.rank}</span></td>
                <td style="color:#2ecc71">$${r.earnings.toLocaleString()}</td>
             </tr>`
        ).join('');
    } else {
        historyRows = '<tr><td colspan="5" style="padding:20px; text-align:center; color:#666;">HenÃ¼z resmi bir yarÄ±ÅŸ koÅŸmadÄ±.</td></tr>';
    }

    // HTML Ä°Ã§eriÄŸi
    let cardHtml = `
        <div style="position:relative;">
            <div style="display:flex; gap:20px; align-items:flex-start;">
                <div style="text-align:center;">
                    <img src="resimler/at.gif" style="width:120px; height:120px; border-radius:15px; border:3px solid #f1c40f; filter:${h.colorFilter}; background:#000;">
                    <div style="margin-top:5px; font-size:11px; color:#aaa; text-transform:uppercase;">${h.gender}</div>
                </div>

                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h2 style="color:#f1c40f; margin:0; font-size:24px;">${h.name.toUpperCase()}</h2>
                        <button onclick="document.getElementById('modalOverlay').style.display='none'" style="background:#e74c3c; border:none; color:white; width:30px; height:30px; border-radius:50%; font-weight:bold; cursor:pointer;">X</button>
                    </div>
                    
                    <div style="color:#aaa; font-size:13px; margin-bottom:15px; margin-top:5px;">
                        Baba: <strong style="color:#fff">${h.sireName || 'Bilinmiyor'}</strong> x Anne: <strong style="color:#fff">${h.damName || 'Bilinmiyor'}</strong>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; background:#1a1a1a; padding:10px; border-radius:10px; border:1px solid #333;">
                         <div>âš¡ HÄ±z: <span style="color:#fff;">${h.sprint.toFixed(1)}</span></div>
                         <div>ğŸ›¡ï¸ GÃ¼Ã§: <span style="color:#fff;">${h.stamina.toFixed(1)}</span></div>
                         <div>ğŸ† KazanÃ§: <span style="color:#2ecc71;">$${totalMoney.toLocaleString()}</span></div>
                         <div>ğŸ“Š Puan: <span style="color:#3498db;">${h.rating}</span></div>
                    </div>
                </div>
            </div>

            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="menu-btn" style="background: linear-gradient(to right, #8e44ad, #9b59b6); flex:1; border:1px solid #8e44ad; padding:10px;" onclick="openPedigree('${h.id}')">ğŸ§¬ SOY AÄACI GÃ–STER</button>
                <button class="menu-btn" style="background:#c0392b; flex:0.5; padding:10px;" onclick="document.getElementById('modalOverlay').style.display='none'">KAPAT</button>
            </div>
            
            <h3 style="margin-top:20px; border-bottom:1px solid #444; padding-bottom:5px; color:#ddd; font-size:14px;">Son YarÄ±ÅŸ Ä°statistikleri</h3>
            <div style="max-height:200px; overflow-y:auto; border:1px solid #333; border-radius:8px; background:#111;">
                <table style="width:100%; font-size:12px; color:#ccc; border-collapse:collapse;">
                    <thead style="background:#222; color:#aaa; position:sticky; top:0;">
                        <tr><th style="padding:8px;">Hfta</th><th>YarÄ±ÅŸ</th><th>Derece</th><th>SÄ±ra</th><th>KazanÃ§</th></tr>
                    </thead>
                    <tbody>
                        ${historyRows}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    document.getElementById("modalBody").innerHTML = cardHtml;
    document.getElementById("modalOverlay").style.display = 'flex';
}

    window.playReplay = function(replayId) {
        let data = raceReplays[replayId]; if(!data) return alert("Bu yarÄ±ÅŸÄ±n kaydÄ± silinmiÅŸ veya bulunamadÄ±.");
        let weatherOverlay = ''; if(data.weather === 'YaÄŸmurlu') weatherOverlay = `<div class="rain-overlay" style="display:block"></div>`; if(data.weather === 'Ã‡amurlu') weatherOverlay = `<div class="mud-overlay" style="display:block"></div>`;
        document.getElementById("modalBody").innerHTML = `<button class="close-btn" onclick="document.getElementById('modalOverlay').style.display='none'">X</button><h3 style="color:#f1c40f; text-align:center">ğŸ“º TEKRAR: ${data.raceName} (${data.dist}m)</h3><div id="track" class="race-track-container" style="display:block;">${weatherOverlay}</div><div style="text-align:center; margin-top:10px; color:#aaa; font-size:12px;">YarÄ±ÅŸ kaydÄ± oynatÄ±lÄ±yor...</div>`;
        document.getElementById("modalOverlay").style.display = "flex";
        let track = document.getElementById("track");
        data.runners.forEach(r => { let textColor = r.isUser ? '#f1c40f' : '#fff'; track.innerHTML += `<div class="lane"><div class="lane-number">${r.lane}</div><div class="horse-container" id="rep_horse_${r.lane}" style="transition: left ${r.duration}s ease-in-out;"><img src="resimler/at.gif" class="horse-gif" style="filter:${r.colorFilter}"><span style="font-size:12px; color:${textColor};">${r.name} ${r.rank===1 ? 'ğŸ‘‘':''}</span></div><div class="finish-line"></div></div>`; });
        setTimeout(() => { data.runners.forEach(r => { let el = document.getElementById(`rep_horse_${r.lane}`); if(el) el.style.left = "85%"; }); }, 100);
    }
    
    window.showBreeding = function() {
        let mares = myHorses.filter(h => h.gender === 'KÄ±srak');
        let stallions = myHorses.filter(h => h.gender === 'AygÄ±r');
        let mareOptions = mares.length > 0 ? mares.map(h => `<option value="${h.id}">${h.name} (H:${h.sprint.toFixed(0)} D:${h.stamina.toFixed(0)})</option>`).join("") : `<option disabled>KÄ±sraÄŸÄ±n yok!</option>`;
        let myStallionOptions = `<optgroup label="--- BENÄ°M AYGIRLARIM (Ãœcretsiz) ---">` + (stallions.length > 0 ? stallions.map(h => `<option value="my_${h.id}">â˜… ${h.name} (H:${h.sprint.toFixed(0)} D:${h.stamina.toFixed(0)})</option>`).join("") : `<option disabled>AygÄ±rÄ±n yok</option>`) + `</optgroup>`;
        let legendaryOptions = `<optgroup label="--- EFSANE AYGIRLAR (Ãœcretli) ---">` + legendarySires.map((s, i) => `<option value="leg_${i}">${s.name} (H:${s.sprint} D:${s.stamina}) - $${s.fee.toLocaleString()}</option>`).join("") + `</optgroup>`;

        let html = `
            <h2 style="color:#e91e63">ğŸ§¬ HARA (Ã‡Ä°FTLEÅTÄ°RME MERKEZÄ°)</h2>
            <div class="breeding-container">
                <div class="parent-box">
                    <h3 style="color:#e84393">ANNE (KÄ±srak)</h3>
                    <select id="damSelect" style="padding:10px; width:100%; background:#000; color:#fff; border:1px solid #e84393;">${mareOptions}</select>
                </div>
                <div class="heart-icon">â¤ï¸</div>
                <div class="parent-box">
                    <h3 style="color:#3498db">BABA (AygÄ±r)</h3>
                    <select id="sireSelect" style="padding:10px; width:100%; background:#000; color:#fff; border:1px solid #3498db;">
                        ${myStallionOptions}
                        ${legendaryOptions}
                    </select>
                </div>
            </div>
            <br>
            <div style="text-align:center;">
                <p style="color:#aaa; font-size:12px;">* Kendi aygÄ±rlarÄ±nÄ±zla Ã§iftleÅŸtirmek tamamen Ã¼cretsizdir.</p>
                <button class="menu-btn" style="background:#e91e63; width:50%; font-size:18px;" onclick="breedHorse()">Ã‡Ä°FTLEÅTÄ°R</button>
            </div>`;
        
        document.getElementById("mainDisplay").innerHTML = html;
    }

    window.breedHorse = function() {
        if(myHorses.length >= 30) return alert("AhÄ±rÄ±n dolu! (Kapasite: 30)");
        let damId = document.getElementById("damSelect").value;
        let dam = myHorses.find(h => h.id == damId);
        if(!dam) return alert("LÃ¼tfen bir kÄ±srak (Anne) seÃ§in.");
        let sireValue = document.getElementById("sireSelect").value;
        let sire = null;
        let cost = 0;
        if(sireValue.startsWith("leg_")) {
            let idx = parseInt(sireValue.split("_")[1]);
            sire = legendarySires[idx];
            cost = sire.fee;
        } else if(sireValue.startsWith("my_")) {
            let sId = sireValue.split("_")[1];
            sire = myHorses.find(h => h.id == sId);
            cost = 0; 
        }

        if(!sire) return alert("LÃ¼tfen bir aygÄ±r (Baba) seÃ§in.");
        if(money < cost) return alert(`Ã‡iftleÅŸme Ã¼creti ($${cost.toLocaleString()}) iÃ§in paranÄ±z yetersiz!`);
        
        spendMoney( cost);
        
        let baseSprint = (dam.sprint + sire.sprint) / 2;
        let baseStamina = (dam.stamina + sire.stamina) / 2;
        
        let finalSprint = Math.floor(baseSprint + rand(-10, 15));
        let finalStamina = Math.floor(baseStamina + rand(-10, 15));
        
        let sMaxSprint = sire.maxSprint || (sire.sprint + 20);
        let sMaxStamina = sire.maxStamina || (sire.stamina + 20);
        
        let potentialBase = (dam.maxSprint + dam.maxStamina + sMaxSprint + sMaxStamina) / 4;
        let maxPot = Math.floor(potentialBase + rand(-15, 25));
        
        let maxSprint = finalSprint + rand(10, Math.max(15, maxPot - finalSprint));
        let maxStamina = finalStamina + rand(10, Math.max(15, maxPot - finalStamina));

        let trait = Math.random() > 0.5 ? pick(TRAITS) : null;
        
        let foal = { 
            id: Date.now()+Math.random(), name: generateHorseName(), age: 2, gender: Math.random()>0.5?"AygÄ±r":"KÄ±srak", 
            sprint: finalSprint, stamina: finalStamina, maxSprint: maxSprint, maxStamina: maxStamina, surface: Math.random()>0.5?"Ã‡im":"Kum", 
            price: 0, isElite: (finalSprint+finalStamina)>300, condition: 100, location: 'Ä°stanbul', history: [], 
            colorFilter: getHorseColorStyle(), rating: 40, trait: trait, isInjured: false, injuryWeeks: 0, sireName: sire.name, damName: dam.name 
        };
        
        myHorses.push(foal); 
        updateUI();
        
        let popupHtml = `
            <button class="close-btn" onclick="document.getElementById('modalOverlay').style.display='none'">X</button>
            <h2 style="color:#e91e63; text-align:center">ğŸ‰ TAY DOÄDU: ${foal.name} ğŸ‰</h2>
            <div class="pedigree-box" style="margin-bottom:20px;">
                <h3>Soy AÄŸacÄ±</h3>
                <p style="color:#3498db">Baba: ${sire.name} ${cost === 0 ? '(Sizin AygÄ±rÄ±nÄ±z)' : ''}</p>
                <p style="color:#e91e63">Anne: ${dam.name}</p>
                <p style="color:#aaa; font-size:12px; margin-top:5px;">Maliyet: $${cost.toLocaleString()}</p>
            </div>
            <div style="text-align:center;">
                <img src="resimler/at.gif" style="filter:${foal.colorFilter}; height:80px;">
                <br>
                <p style="font-size:18px;">âš¡ HÄ±z: ${finalSprint} | ğŸ›¡ï¸ DayanÄ±klÄ±lÄ±k: ${finalStamina}</p>
            </div>`;
        
        document.getElementById("modalBody").innerHTML = popupHtml;
        document.getElementById("modalOverlay").style.display = "flex";
    }

    // --- TRANSFER PAZARI KARTLARI ---
    window.showMarket = function() {
        let html = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="color:#2ecc71; margin:0;">ğŸ”„ TRANSFER PAZARI (VÄ°TRÄ°N)</h2>
                <div style="background:#000; padding:5px 15px; border:1px solid #2ecc71; border-radius:4px;">
                    KasanÄ±z: <span style="color:#2ecc71; font-weight:bold;">$${money.toLocaleString()}</span>
                </div>
            </div>
            <div class="stable-grid">`;

        if (marketHorses.length === 0) {
            html += `<div style="grid-column: 1/-1; text-align:center; padding:40px; color:#aaa; border:2px dashed #444;">
                <h3>Pazar BomboÅŸ! ğŸƒ</h3>
                <p>Åu an satÄ±lÄ±k at kalmadÄ±. HaftayÄ± bitirince yeni atlar gelecektir.</p>
            </div>`;
        }

        marketHorses.forEach((h, index) => {
            let traitHtml = h.trait ? 
                `<span style="color:${h.trait.type==='pos'?'#2ecc71':'#e74c3c'}; font-size:11px;">â˜… ${h.trait.name}</span>` : 
                `<span style="color:#555; font-size:11px;">- Ã–zelliksiz -</span>`;

            let imgFilter = h.colorFilter || 'none';

            html += `
            <div class="horse-card-new" style="border-color:#2ecc71; box-shadow:0 0 8px rgba(46, 204, 113, 0.2);">
                
                <div class="card-header">
                    <div>
                        <div class="horse-name-title" style="color:#2ecc71">${h.name}</div>
                        <small style="color:#aaa;">${h.age}y | ${h.gender} | ${h.surface}</small>
                    </div>
                    <div style="text-align:right;">
                        <div style="color:#fff; font-weight:bold; font-size:14px;">$${h.price.toLocaleString()}</div>
                        <small style="color:#7f8c8d;">DeÄŸer</small>
                    </div>
                </div>

                <div class="card-body-flex">
                    <img src="resimler/at.gif" class="big-horse-img" style="filter:${imgFilter}">
                    <div class="stat-lines">
                        <div>âš¡ HÄ±z: <span style="color:#fff;">${h.sprint.toFixed(0)}</span> <small>/${h.maxSprint}</small></div>
                        <div>ğŸ›¡ï¸ GÃ¼Ã§: <span style="color:#fff;">${h.stamina.toFixed(0)}</span> <small>/${h.maxStamina}</small></div>
                        <div style="margin-top:5px;">${traitHtml}</div>
                        <div style="color:#555; font-size:10px; margin-top:3px;">HP: ${h.rating} (Potansiyel: ???)</div>
                    </div>
                </div>

                <div class="card-footer">
                    <button class="btn-action" style="width:100%; background:#27ae60; padding:12px; font-weight:bold; font-size:14px;" onclick="buyHorse(${index})">
                        SATIN AL ğŸ›’
                    </button>
                </div>
            </div>`;
        });

        html += `</div>`; 
        document.getElementById("mainDisplay").innerHTML = html;
    }

    window.showFacilities = function() { 
    // EÄŸer veritabanÄ±nda henÃ¼z laboratuvar yoksa (eski kayÄ±tlar iÃ§in) ekleyelim
    if(!facilities.laboratory) {
        facilities.blacksmith = { level: 0, name: "Usta Nalbant", desc: "YarÄ±ÅŸlarda sakatlanma riskini azaltÄ±r.", cost: 25000, max: 3 };
        facilities.laboratory = { level: 0, name: "Genetik LaboratuvarÄ±", desc: "Atlara Ã¶zellik (Trait) ekleme ameliyatlarÄ± yapar.", cost: 100000, max: 1 };
    }

    let html = `<h2 style="color:#f1c40f">ğŸ—ï¸ TESÄ°SLER VE GELÄ°ÅTÄ°RMELER</h2>
                <p style="color:#aaa; margin-bottom:20px;">Tesislerini geliÅŸtirerek atlarÄ±nÄ±n performansÄ±nÄ± artÄ±r.</p>`;
    
    Object.keys(facilities).forEach(key => { 
        let f = facilities[key]; 
        let cost = f.cost * (f.level + 1); 
        let isMax = f.level >= f.max;
        
        let actionBtn = '';
        
        // Laboratuvar Ã¶zelse ve satÄ±n alÄ±ndÄ±ysa GÄ°RÄ°Å butonu gÃ¶ster
        if (key === 'laboratory' && f.level > 0) {
            actionBtn = `<button class="btn-action" style="background:#8e44ad; padding:10px;" onclick="openLabModal()">ğŸ§¬ LAB'A GÄ°R</button>`;
        } else if (!isMax) {
            actionBtn = `<button class="btn-action" onclick="upgradeFacility('${key}')">YÃœKSELT ($${cost.toLocaleString()})</button>`;
        } else {
            actionBtn = `<span style="color:#2ecc71; font-weight:bold;">MAX SEVÄ°YE</span>`;
        }

        html += `
        <div class="facility-card">
            <div class="facility-info">
                <div style="display:flex; align-items:center;">
                    <h3>${f.name}</h3>
                    <span class="facility-level">Lv. ${f.level}/${f.max}</span>
                </div>
                <p>${f.desc}</p>
            </div>
            <div>${actionBtn}</div>
        </div>`; 
    }); 
    
    document.getElementById("mainDisplay").innerHTML = html; 
}

    window.upgradeFacility = function(key) { 
        let f = facilities[key]; 
        // Ekranda gÃ¶sterilen fiyat formÃ¼lÃ¼ ile buradaki aynÄ± olmalÄ± (level + 1)
        let cost = f.cost * (f.level + 1); 
        
        // Ã–NEMLÄ° DÃœZELTME: spendMoney kullanÄ±yoruz ki Economy kasasÄ±ndan dÃ¼ÅŸsÃ¼n
        if(spendMoney(cost)) {
            f.level++; 
            alert(f.name + " baÅŸarÄ±yla seviye atladÄ±!"); 
            showFacilities(); 
        }
    }

    window.showStaff = function() {
        let html = `<h2 style="color:#95a5a6">PERSONEL YÃ–NETÄ°MÄ°</h2>`;
        let trainerStatus = hiredTrainer ? `<span style="color:#2ecc71">AKTÄ°F</span>` : `<span style="color:#e74c3c">YOK</span>`;
        let trainerBtn = hiredTrainer ? `<button class="btn-sell" onclick="fireTrainer()">KOV</button>` : `<button class="btn-action" onclick="hireTrainer()">Ä°ÅE AL ($${TRAINER_SALARY.toLocaleString()})</button>`;
        let managerStatus = hiredManager ? `<span style="color:#2ecc71">AKTÄ°F</span>` : `<span style="color:#e74c3c">YOK</span>`;
        let managerBtn = hiredManager ? `<button class="btn-sell" onclick="fireManager()">KOV</button>` : `<button class="btn-action" onclick="hireManager()">Ä°ÅE AL ($${MANAGER_SALARY.toLocaleString()})</button>`;

        html += `<div class="facility-card"><div class="facility-info"><h3>Ã–zel AntrenÃ¶r</h3><p>AtlarÄ± her hafta otomatik Ã§alÄ±ÅŸtÄ±rÄ±r.<br>Durum: ${trainerStatus}</p></div><div>${trainerBtn}</div></div><div class="facility-card"><div class="facility-info"><h3>YarÄ±ÅŸ Menajeri</h3><p>Uygun yarÄ±ÅŸlarÄ± bulur ve atlarÄ± otomatik kaydeder.<br>Durum: ${managerStatus}</p></div><div>${managerBtn}</div></div><h3 style="color:#e67e22; border-top: 1px dashed #555; padding-top:15px; margin-top:20px;">ğŸ‡ SÃ–ZLEÅMELÄ° JOKEY KADROSU</h3><button class="menu-btn" style="background:#e67e22; color:white; width:100%;" onclick="showJockeyManagement()">JOKEY KADROSU YÃ–NETÄ°MÄ° (${hiredJockeys.length}/${MAX_HIRED_JOCKEYS})</button>`;
        document.getElementById("mainDisplay").innerHTML = html;
    }
    
    window.hireManager = function() { if(money < MANAGER_SALARY) return alert("Paran yetersiz!"); spendMoney( MANAGER_SALARY); hiredManager = true; alert("Menajer iÅŸe alÄ±ndÄ±!"); updateUI(); showStaff(); }
    window.fireManager = function() { hiredManager = false; alert("Menajer kovuldu."); updateUI(); showStaff(); }

    window.showJockeys = function(){
        if(!allJockeys || allJockeys.length === 0) generateJockeys();
        let availableList = `<h2>ğŸ‡ BOÅTA OLAN JOKEY LÄ°STESÄ°</h2><p style="color:#7f8c8d;">SÃ¶zleÅŸme imzalamak iÃ§in <a href="#" onclick="showStaff()" style="color:#f1c40f;">Personel</a> menÃ¼sÃ¼nÃ¼ kullanÄ±n.</p><div class="jockey-list-container">`;
        let availableCount = 0;
        allJockeys.filter(j => !j.isContracted).forEach(j => {
            let badgeClass = j.type === 'Usta' ? 'badge-usta' : (j.type === 'Apranti' ? 'badge-apranti' : 'badge-emekli');
            availableList += `<div class="jockey-card" style="background:#1a252f; border-color:#95a5a6;"><div><span class="${badgeClass}">${j.type.toUpperCase()}</span> <strong>${j.name}</strong></div><div style="margin-top:5px; color:#7f8c8d">YaÅŸ: ${j.age} | Yetenek: ${j.skill}</div><div style="font-size:11px; color:#2ecc71">Piyasa Ãœcreti: $${j.fee.toLocaleString()}</div></div>`; availableCount++;
        });
        availableList += `</div>`; if (availableCount === 0) availableList = `<h2>ğŸ‡ BOÅTA JOKEY YOK</h2><p style="color:#7f8c8d;">TÃ¼m jokeyler sÃ¶zleÅŸme altÄ±nda veya piyasada gÃ¶rÃ¼nmÃ¼yor.</p>`;
        document.getElementById("mainDisplay").innerHTML = availableList;
    }

    window.showJockeyManagement = function() {
    if(!allJockeys || allJockeys.length === 0) generateJockeys();
    
    // --- SÃ–ZLEÅMELÄ°LER BÃ–LÃœMÃœ ---
    let contractedList = `<h3 style="color:#2ecc71; border-bottom: 2px solid #2ecc71; padding-bottom:10px;">ğŸ“ SÃ–ZLEÅMELÄ° EKÄ°BÄ°NÄ°Z (${hiredJockeys.length}/${MAX_HIRED_JOCKEYS})</h3>`;
    
    if (hiredJockeys.length === 0) {
        contractedList += `<div style="padding:20px; background:#222; color:#777; text-align:center; border:1px dashed #555;">HenÃ¼z sÃ¶zleÅŸmeli jokeyiniz yok. AÅŸaÄŸÄ±dan transfer yapÄ±n.</div>`;
    } else {
        contractedList += `<div class="jockey-grid">`;
        hiredJockeys.forEach(j => {
            let status = j.trainingWeeks > 0 ? `<span style="color:#f1c40f">EÄÄ°TÄ°MDE (${j.trainingWeeks} hf)</span>` : `<span style="color:#2ecc71">YARIÅA HAZIR</span>`;
            contractedList += `
            <div class="jockey-card-pro ${j.type === 'Efsane' ? 'legend' : ''}" style="border-left-color: #2ecc71;">
                <div class="jockey-header">
                    <span class="jockey-name">${j.name}</span>
                    <span class="jockey-type type-${j.type.toLowerCase()}">${j.type}</span>
                </div>
                <div style="font-size:12px; color:#bdc3c7; margin-bottom:10px;">
                    <div>Durum: ${status}</div>
                    <div>SÃ¶zleÅŸme: <strong>${j.contractWeeks} Hafta</strong></div>
                    <div>MaaÅŸ: $${(JOKEY_BASE_SALARY/48).toFixed(0)}/hafta</div>
                </div>
                <div style="margin-top:auto; display:flex; gap:5px;">
                    <button class="btn-action" style="flex:1; background:#e67e22;" onclick="openJockeyModal(${j.id})">YÃ–NET / EÄÄ°T</button>
                    <button class="btn-sell" style="flex:1;" onclick="terminateContract(${j.id})">KOV</button>
                </div>
            </div>`;
        });
        contractedList += `</div>`;
    }

    // --- TRANSFER PAZARI BÃ–LÃœMÃœ ---
    let availableList = `<h3 style="color:#3498db; border-bottom: 2px solid #3498db; padding-bottom:10px; margin-top:30px;">ğŸŒ TRANSFER PAZARI (Serbest Jokeyler)</h3>
                         <div class="jockey-grid">`;
    
    // Sadece boÅŸta olanlarÄ± gÃ¶ster (En iyi 20 tanesini gÃ¶sterelim ki sayfa kasmasÄ±n)
    allJockeys.filter(j => !j.isContracted).slice(0, 20).forEach(j => {
        let skillPercent = j.skill;
        let skillColor = j.skill > 90 ? '#f1c40f' : (j.skill > 70 ? '#2ecc71' : '#e74c3c');
        let cardClass = j.type === 'Efsane' ? 'legend' : '';
        
        availableList += `
        <div class="jockey-card-pro ${cardClass}">
            <div class="jockey-header">
                <span class="jockey-name">${j.name}</span>
                <span class="jockey-type type-${j.type.toLowerCase()}">${j.type}</span>
            </div>
            
            <div style="margin-bottom:10px;">
                <div style="display:flex; justify-content:space-between; font-size:11px; color:#aaa;">
                    <span>Yetenek</span>
                    <span style="color:${skillColor}">${j.skill}/120</span>
                </div>
                <div class="skill-bar-container">
                    <div class="skill-bar-fill" style="width:${Math.min(100, (j.skill/120)*100)}%; background:${skillColor}"></div>
                </div>
            </div>

            <div style="font-size:12px; color:#bdc3c7; margin-bottom:10px;">
                <div>YaÅŸ: ${j.age}</div>
                <div>Ä°mza ParasÄ±: <span style="color:#f1c40f; font-weight:bold;">$${JOKEY_BASE_SALARY.toLocaleString()}</span></div>
            </div>

            <button class="btn-action" style="width:100%; background:#2980b9;" onclick="signContract(${j.id})">
                âœï¸ SÃ–ZLEÅME Ä°MZALA
            </button>
        </div>`;
    });
    
    availableList += `</div>`;

    document.getElementById("mainDisplay").innerHTML = contractedList + availableList;
}

    window.startJockeyTraining = function(jockeyId, trainingType) {
    let j = hiredJockeys.find(x => x.id === jockeyId); 
    let t = JOKEY_TRAINING_COST[trainingType];
    
    if (!j || !t) return; 
    if (j.trainingWeeks > 0) return alert("Jokey zaten eÄŸitimde!"); 
    
    // BURAYI GÃœNCELLEDÄ°K: "Economy.money" olarak deÄŸiÅŸtirdik
    if (Economy.money < t.cost) return alert("EÄŸitim Ã¼creti iÃ§in paranÄ±z yetersiz!");
    
    let currentSkill = j[t.target];
    let targetSkill = t.skill; 
    
    if (currentSkill + targetSkill > 120) { 
        targetSkill = 120 - currentSkill;
        if (targetSkill <= 0) return alert(`Jokeyin bu yeteneÄŸi zaten maksimum seviyeye yakÄ±n (120)!`);
    }

    spendMoney(t.cost); // ArtÄ±k parayÄ± Economy Ã¼zerinden harcayacak
    j.trainingWeeks = t.weeks; 
    j.trainingTarget = targetSkill;
    j.trainingTargetKey = t.target; 
    
    alert(`${j.name} ${trainingType.replace(/([A-Z])/g, ' $1').trim()} eÄŸitimine baÅŸladÄ±! Kalan sÃ¼re: ${t.weeks} hafta.`); 
    updateUI(); 
    openJockeyModal(jockeyId);
}

    window.addSponsor = function(jockeyId) {
        let j = hiredJockeys.find(x => x.id === jockeyId); if (!j) return; if (j.sponsor) return alert("Zaten bir sponsorunuz var.");
        if (money < 1000) return alert("Sponsor arama maliyeti ($1000) iÃ§in paranÄ±z yetersiz."); spendMoney( 1000);
        const SPONSOR_NAMES = ["MegaCorp", "QuickStep Energy", "Turbo-Yem", "Glory Sports", "DerbyStars.com"]; j.sponsor = pick(SPONSOR_NAMES);
        alert(`${j.sponsor} ile anlaÅŸÄ±ldÄ±! HaftalÄ±k $100 gelir saÄŸlayacak.`); updateUI(); openJockeyModal(jockeyId);
    }
    
    window.removeSponsor = function(jockeyId) { let j = hiredJockeys.find(x => x.id === jockeyId); if (!j) return; j.sponsor = null; alert("Sponsorluk sÃ¶zleÅŸmesi iptal edildi."); updateUI(); openJockeyModal(jockeyId); }
    
    // --- ANTRENMAN SAHASI KARTLARI ---
    window.showTraining = function() {
        if(myHorses.length == 0) return alert("AhÄ±rÄ±nÄ±zda antrenman yapacak at yok.");
        
        let trainerBtn = hiredTrainer ? 
            `<div style="background:#27ae60; padding:10px; border-radius:5px; margin-bottom:20px;">
                âœ… <strong>Ã–zel AntrenÃ¶r:</strong> AKTÄ°F 
                <small>AtlarÄ± otomatik geliÅŸtiriyor. </small> 
                <button class="btn-sell" onclick="fireTrainer()" style="float:right;">KOV</button>
            </div>` : 
            `<div style="background:#222; padding:10px; border:1px dashed #777; border-radius:5px; margin-bottom:20px;">
                âŒ <strong>Ã–zel AntrenÃ¶r:</strong> YOK 
                <small>Ä°ÅŸe alarak otomatik geliÅŸim saÄŸlayÄ±n.</small> 
                <button class="btn-action" onclick="hireTrainer()" style="float:right;">Ä°ÅE AL (AylÄ±k $${TRAINER_SALARY.toLocaleString()})</button>
            </div>`;
        
        let horseList = `<h2 style="color:#e67e22; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:20px;">ğŸ‹ï¸ ANTRENMAN SAHASI</h2>
                         ${trainerBtn}
                         <div class="stable-grid">`;
        
        myHorses.forEach((h, i) => {
            if(h.isInjured) return; 
            
            let potentialEnded = h.sprint >= h.maxSprint && h.stamina >= h.maxStamina;

            let conditionColor = getColor(h.condition);
            
            horseList += `
            <div class="horse-card-new" style="border-color:${potentialEnded?'#e74c3c':'#e67e22'}; background: linear-gradient(145deg, #1a252f, #283747);">
                
                <div class="card-header" style="border-color:#444;">
                    <div class="horse-name-title" style="color:#e67e22;">${h.name}</div>
                    <small style="color:#aaa;">${h.gender}, ${h.age}y</small>
                </div>

                <div class="card-body-flex">
                    <img src="${h.customImage || 'resimler/at.gif'}" class="big-horse-img" style="filter:${h.colorFilter || 'none'}; border-color:${conditionColor};">
                    <div class="stat-lines">
                        <div style="font-size:14px; font-weight:bold; margin-bottom:5px;">Kondisyon: <span style="color:${conditionColor};">%${h.condition}</span></div>
                        <div class="energy-bar-bg" style="width:100%; height:10px; margin-bottom:10px;"><div class="energy-bar-fill" style="width:${h.condition}%; background:${conditionColor}"></div></div>
                        <div>âš¡ HÄ±z: <span style="color:#fff;">${h.sprint.toFixed(0)}</span> <small style="color:#95a5a6;">/${h.maxSprint}</small></div>
                        <div>ğŸ›¡ï¸ GÃ¼Ã§: <span style="color:#fff;">${h.stamina.toFixed(0)}</span> <small style="color:#95a5a6;">/${h.maxStamina}</small></div>
                    </div>
                </div>

                <div class="card-footer">
                    <button class="btn-action" style="width:100%; background:${potentialEnded ? '#555' : '#e67e22'};" 
                            onclick="openGallopGame(${i})" ${potentialEnded ? 'disabled' : ''}>
                        ${potentialEnded ? 'POTANSÄ°YEL BÄ°TTÄ°' : 'Ä°NTERAKTÄ°F GALOP BAÅLAT ğŸ‡'}
                    </button>
                </div>
            </div>`;
        });
        
        horseList += `</div>`; 
        document.getElementById("mainDisplay").innerHTML = horseList;
    }

    window.hireTrainer = function() { if(money < TRAINER_SALARY) return alert("Paran yetersiz!"); spendMoney( TRAINER_SALARY); hiredTrainer = true; alert("AntrenÃ¶r iÅŸe alÄ±ndÄ±!"); updateUI(); showTraining(); }
    window.fireTrainer = function() { hiredTrainer = false; alert("AntrenÃ¶r kovuldu."); updateUI(); showTraining(); }
    
    window.openGallopGame = function(horseIndex) {
        gallopHorse = myHorses[horseIndex]; if(gallopHorse.condition < 20) return alert("Bu at Ã§ok yorgun!");
        if (gallopHorse.sprint >= gallopHorse.maxSprint && gallopHorse.stamina >= gallopHorse.maxStamina) return alert(`${gallopHorse.name} maksimum potansiyeline ulaÅŸtÄ±. Daha fazla antrenman fayda etmeyecektir.`);
        gallopProgress = 0; gallopScore = 0;
        let html = `<button class="close-btn" onclick="clearInterval(gallopInterval); document.getElementById('modalOverlay').style.display='none'">X</button><h2 style="color:#f1c40f; text-align:center;">Ä°NTERAKTÄ°F GALOP: ${gallopHorse.name}</h2><p style="text-align:center; color:#ccc;">YeÅŸil bÃ¶lgelerdeyken <strong>KIRBAÃ‡LA</strong> butonuna bas!</p><div class="gallop-track" id="gallopTrack"><div class="gallop-cursor" id="gallopCursor"></div><div class="gallop-zone" style="left:18%; width:10%;"></div><div class="gallop-zone" style="left:38%; width:10%;"></div><div class="gallop-zone" style="left:58%; width:10%;"></div><div class="gallop-zone" style="left:78%; width:10%;"></div><div class="gallop-marker" style="left:20%">200m</div><div class="gallop-marker" style="left:40%">400m</div><div classop-marker" style="left:60%">600m</div><div class="gallop-marker" style="left:80%">800m</div></div><div id="feedback" class="feedback-text">HAZIR OL...</div><button id="whipBtn" class="whip-btn" onclick="whipAction()">ğŸ KIRBAÃ‡LA!</button>`;
        document.getElementById("modalBody").innerHTML = html; document.getElementById("modalOverlay").style.display = "flex"; setTimeout(startGallop, 1000);
    }
    
    function startGallop() { let track = document.getElementById("gallopTrack"); let cursor = document.getElementById("gallopCursor"); if(!track) return; gallopInterval = setInterval(() => { gallopProgress += 0.8; cursor.style.left = gallopProgress + "%"; if(gallopProgress >= 100) endGallop(); }, 30); }
    window.whipAction = function() { if(whipCooldown) return; let hit = false; let zones = [[18,28], [38,48], [58,68], [78,88]]; for(let z of zones) { if(gallopProgress >= z[0] && gallopProgress <= z[1]) { hit = true; break; } } let feedback = document.getElementById("feedback"); if(hit) { gallopScore++; feedback.innerHTML = "<span style='color:#2ecc71'>MÃœKEMMEL! ğŸ”¥</span>"; feedback.style.transform = "scale(1.2)"; } else { gallopScore--; feedback.innerHTML = "<span style='color:#e74c3c'>ISKADIN! âŒ</span>"; } setTimeout(()=> feedback.style.transform = "scale(1)", 200); whipCooldown = true; setTimeout(()=> whipCooldown = false, 500); }
    
    function endGallop() {
        clearInterval(gallopInterval); let bonus = (facilities.training.level - 1); let msg = ""; let sprintGain = 0; let staminaGain = 0;
        if(gallopScore >= 3) { sprintGain = 2 + bonus; staminaGain = 2 + bonus; gallopHorse.condition -= 15; msg = `<h2 style="color:#2ecc71">HARÄ°KA ANTRENMAN!</h2>`; } 
        else if (gallopScore >= 0) { sprintGain = 1 + bonus; staminaGain = 1 + bonus; gallopHorse.condition -= 20; msg = `<h2 style="color:#f1c40f">Ä°DARE EDER...</h2>`; } 
        else { gallopHorse.condition -= 30; if(Math.random() > 0.5) { gallopHorse.isInjured = true; gallopHorse.injuryWeeks = rand(2, 6); msg = `<h2 style="color:#e74c3c">FELAKET! ğŸš‘</h2>`; } else { msg = `<h2 style="color:#e74c3c">KÃ–TÃœ GEÃ‡TÄ°</h2>`; } }
        let currentSprint = gallopHorse.sprint; let currentStamina = gallopHorse.stamina;
        gallopHorse.sprint = Math.min(gallopHorse.maxSprint, currentSprint + sprintGain); gallopHorse.stamina = Math.min(gallopHorse.maxStamina, currentStamina + staminaGain);
        document.getElementById("modalBody").innerHTML = `${msg}<br><p>HÄ±z GeliÅŸimi: +${(gallopHorse.sprint - currentSprint).toFixed(1)} | DayanÄ±klÄ±lÄ±k GeliÅŸimi: +${(gallopHorse.stamina - currentStamina).toFixed(1)}</p><br><button class="menu-btn" onclick="document.getElementById('modalOverlay').style.display='none'; showTraining(); updateUI();">TAMAM</button>`; updateUI();
    }

    function autoRegisterHorses() {
        // Menajer yoksa veya para yoksa Ã§alÄ±ÅŸma
        if(!hiredManager) return; 
        if(money < MANAGER_SALARY) { 
            hiredManager = false; 
            alert("MaaÅŸ Ã¶denemediÄŸi iÃ§in Menajer istifa etti!"); 
            return; 
        }
        
        spendMoney( MANAGER_SALARY); 
        let report = []; 
        
        // ADIM 1: ATLARINI GÃœCÃœNE GÃ–RE SIRALA
        let sortedHorses = [...myHorses].sort((a,b) => b.rating - a.rating);

        // ADIM 2: YARIÅLARI Ã–DÃœL VE Ã–NEME GÃ–RE SIRALA
        let prioritizedRaces = activeRaces.map((r, index) => ({ race: r, index: index }))
            .sort((a, b) => {
                if (a.race.isGazi) return -1;
                if (b.race.isGazi) return 1;
                return b.race.prize - a.race.prize;
            });

        // ADIM 3: EÅLEÅTÄ°RME (VÄ°CDAN AYARI BURADA)
        sortedHorses.forEach(h => {
            
            // --- GÃœNCELLEME: KORUMACI MENAJER ---
            // Eski ayar: h.condition < 40 idi. (Ã‡ok riskliydi)
            // Yeni ayar: h.condition < 70. 
            // AtÄ±n kondisyonu %70'in altÄ±ndaysa Menajer onu pas geÃ§er, dinlendirir.
            if(h.isInjured || h.condition < 70) return; 

            // Zaten bir yere kayÄ±tlÄ± mÄ±?
            let alreadyRacing = activeRaces.some(r => r.registeredUserHorses.some(rh => rh.id === h.id)); 
            if(alreadyRacing) return;

            // En bÃ¼yÃ¼k yarÄ±ÅŸtan baÅŸlayarak aÅŸaÄŸÄ± doÄŸru tara
            for (let item of prioritizedRaces) {
                let r = item.race;

                // KOTA KONTROLÃœ
                if (r.registeredUserHorses.length >= 3) continue;

                // --- KURALLAR VE UYGUNLUK ---
                if(r.category === 'Maiden' && h.history.some(rec => rec.rank === 1)) continue; 
                if(h.rating < r.minRating) continue; 
                if(r.maxRating < 2000 && h.rating > r.maxRating) continue; 
                if(r.ageLimit && Math.floor(h.age) !== r.ageLimit) continue; 
                if(r.gender && h.gender !== r.gender) continue; 
                if (r.winCountLimit !== undefined && r.winCountLimit !== null) { 
                     let wins = h.history.filter(rec => rec.rank === 1).length; 
                     if (wins > r.winCountLimit) continue; 
                }

                // --- STRATEJÄ°K KARAR ---
                let isBigRace = r.category.includes("G1") || r.category.includes("Elite") || r.prize >= 1000000;
                
                // BÃ¼yÃ¼k yarÄ±ÅŸ deÄŸilse pist tercihine dikkat etsin
                if (!isBigRace) {
                    if (r.surface !== h.surface) continue;
                }

                // --- EÅLEÅME TAMAM! ---
                r.registeredUserHorses.push(h); 
                report.push(`${h.name} -> ${r.name}`);
                break; 
            }
        });
        
        if(report.length > 0) weeklyLogs.push(`[MENAJER] ${report.length} at, kondisyonlarÄ± uygun olduÄŸu iÃ§in kaydedildi.`);
        else weeklyLogs.push(`[MENAJER] Bu hafta uygun kondisyonda at bulunamadÄ±ÄŸÄ± iÃ§in kayÄ±t yapÄ±lmadÄ±.`);
    }

    window.showRaceCenter = function() {
        // EÄŸer yarÄ±ÅŸ listesi boÅŸsa oluÅŸtur
        if(activeRaces.length === 0) generateWeeklyRaces();

        let html = `<h2 style="color:#e74c3c">GÃœNLÃœK YARIÅ BÃœLTENÄ° (Hafta: ${week})</h2>
                    <p style="color:#aaa; font-size:12px;">DÃ¼nya genelindeki yarÄ±ÅŸlar ve yerel kupalar.</p>
                    <div style="display:flex; gap:20px; justify-content:center; margin-top:20px; flex-wrap:wrap;">`;
        
        activeRaces.forEach((r, idx) => {
            // Renk AyarlarÄ±
            let badgeColor = '#27ae60'; // Standart YeÅŸil
            if(r.category.includes('G1')) badgeColor = '#8e44ad'; // Mor (G1)
            else if(r.category.includes('G2') || r.category.includes('KV')) badgeColor = '#2980b9'; // Mavi
            else if(r.category.includes('Handikap')) badgeColor = '#e67e22'; // Turuncu
            if(r.isGazi) badgeColor = '#f1c40f'; // AltÄ±n (Gazi)

            let weatherIcon = r.weather === 'YaÄŸmurlu' ? 'ğŸŒ§ï¸' : (r.weather === 'Ã‡amurlu' ? 'ğŸŒ«ï¸' : 'â˜€ï¸');
            
            // Buton Metni
            let btnText = "KAYIT OL"; 
            let btnStyle = `background:${r.isGazi?'#f1c40f':'#bdc3c7'}; color:${r.isGazi?'black':'black'}`;
            
            // Ekstra Åartlar YazÄ±sÄ±
            let requirements = []; 
            if (r.ageLimit) requirements.push(`${r.ageLimit} YaÅŸ`); 
            if (r.gender) requirements.push(`Sadece ${r.gender}`); 
            if (r.winCountLimit !== undefined && r.winCountLimit !== null) requirements.push(`Max ${r.winCountLimit} Zafer`);
            
            let reqText = requirements.length > 0 ? `<br><small style="color:#f39c12; font-weight:bold;">Åart: ${requirements.join(', ')}</small>` : '';
            
            // EÄŸer kayÄ±tlÄ± at varsa butonu yeÅŸil yap
            if(r.registeredUserHorses && r.registeredUserHorses.length > 0) { 
                btnText = `âœ… KAYITLI: ${r.registeredUserHorses.length} AT`; 
                btnStyle = "background:#27ae60; color:white; border:1px solid #fff;"; 
            }

            // --- HTML KART YAPISI ---
            html += `
            <div title="${r.tooltip || 'Detay Yok'}" style="background:#000; border:2px solid ${badgeColor}; padding:15px; width:220px; text-align:center; position:relative; cursor:help; box-shadow: 0 0 15px ${r.isGazi ? 'rgba(241, 196, 15, 0.5)' : 'none'}; border-radius:8px;">
                
                <div style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:${badgeColor}; color:${r.isGazi?'black':'white'}; padding:2px 10px; font-size:11px; font-weight:bold; border-radius:4px;">${r.category}</div>
                
                <h3 style="color:${badgeColor}; margin-top:15px; font-size:15px; margin-bottom:5px;">${r.name}</h3>
                <p style="color:#ccc; font-size:12px; margin:2px;">ğŸ“ ${r.city} | ${r.surface}</p>
                <p style="color:#3498db; font-size:12px; margin:2px;">${weatherIcon} ${r.weather}</p>
                <p style="font-weight:bold; font-size:13px; margin:5px 0;">${r.dist} Metre</p>
                
                <p style="color:#f1c40f; font-size:12px; margin-bottom:0;">Ã–dÃ¼l: $${r.prize.toLocaleString()}${reqText}</p>
                
                <p style="color:#7f8c8d; font-size:10px; margin-top:2px; border-top:1px dashed #333; padding-top:2px;">
                    Gerekli HP: <span style="color:#fff">${r.minRating}</span> - <span style="color:#fff">${r.maxRating > 1000 ? 'âˆ' : r.maxRating}</span>
                </p>

                <button class="menu-btn" style="width:100%; text-align:center; font-size:12px; padding:8px; margin-top:10px; ${btnStyle}" onclick="setupRace(${idx})">${btnText}</button>
            </div>`;
        });
        
        html += `</div>`; 
        document.getElementById("mainDisplay").innerHTML = html;
    }

    function checkHorseEligibility(h, race) {
        // 1. SakatlÄ±k KontrolÃ¼
        if (h.isInjured) return false;
        
        // 2. Handikap / Puan KontrolÃ¼
        if (h.rating < race.minRating || h.rating > race.maxRating) return false;
        
        // 3. Gazi KoÅŸusu Ã–zel KontrolÃ¼ (Sadece 3 yaÅŸ)
        if (race.isGazi && Math.floor(h.age) !== 3) return false;

        // 4. Maiden KontrolÃ¼
        let wins = h.history.filter(r => r.rank === 1).length;
        if (race.category === 'Maiden' && wins > 0) return false;

        // 5. GELÄ°ÅMÄ°Å YAÅ KONTROLÃœ (Yeni Ã–zellik)
        let horseAge = Math.floor(h.age);
        
        if (race.ageLimit) {
            // EÄŸer "ve YukarÄ±" Ã¶zelliÄŸi varsa (minAge)
            if (race.isAgePlus) {
                if (horseAge < race.ageLimit) return false; // AtÄ±n yaÅŸÄ± sÄ±nÄ±rdan kÃ¼Ã§Ã¼kse giremez
            } else {
                // Tam yaÅŸ istiyorsa (Ã–rn: Sadece 2 yaÅŸlÄ±lar)
                if (horseAge !== race.ageLimit) return false;
            }
        }

        // 6. Cinsiyet ve Kazanma SayÄ±sÄ±
        if (race.gender && h.gender !== race.gender) return false;
        if (race.winCountLimit !== undefined && race.winCountLimit !== null) { 
            if (wins > race.winCountLimit) return false; 
        }
        
        return true;
    }

    window.setupRace = function(raceIndex) {
        if(myHorses.length === 0) { alert("HiÃ§ atÄ±n yok!"); return; }
        let templateRace = activeRaces[raceIndex]; activeRace = JSON.parse(JSON.stringify(templateRace)); activeRace.runners = []; activeBets = [];
        let modal = document.getElementById("modalOverlay"); let body = document.getElementById("modalBody"); modal.style.display = "flex";

        if(templateRace.registeredUserHorses && templateRace.registeredUserHorses.length > 0) {
            body.innerHTML = `<button class="close-btn" onclick="document.getElementById('modalOverlay').style.display='none'">X</button><div id="raceSetupStep2"></div>`;
            if(!allJockeys || allJockeys.length === 0) generateJockeys();
            templateRace.registeredUserHorses.forEach(h => { let realHorse = myHorses.find(x => x.id === h.id); if(realHorse) { let j = hiredJockeys.length > 0 ? pick(hiredJockeys) : pick(allJockeys); activeRace.runners.push({ horse: realHorse, jockey: j, isUser: true, score: 0, tactic: 'balanced', odds: 0 }); } });
            fillOpponentsAndBet(); return;
        }
        
        let validHorses = myHorses.filter(h => checkHorseEligibility(h, activeRace));
        if (validHorses.length === 0) { body.innerHTML = `<button class="close-btn" onclick="document.getElementById('modalOverlay').style.display='none'">X</button><h2 style="color:#e74c3c">UYARI</h2><p>Bu yarÄ±ÅŸÄ±n ÅŸartlarÄ±nÄ± saÄŸlayan veya saÄŸlÄ±klÄ± atÄ±nÄ±z yok.</p>`; return; }
        
        let transportFee = (activeRace.city === HOME_CITY) ? 0 : TRANSPORT_COST;
        let transportMsg = transportFee > 0 ? `<span style="color:#e74c3c">Nakliye: -$${transportFee.toLocaleString()}</span>` : `<span style="color:#2ecc71">Ä°stanbul (Ãœcretsiz)</span>`;
        let horseOptions = validHorses.map((h,i) => `<option value="${h.id}">${h.name} (${h.age}y, HP:${h.rating || 40})</option>`).join("");
        
        body.innerHTML = `<button class="close-btn" onclick="document.getElementById('modalOverlay').style.display='none'">X</button><h2>${activeRace.name} (${activeRace.city}) - ${activeRace.weather}</h2><p style="text-align:center; font-weight:bold; margin-bottom:10px;">${transportMsg}</p><div id="raceSetupStep1"><p>1. KoÅŸacak AtÄ± SeÃ§:</p><select id="selectedHorseId" style="padding:10px; width:100%; background:#000; color:#fff;">${horseOptions}</select><hr><p>2. Taktik:</p><select id="selectedTactic" style="padding:10px; width:100%; background:#000; color:#f1c40f; border:1px solid #f1c40f"><option value="balanced">ğŸ›¡ï¸ Dengeli</option><option value="agresif">âš¡ Agresif</option><option value="bekle">ğŸ”¥ Bekle ve Vur</option></select><hr><p>3. Jokey SeÃ§imi:</p><button class="menu-btn" onclick="selectJokey('best')">ğŸŒŸ En Ä°yi Jokey</button><button class="menu-btn" onclick="selectJokey('contracted')">ğŸ¤ SÃ¶zleÅŸmeli Jokey</button><button class="menu-btn" onclick="selectJokey('random')">ğŸ² Rastgele Jokey</button></div><div id="raceSetupStep2" style="display:none"></div>`;
    }

    window.selectJokey = function(method) { 
        let horseId = document.getElementById("selectedHorseId").value; let h = myHorses.find(x => x.id == horseId); if(!h) { alert("At seÃ§imi hatasÄ±!"); return; }
        let transportFee = (activeRace.city === HOME_CITY) ? 0 : TRANSPORT_COST; if(money < transportFee) return alert("Nakliye iÃ§in paran yetersiz!");
        if(transportFee > 0) { if(!confirm(`Bu yarÄ±ÅŸ iÃ§in $${transportFee.toLocaleString()} nakliye Ã¼creti kesilecek. OnaylÄ±yor musun?`)) return; spendMoney( transportFee); updateUI(); }
        if(!allJockeys || allJockeys.length === 0) generateJockeys();
        let j; if (method === 'best') j = [...allJockeys].sort((a,b) => b.skill - a.skill)[0]; else if (method === 'contracted') { if (hiredJockeys.length === 0) return alert("SÃ¶zleÅŸmeli jokeyiniz yok!"); j = pick(hiredJockeys.filter(j => j.trainingWeeks === 0)); if (!j) return alert("SÃ¶zleÅŸmeli jokeyiniz ÅŸu an eÄŸitimde veya mÃ¼sait deÄŸil!"); } else j = pick(allJockeys);
        activeRace.runners.push({ horse: h, jockey: j, isUser: true, score: 0, tactic: document.getElementById("selectedTactic").value, odds: 0 });
        document.getElementById("raceSetupStep1").style.display = "none"; document.getElementById("raceSetupStep2").style.display = "block"; fillOpponentsAndBet();
    }
    
    function getTipsterComment(activeRace, runners) {
        if (runners.length < 2) return "Tipster yorum yapamÄ±yor: Yeterli rakip yok!";
        let topRunner = [...runners].sort((a,b) => b.score - a.score)[0]; let secondRunner = runners.length > 1 ? [...runners].sort((a,b) => b.score - a.score)[1] : null; let tipsterMsg = "";
        if(topRunner.isUser) tipsterMsg = `ğŸ”¥ Favorim sizin atÄ±nÄ±z: **${topRunner.horse.name}**! Kondisyonu yerinde, bugÃ¼n kazanÄ±r!`;
        else if (topRunner.horse.isElite) tipsterMsg = `ğŸŒŸ ${topRunner.horse.name} bugÃ¼n formda. Tek geÃ§erim, ganyan kuponuna ekle!`;
        else if (activeRace.weather === 'YaÄŸmurlu' || activeRace.weather === 'Ã‡amurlu') tipsterMsg = `ğŸŒ§ï¸ Pist aÄŸÄ±rdÄ±, ${topRunner.horse.surface} pist tercihine sahip atlar avantajlÄ±!`;
        else if (secondRunner) tipsterMsg = `ğŸ KoÅŸu Ã§ok dengeli, Ä°kili Bahis iÃ§in ${topRunner.horse.name} ve ${secondRunner.horse.name} denenmeli.`;
        else tipsterMsg = `ğŸ¤” Zorlu bir koÅŸu, sÃ¼rpriz yaÅŸanabilir.`;
        return tipsterMsg;
    }

    window.fillOpponentsAndBet = function() {
    // 1. EÄŸer yarÄ±ÅŸta yeterli at yoksa (min 6), rastgele rakipler ekle
    if(activeRace.runners.length < 6) {
        let opponentsNeeded = 6 - activeRace.runners.length + rand(0, 5); 
        for(let i=0; i<opponentsNeeded; i++) {
            let oppHorse = pick(allOpponents); 
            // Rakip atÄ±n gÃ¼cÃ¼nÃ¼ yarÄ±ÅŸÄ±n seviyesine gÃ¶re ayarla
            oppHorse.rating = rand(activeRace.minRating, activeRace.maxRating === 9999 ? 120 : activeRace.maxRating);
            
            if(allJockeys.length === 0) generateJockeys();
            
            activeRace.runners.push({ 
                horse: oppHorse, 
                jockey: pick(allJockeys), 
                isUser: false, 
                score: 0, 
                tactic: pick(['balanced', 'agresif', 'bekle']), 
                odds: 0 
            });
        }
        
        // 2. OranlarÄ± Hesapla (GÃ¼ce gÃ¶re)
        let totalPower = 0; 
        activeRace.runners.forEach(r => { 
            let avgJockeySkill = (r.jockey.paceControl + r.jockey.sprintFinish + r.jockey.whipUsage) / 3;
            let p = (r.horse.sprint + r.horse.stamina) * (r.horse.rating / 100) * (avgJockeySkill / 80); 
            r.rawPower = p; 
            totalPower += p; 
        });
        activeRace.runners.forEach(r => { 
            let rawOdd = (1 / (r.rawPower / totalPower) * 3);
            r.odds = rawOdd < 1.05 ? 1.05 : rawOdd.toFixed(2); 
        }); 
    }

    // 3. YarÄ±ÅŸ ProgramÄ± Tablosunu OluÅŸtur
    let programTable = `
        <div style="background:#1a252f; border:1px solid #7f8c8d; padding:10px; margin-bottom:20px; border-radius:5px;">
            <h3 style="color:#f1c40f; text-align:center; border-bottom:1px solid #555; padding-bottom:5px;">ğŸ“Š RESMÄ° YARIÅ PROGRAMI</h3>
            <table style="font-size:12px;">
                <thead>
                    <tr style="background:#2c3e50; color:#bdc3c7;">
                        <th style="padding:5px;">No</th>
                        <th style="padding:5px;">At Ä°smi</th>
                        <th style="padding:5px;">Jokey</th>
                        <th style="padding:5px;">HP (GÃ¼Ã§)</th>
                        <th style="padding:5px;">Form/Taktik</th>
                        <th style="padding:5px;">ORAN</th>
                    </tr>
                </thead>
                <tbody>
    `;

    activeRace.runners.forEach((r, index) => {
        let rowStyle = r.isUser ? 'background-color:#2980b9; color:#fff;' : (index % 2 === 0 ? 'background-color:#222;' : '');
        let star = r.horse.isElite ? 'â­' : '';
        let tacticIcon = r.tactic === 'agresif' ? 'âš¡' : (r.tactic === 'bekle' ? 'ğŸ¢' : 'ğŸ›¡ï¸');
        let userTag = r.isUser ? ' (SÄ°Z)' : '';
        
        programTable += `
            <tr style="${rowStyle}">
                <td style="text-align:center; font-weight:bold;">${index + 1}</td>
                <td><strong>${star} ${r.horse.name}${userTag}</strong><br><small style="color:#aaa">${Math.floor(r.horse.age)}y, ${r.horse.gender}</small></td>
                <td>${r.jockey.name}<br><small>Yet: ${r.jockey.skill}</small></td>
                <td style="text-align:center;"><span class="rating-badge">${r.horse.rating || 40}</span><br><small>H:${r.horse.sprint.toFixed(0)} D:${r.horse.stamina.toFixed(0)}</small></td>
                <td style="text-align:center;">${tacticIcon} ${r.tactic}</td>
                <td style="text-align:center; font-size:16px; font-weight:bold; color:#f1c40f;">${r.odds}</td>
            </tr>
        `;
    });
    programTable += `</tbody></table></div>`;

    // 4. Bahis SeÃ§eneklerini HazÄ±rla
    let opts = activeRace.runners.map((r,i) => `<option value="${i}">(${i+1}) ${r.horse.name} - ORAN: ${r.odds}</option>`).join("");
    
    // Alt bahisler iÃ§in seÃ§enekler
    let opts2 = `<select id="betHorse2_1" style="padding:10px; width:48%; background:#000; color:white; display:inline-block;">${opts}</select><select id="betHorse2_2" style="padding:10px; width:48%; background:#000; color:white; display:inline-block;">${opts}</select>`;
    let opts3 = `<select id="betHorse3_1" style="padding:10px; width:32%; background:#000; color:white; display:inline-block;">${opts}</select><select id="betHorse3_2" style="padding:10px; width:32%; background:#000; color:white; display:inline-block;">${opts}</select><select id="betHorse3_3" style="padding:10px; width:32%; background:#000; color:white; display:inline-block;">${opts}</select>`;

    // 5. HTML'i BirleÅŸtir (Tipster ButonlarÄ± Buraya Eklendi!)
    document.getElementById("raceSetupStep2").innerHTML = `
        ${programTable} 
        
        <div style="background:#2c3e50; border:1px dashed #7f8c8d; padding:10px; border-radius:5px; margin-bottom:15px;">
            <h4 style="margin:0 0 10px 0; color:#bdc3c7; text-align:center;">ğŸ•µï¸ TÃœYO PAZARI (ParalÄ± Bilgi)</h4>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button onclick="buyTip('riza')" style="background:#d35400; border:none; color:white; padding:8px; cursor:pointer; flex:1; border-radius:4px;">
                    â˜• RÄ±za ($100)<br><small>SÃ¼rprizci</small>
                </button>
                <button onclick="buyTip('mert')" style="background:#2980b9; border:none; color:white; padding:8px; cursor:pointer; flex:1; border-radius:4px;">
                    ğŸ“Š Mert ($500)<br><small>Analist</small>
                </button>
                <button onclick="buyTip('hincal')" style="background:#8e44ad; border:none; color:white; padding:8px; cursor:pointer; flex:1; border-radius:4px;">
                    ğŸ•¶ï¸ Ãœstad ($2000)<br><small>%90 Garanti</small>
                </button>
            </div>
            <div id="tipResultArea" style="margin-top:10px; display:none; animation: fadeIn 0.5s;"></div>
        </div>

        <h3 style="color:#e67e22; border-top:2px solid #555; padding-top:10px;">ğŸ† BAHÄ°S YAP</h3>
        
        <div style="background:#34495e; padding:10px; border-radius:5px; margin-bottom:5px;">
            <h4 style="margin:0 0 5px 0;">ğŸ’° Ganyan (KazanÄ±r)</h4>
            <select id="betHorse1" style="padding:8px; width:100%; background:#000; color:white">${opts}</select>
            <input type="number" id="betAmount1" value="100" min="50" style="padding:8px; width:calc(100% - 20px); margin-top:5px;">
            <button class="menu-btn" style="background:#2ecc71; margin-top:5px; width:100%; padding:8px;" onclick="placeBet('ganyan', 'betAmount1', ['betHorse1'])">GANYAN OYNA</button>
        </div>
        
        <details>
            <summary style="background:#222; padding:10px; cursor:pointer; color:#aaa;">DiÄŸer Bahisler (Ä°kili, ÃœÃ§lÃ¼)</summary>
            <div style="background:#34495e; padding:15px; border-radius:5px; margin-top:5px;">
                <h4>ğŸ¥ˆ SÄ±ralÄ± Ä°kili</h4>${opts2}<input type="number" id="betAmount2" value="50" min="50" style="width:100%; margin-top:5px;"><button class="menu-btn" style="background:#e67e22; width:100%; margin-top:5px;" onclick="placeBet('ikili', 'betAmount2', ['betHorse2_1', 'betHorse2_2'])">Ä°KÄ°LÄ° OYNA</button>
                <hr>
                <h4>ğŸ¥‰ SÄ±ralÄ± ÃœÃ§lÃ¼</h4>${opts3}<input type="number" id="betAmount3" value="20" min="20" style="width:100%; margin-top:5px;"><button class="menu-btn" style="background:#3498db; width:100%; margin-top:5px;" onclick="placeBet('Ã¼Ã§lÃ¼', 'betAmount3', ['betHorse3_1', 'betHorse3_2', 'betHorse3_3'])">ÃœÃ‡LÃœ OYNA</button>
            </div>
        </details>

        <button class="next-btn" style="width:100%; margin-top:20px; font-size:20px; padding:20px;" onclick="startRaceAnimation()">ğŸ YARIÅI BAÅLAT</button>
    `;
}

    window.placeBet = function(type, amountId, horseSelectIds){ 
    let amt = parseFloat(document.getElementById(amountId).value); 
    if(money < amt) return alert("Paran yetersiz!"); 
    
    let selectedIndices = horseSelectIds.map(id => document.getElementById(id).value); 
    
    // Ã‡Ã–ZÃœM BURADA: Ä°ndeksleri deÄŸil, o anki atlarÄ±n Ä°SÄ°MLERÄ°NÄ° kaydediyoruz
    let selectedNames = selectedIndices.map(idx => activeRace.runners[idx].horse.name);
    
    let uniqueIndices = new Set(selectedIndices); 
    if (uniqueIndices.size !== selectedIndices.length) return alert("Bahiste aynÄ± atÄ± birden fazla kez seÃ§emezsiniz!");
    
    spendMoney( amt); 
    
    // AÃ§Ä±klamayÄ± da isimlere gÃ¶re yapalÄ±m
    let desc = ""; 
    if(type === 'ganyan') desc = `KazanÄ±r: ${selectedNames[0]}`; 
    else if(type === 'ikili') desc = `SÄ±ralÄ± Ä°kili: ${selectedNames[0]} & ${selectedNames[1]}`; 
    else if(type === 'Ã¼Ã§lÃ¼') desc = `SÄ±ralÄ± ÃœÃ§lÃ¼: ${selectedNames[0]}, ${selectedNames[1]} & ${selectedNames[2]}`; 
    
    // Bahsi artÄ±k 'names' (isimler) dizisiyle kaydediyoruz
    activeBets.push({ names: selectedNames, stake: amt, type: type, desc: desc }); 
    
    updateUI(); 
    alert(`Bahis YatÄ±rÄ±ldÄ±: ${desc} - $${amt.toLocaleString()}`); 
}
    
    // --- PAZAR VE LÄ°DERLÄ°K TABLOSU ---
    window.refreshMarket = function() {
        marketHorses = []; 
        for(let i=0; i<8; i++) {
            marketHorses.push(createHorse(false)); 
        }
    }
    window.buyHorse = function(index) {
        if (myHorses.length >= 30) {
            alert("AhÄ±rÄ±nÄ±z dolu! (Kapasite: 30) LÃ¼tfen yer aÃ§Ä±n.");
            return;
        }
        let horseToBuy = marketHorses[index];
        if (!horseToBuy) {
            alert("Hata: At bulunamadÄ±.");
            return;
        }
        if (money < horseToBuy.price) {
            alert(`KasanÄ±zdaki para ($${money.toLocaleString()}) bu atÄ± almak iÃ§in yetersiz!`);
            return;
        }
        if (!confirm(`${horseToBuy.name} adlÄ± atÄ± $${horseToBuy.price.toLocaleString()} karÅŸÄ±lÄ±ÄŸÄ±nda satÄ±n almak istediÄŸinize emin misiniz?`)) {
            return;
        }
        spendMoney( horseToBuy.price); 
        horseToBuy.condition = 100;
        horseToBuy.history = [];
        horseToBuy.isInjured = false;
        horseToBuy.injuryWeeks = 0;
        if (!horseToBuy.sireName) horseToBuy.sireName = generateRandomParentName('AygÄ±r');
        if (!horseToBuy.damName) horseToBuy.damName = generateRandomParentName('KÄ±srak');
        myHorses.push(horseToBuy); 
        marketHorses.splice(index, 1); 
        alert(`${horseToBuy.name} baÅŸarÄ±yla ahÄ±rÄ±nÄ±za katÄ±ldÄ±!`);
        updateUI(); 
        showMarket(); 
        showStable(); 
    }
    
    window.showLeaderboard = function() {
        let trophies = [];
        myHorses.forEach(h => {
            if(h.history) {
                h.history.forEach(r => {
                    if(r.rank === 1) { 
                        // Ã–ZEL KUPALARIN KONTROLÃœ (YENÄ°)
                        if(r.isCustomCup) {
                             trophies.push({icon:"ğŸ†", name: r.raceName.replace("ğŸ† ", "").toUpperCase(), color:"#00ffff", horse: h.name});
                        }
                        // STANDART OYUN KUPALARI
                        else if(r.raceName.includes("GAZÄ°")) trophies.push({icon:"âšœï¸", name: "GAZÄ° KOÅUSU", color:"#f1c40f", horse: h.name});
                        else if(r.raceName.includes("DUBAI")) trophies.push({icon:"ğŸŒ", name: "DUBAI WORLD CUP", color:"#3498db", horse: h.name});
                        else if(r.raceName.includes("KENTUCKY")) trophies.push({icon:"ğŸ¦…", name: "KENTUCKY DERBY", color:"#e74c3c", horse: h.name});
                        else if(r.raceName.includes("ASCOT")) trophies.push({icon:"ğŸ‘‘", name: "ROYAL ASCOT", color:"#9b59b6", horse: h.name});
                        else if(r.raceName.includes("JAPAN")) trophies.push({icon:"ğŸ‡¯ğŸ‡µ", name: "JAPAN CUP", color:"#e67e22", horse: h.name});
                        else if(r.raceName.includes("DERBY")) trophies.push({icon:"ğŸ", name: "ULUSAL DERBÄ°", color:"#2ecc71", horse: h.name});
                    }
                });
            }
        });

        let museumHTML = `<div style="background:#222; padding:20px; border:4px solid #f1c40f; border-radius:10px; margin-bottom:30px; text-align:center;">
            <h2 style="color:#f1c40f; text-shadow:0 0 10px #f39c12; margin-top:0;">ğŸ† KUPA MÃœZESÄ° ğŸ†</h2>
            <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:15px;">`;
            
        if(trophies.length === 0) {
            museumHTML += `<p style="color:#777; font-style:italic;">HenÃ¼z bÃ¼yÃ¼k bir kupa kazanÄ±lmadÄ±... MÃ¼ze boÅŸ.</p>`;
        } else {
            trophies.forEach(t => {
                museumHTML += `<div style="background:#000; border:2px solid ${t.color}; padding:10px; width:120px; border-radius:8px; box-shadow: 0 0 15px ${t.color}40;">
                    <div style="font-size:40px;">${t.icon}</div>
                    <div style="font-size:11px; color:${t.color}; font-weight:bold; margin-top:5px;">${t.name}</div>
                    <div style="font-size:10px; color:#fff; margin-top:3px;">${t.horse}</div>
                </div>`;
            });
        }
        museumHTML += `</div></div>`;

        let allHorses = [...myHorses]; 
        allOpponents.forEach(opp => allHorses.push(opp));
        allHorses.forEach(h => {
            let wins = h.history ? h.history.filter(r => r.rank === 1).length : 0; 
            let totalEarnings = h.history ? h.history.reduce((a,b)=>a+b.earnings, 0) : 0;
            h.leaderScore = (h.rating || 40) + (wins * 5) + (totalEarnings / 10000); 
            h.isUser = myHorses.some(myH => myH.id === h.id);
        });
        
        let topHorses = allHorses.sort((a, b) => b.leaderScore - a.leaderScore).slice(0, 20);
        
        let tableHTML = `<h2 style="color:#3498db">ğŸŒ DÃœNYA SIRALAMASI (TOP 20)</h2>
        <table>
            <tr>
                <th>SÄ±ra</th><th>Ä°sim</th><th>HP (GÃ¼Ã§)</th><th>KazanÃ§ ($)</th><th>Skor</th><th>AhÄ±r</th>
            </tr>`;
            
        topHorses.forEach((h, index) => {
            let earnings = h.history ? h.history.reduce((a,b)=>a+b.earnings, 0) : 0; 
            let stableName = h.isUser ? "â­ SÄ°ZÄ°N AHIRINIZ" : (h.stable || "Bilinmeyen"); 
            let style = h.isUser ? 'style="color:#f1c40f; font-weight:bold; background:#333; border-left:4px solid #f1c40f;"' : '';
            let rankIcon = index === 0 ? 'ğŸ‘‘' : (index === 1 ? 'ğŸ¥ˆ' : (index === 2 ? 'ğŸ¥‰' : `${index+1}.`));
            
            tableHTML += `<tr ${style}><td>${rankIcon}</td><td>${h.name}</td><td><span class="rating-badge">${h.rating || 40}</span></td><td>$${earnings.toLocaleString()}</td><td>${h.leaderScore.toFixed(0)}</td><td>${stableName}</td></tr>`;
        });
        tableHTML += `</table>`;
        document.getElementById("mainDisplay").innerHTML = museumHTML + tableHTML;
    }

    // --- RAKÄ°P HARALAR (SCOUTING) MERKEZÄ° ---
    window.showScoutingCenter = function() {
        let html = `<h2 style="color:#3498db">ğŸ” RAKÄ°P HARALAR VE AT LÄ°STESÄ° (SCOUTING)</h2>
                    <p style="color:#7f8c8d;">DÃ¼nyanÄ±n en gÃ¼Ã§lÃ¼ ahÄ±rlarÄ±nÄ±n atlarÄ±nÄ± incele.</p>
                    <div class="stable-grid">`;
        
        let strongOpponents = [...allOpponents].sort((a, b) => (b.sprint + b.stamina) - (a.sprint + a.stamina)).slice(0, 20);

        if (strongOpponents.length === 0) {
            html += `<p style="grid-column: 1/-1; text-align:center; padding:20px; color:#e74c3c;">Rakip atlar bulunamadÄ±. LÃ¼tfen yeni sezonu bekleyin.</p>`;
        }

        strongOpponents.forEach(h => {
            let ratingBadge = `<span class="rating-badge" style="background:#3498db; color:#fff;">${h.rating || 40} HP</span>`;
            let imgFilter = h.colorFilter || 'none';
            let powerScore = (h.sprint + h.stamina).toFixed(0);

            html += `
            <div class="horse-card-new" style="border-color:#3498db; background: linear-gradient(145deg, #1a252f, #283747);">
                
                <div class="card-header">
                    <div class="horse-name-title" style="color:#3498db;">${h.name}</div>
                    <small style="color:#7f8c8d;">AhÄ±r: ${h.stable || 'Bilinmeyen'}</small>
                </div>

                <div class="card-body-flex">
                    <img src="resimler/at.gif" class="big-horse-img" style="filter:${imgFilter}; border-color:#3498db;">
                    <div class="stat-lines">
                        <div style="font-size:14px; font-weight:bold; margin-bottom:5px;">GÃ¼Ã§ Skoru: <span style="color:#fff;">${powerScore}</span></div>
                        <div>âš¡ HÄ±z: <span style="color:#fff;">${h.sprint.toFixed(0)}</span> <small style="color:#95a5a6;">/${h.maxSprint}</small></div>
                        <div>ğŸ›¡ï¸ GÃ¼Ã§: <span style="color:#fff;">${h.stamina.toFixed(0)}</span> <small style="color:#95a5a6;">/${h.maxStamina}</small></div>
                        <div style="margin-top:5px;">${ratingBadge}</div>
                    </div>
                </div>

                <div class="card-footer">
                    <button class="btn-action" style="width:100%; background:#2980b9;" 
                            onclick="showHorseCard('${h.id}')">
                        KARNESÄ°NÄ° Ä°NCELE ğŸ”¬
                    </button>
                </div>
            </div>`;
        });

        html += `</div>`;
        document.getElementById("mainDisplay").innerHTML = html;
    }

    // --- Ä°SÄ°M DÃœZENLEME FONKSÄ°YONU ---
    window.editHorse = function(horseId) {
        let h = myHorses.find(x => x.id == horseId);
        if (!h) return;

        let newName = prompt(`"${h.name}" iÃ§in yeni isim girin:`, h.name);
        if (newName === null || newName.trim() === "") return;
        h.name = newName.trim().toUpperCase();

        if(confirm("AtÄ±n rengini/gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ de deÄŸiÅŸtirmek ister misin? (Rastgele yeni bir renk atanÄ±r)")) {
            h.colorFilter = getHorseColorStyle();
            alert(`TamamdÄ±r! AtÄ±n yeni ismi: ${h.name}\nYeni bir stil uygulandÄ±!`);
        } else {
            alert(`Sadece isim gÃ¼ncellendi: ${h.name}`);
        }

        updateUI();
        showStable();
    }
    
    // --- OYUN BAÅLANGICI VE HABER BANDI ---
    const NEWS_ITEMS = [
        "SON DAKÄ°KA: Godolphin HarasÄ± yeni bir ÅŸampiyon transfer etti!",
        "HAVA DURUMU: YarÄ±n Ä°stanbul'da saÄŸanak yaÄŸÄ±ÅŸ bekleniyor, pist aÄŸÄ±rlaÅŸabilir.",
        "TRANSFER: ÃœnlÃ¼ jokey Halis K. serbest kaldÄ±, menajerler sÄ±rada.",
        "BAHÄ°S DÃœNYASI: Gazi KoÅŸusu iÃ§in favoriler belli olmaya baÅŸladÄ±.",
        "UYARI: AhÄ±r kapasiteniz dolmak Ã¼zere, yeni taylar iÃ§in yer aÃ§Ä±n.",
        "MAGAZÄ°N: Efsane at Bold Pilot'Ä±n torunu pistlere geri dÃ¶nÃ¼yor!",
        "BÄ°LGÄ°: Antrenman sahasÄ±nda zemin yenileme Ã§alÄ±ÅŸmalarÄ± tamamlandÄ±.",
        "ÅAMPÄ°YONLUK: Bu sezonun en Ã§ok kazandÄ±ran harasÄ± aÃ§Ä±klandÄ±!"
    ];

    function updateNewsTicker() {
        const tickerEl = document.getElementById("neonTicker");
        if(!tickerEl) return;
        let displayNews = "";
        for(let i = 0; i < 3; i++) {
            let randomNews = NEWS_ITEMS[Math.floor(Math.random() * NEWS_ITEMS.length)];
            displayNews += `<div class="ticker-item">+++ ${randomNews} +++</div>`;
        }
        if(myHorses.length > 0) {
            let starHorse = myHorses.sort((a,b) => b.rating - a.rating)[0];
            displayNews += `<div class="ticker-item" style="color:#f1c40f; text-shadow:0 0 10px #f1c40f">â˜… SÄ°ZÄ°N YILDIZINIZ: ${starHorse.name} (HP: ${starHorse.rating})</div>`;
        }
        tickerEl.innerHTML = displayNews;
    }

    
    
    // --- [YENÄ°] V33 ELÄ°T MÃœZAYEDE VE AÃ‡IK ARTIRMA SÄ°STEMÄ° ---

    let auctionInterval;
    let auctionData = { horse: null, currentBid: 0, minBid: 0, leadingBidder: 'Siz', timer: 3 };
    let aiBiddersList = [];

    // Ã–ZEL CANAVAR AT ÃœRETÄ°CÄ°SÄ° (Sadece burasÄ± kullanacak)
    function createAuctionMonster() {
        const elitePrefixes = ["Royal", "Imperial", "Grand", "Crown", "Majestic", "Supreme", "Eternal", "Golden"];
        const eliteSuffixes = ["Emperor", "Sultan", "King", "Legend", "Pegasus", "Titan", "Phantom", "Dragon"];
        let name = pick(elitePrefixes) + " " + pick(eliteSuffixes);

        // GÃ¼Ã§ler: 195-220 arasÄ± (Standart atlarÄ±n Ã§ok Ã¼stÃ¼nde)
        let sprint = rand(195, 220); 
        let stamina = rand(195, 220);
        let maxSprint = sprint + rand(10, 30);
        let maxStamina = stamina + rand(10, 30);

        const eliteFilters = [
            'sepia(1) saturate(5) brightness(1.2) hue-rotate(10deg)', // AltÄ±n
            'invert(1) hue-rotate(180deg)', // Mistik Beyaz
            'hue-rotate(250deg) saturate(3) brightness(0.7)', // Mor
            'grayscale(100%) brightness(1.5) contrast(1.2)' // GÃ¼mÃ¼ÅŸ
        ];

        return {
            id: Date.now() + Math.random(),
            name: name,
            age: 2, 
            gender: Math.random() > 0.5 ? "AygÄ±r" : "KÄ±srak",
            sprint: sprint,
            stamina: stamina,
            maxSprint: maxSprint,
            maxStamina: maxStamina,
            surface: Math.random() > 0.5 ? "Ã‡im" : "Kum",
            price: 20000000, // Taban Fiyat (Sembolik)
            isElite: true,
            condition: 100,
            history: [],
            colorFilter: pick(eliteFilters),
            rating: rand(110, 130), 
            trait: { id: 'hirsli', name: 'ğŸ˜¡ HÄ±rslÄ±', desc: 'Kazanmak iÃ§in doÄŸmuÅŸ.', type: 'pos' },
            isInjured: false,
            injuryWeeks: 0,
            sireName: "Efsane " + pick(["Bold Pilot", "Secretariat", "Frankel"]),
            damName: "Lady " + pick(["Diana", "Victoria", "Elizabeth"])
        };
    }

   window.openAuctionModal = function() {
    if(auctionInterval) clearInterval(auctionInterval);
    
    // En iyi atÄ± bul
    let myBest = (myHorses.length > 0) ? Math.max(...myHorses.map(at => at.sprint)) : 150;
    
    // 1. ADIM: ATIN Ã–ZELLÄ°KLERÄ°NÄ° OLUÅTUR
    let h = createAuctionMonster(); 
    
    // GÃ¼Ã§ Dengelemesi
    if(h.sprint < myBest) {
        h.sprint = Math.floor(myBest * (1.1 + Math.random() * 0.1)); 
        h.stamina = Math.floor(myBest * (1.1 + Math.random() * 0.1));
        h.maxSprint = h.sprint + 30;
        h.maxStamina = h.stamina + 30;
    }
    h.price = Math.floor((h.sprint + h.stamina) * 75000);

    // --- 2. ADIM: KESÄ°N Ã‡Ã–ZÃœM BURASI ---
    // DiÄŸer fonksiyona gÃ¼venmiyoruz, videoyu BURADA zorla seÃ§iyoruz.
    const videoListesi = ['at_doru.mp4', 'at_kir.mp4', 'at_yagiz.mp4'];
    // Rastgele birini seÃ§
    let sansliVideo = videoListesi[Math.floor(Math.random() * videoListesi.length)];
    
    // AtÄ±n video Ã¶zelliÄŸine bunu ata
    h.auctionVideo = sansliVideo;
    // -----------------------------------
    
    // SÃœRE 15 SANÄ°YE
    auctionData = { horse: h, currentBid: h.price, minBid: h.price, leadingBidder: 'Kimse', timer: 15 };
    aiBiddersList = shuffle(["Godolphin", "Coolmore", "Juddmonte", "Aga Khan", "Katar Emiri", "Japon Holding"]); 

    // --- HTML ---
    let htmlContent = `
        <div class="auction-container">
            <h1>ğŸ† ELÄ°T MÃœZAYEDE SALONU ğŸ†</h1>
            <div id="auctionTimerDisplay" style="text-align:center; color:#f1c40f; font-size:22px; margin-bottom:15px; letter-spacing:2px; font-weight:bold; animation: pulse 1s infinite;">
                BAÅLIYOR... (15 Sn)
            </div>

            <div class="auction-horse-card" style="flex-direction: column; text-align: center; background: rgba(0,0,0,0.3);">
                
                <video id="auctionVideoElement" 
                       src="${h.auctionVideo}" 
                       autoplay loop muted playsinline 
                       onerror="alert('HALA HATA VAR! Dosya: ' + this.src + ' bulunamadÄ±.')"
                       style="width: 100%; max-width: 600px; border-radius: 15px; border: 3px solid #f1c40f; box-shadow: 0 0 30px rgba(241, 196, 15, 0.5); background-color: #000;">
                    TarayÄ±cÄ±nÄ±z video etiketini desteklemiyor.
                </video>
                
                <div style="font-size:10px; color:#777; margin-top:5px;">
                    OynatÄ±lan: <strong>${h.auctionVideo}</strong>
                </div>

                <div class="auction-horse-info" style="margin-top: 15px; width: 100%;">
                    <h3 style="font-size: 36px; text-shadow: 0 0 10px #000;">${h.name.toUpperCase()}</h3>
                    <div style="margin-bottom:10px; display:flex; justify-content:center; gap:10px;">
                        <span class="stat-pill">âš¡ HIZ: ${h.sprint.toFixed(0)}</span>
                        <span class="stat-pill">ğŸ›¡ï¸ GÃœÃ‡: ${h.stamina.toFixed(0)}</span>
                        <span class="stat-pill" style="border-color:#e74c3c; color:#e74c3c;">${h.gender}</span>
                    </div>
                    <small style="color:#aaa;">Soy HattÄ±: ${h.sireName} x ${h.damName}</small>
                </div>
            </div>

            <div class="bid-area">
                <div class="bid-info-box">
                    <span class="bid-label">GÃœNCEL TEKLÄ°F</span>
                    <div id="currentBid" class="bid-value">$${h.price.toLocaleString()}</div>
                    <div id="leadingBidder" class="bid-leader">---</div>
                </div>
                <div class="bid-info-box">
                    <span class="bid-label">SÄ°ZÄ°N KASANIZ</span>
                    <div style="font-size:24px; color:#fff; margin-top:10px;">$${money.toLocaleString()}</div>
                </div>
            </div>

            <div class="bid-controls">
                <input type="number" id="playerBidInput" class="bid-input" value="${h.price + 100000}">
                <button class="bid-btn" onclick="placePlayerBid()">ğŸ”¥ TEKLÄ°F VER</button>
                <button class="bid-btn" style="background: #333; color:#fff; font-size:14px;" onclick="skipAuction()">PAS GEÃ‡</button>
            </div>
            
            <div style="margin-top:20px; font-size:12px; color:#aaa;">CANLI AKIÅ:</div>
            <div id="log">
                <div>> MÃ¼zayede sistemi baÅŸlatÄ±ldÄ±...</div>
                <div style="color:#f1c40f">> AÃ§Ä±lÄ±ÅŸ FiyatÄ±: $${h.price.toLocaleString()}</div>
            </div>

            <div id="result" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); text-align:center; padding-top:100px; z-index:100;"></div>
        </div>
    `;

    document.getElementById("auctionModal").innerHTML = htmlContent;
    document.getElementById("auctionModal").style.display = 'flex';
    
    // Otomatik oynatmayÄ± tetikle
    setTimeout(() => {
        let v = document.getElementById('auctionVideoElement');
        if(v) v.play().catch(e => console.log(e));
    }, 500);

    startAuction();
}

    window.closeAuctionModal = function() {
        clearInterval(auctionInterval);
        document.getElementById("auctionModal").style.display = 'none';
        showStable();
    }

    function startAuction() {
        if(auctionInterval) clearInterval(auctionInterval);
        auctionInterval = setInterval(auctionFlow, 1000);
    }

    function generateAuctionHorseCard(h) {
        let imgFilter = h.colorFilter || 'none';
        let traitHtml = h.trait ? `<p style="color:${h.trait.type==='pos'?'#2ecc71':'#e74c3c'}; font-size:12px;">â˜… ${h.trait.name}</p>` : '';
        return `
            <div style="display:flex; gap:20px; background:#1a252f; padding:15px; border:2px solid #f1c40f; border-radius:8px; margin-bottom:15px; box-shadow:0 0 20px rgba(241,196,15,0.3);">
                <img src="resimler/at.gif" style="filter:${imgFilter}; width:100px; height:100px; object-fit:contain; border-radius:50%; border:3px solid #f1c40f;">
                <div>
                    <h3 style="color:#f1c40f; margin-top:0; text-shadow:0 0 5px #d35400;">${h.name.toUpperCase()} (${h.age}Y)</h3>
                    <p style="font-size:14px;">âš¡ HÄ±z: <strong>${h.sprint.toFixed(0)}</strong> / ${h.maxSprint}</p>
                    <p style="font-size:14px;">ğŸ›¡ï¸ GÃ¼Ã§: <strong>${h.stamina.toFixed(0)}</strong> / ${h.maxStamina}</p>
                    ${traitHtml}
                </div>
            </div>
        `;
    }

    function auctionFlow() {
        if (auctionData.timer > 0) {
            auctionData.timer--;
            document.getElementById("auctionTimerDisplay").innerHTML = `3. VURUÅ Ä°Ã‡Ä°N GERÄ° SAYIM: ${auctionData.timer}`;
        } else {
            let aiBidded = tryAiBid();
            
            if (auctionData.leadingBidder === 'Siz') {
                if (auctionData.timer === -1) { 
                    endAuction(true);
                    return;
                }
                auctionData.timer = -1; 
                document.getElementById("auctionTimerDisplay").innerHTML = `VURUÅ: 1!`;
            } else if (aiBidded) {
                auctionData.timer = 3;
                document.getElementById("auctionTimerDisplay").innerHTML = `3. VURUÅ Ä°Ã‡Ä°N GERÄ° SAYIM: 3`;
            } else {
                if (auctionData.leadingBidder !== 'Kimse') {
                    endAuction(false);
                    return;
                } else {
                    endAuction(null); 
                    return;
                }
            }
        }
    }

    window.placePlayerBid = function() {
        const bidInput = document.getElementById("playerBidInput");
        let bid = parseInt(bidInput.value);
        let minValidBid = auctionData.currentBid + 100000; // Min 100k artÄ±ÅŸ

        if (isNaN(bid) || bid < minValidBid) {
            alert(`Minimum $${minValidBid.toLocaleString()} teklif etmelisiniz!`);
            return;
        }
        if (bid > money) {
            alert("KasanÄ±zda yeterli para yok!");
            return;
        }

        auctionData.currentBid = bid;
        auctionData.leadingBidder = 'Siz';
        auctionData.timer = 3; 

        document.getElementById("currentBid").innerText = bid.toLocaleString();
        document.getElementById("leadingBidder").innerText = 'Siz';
        document.getElementById("auctionTimerDisplay").innerHTML = `3. VURUÅ Ä°Ã‡Ä°N GERÄ° SAYIM: 3`;
        
        let logBox = document.getElementById("log");
        logBox.innerHTML += `<div style="color:#3498db; font-weight:bold; font-size:15px;">ğŸ’ SÄ°Z: $${bid.toLocaleString()}</div>`;
        logBox.scrollTop = logBox.scrollHeight;
        
        document.getElementById("playerBidInput").value = bid + 100000;
    }

    function tryAiBid() {
        // AI Teklif Limiti: 100 Milyon $
        if (auctionData.leadingBidder === 'Siz' && auctionData.currentBid < 100000000 && Math.random() < 0.7) { 
            let aiName = pick(aiBiddersList);
            let currentBid = auctionData.currentBid;
            
            // Zengin ArtÄ±ÅŸÄ±: 500k - 2.5M arasÄ±
            let raise = rand(500000, 2500000); 
            raise = Math.ceil(raise / 100000) * 100000; 
            let aiBid = currentBid + raise;

            auctionData.currentBid = aiBid;
            auctionData.leadingBidder = aiName;
            
            document.getElementById("currentBid").innerText = aiBid.toLocaleString();
            document.getElementById("leadingBidder").innerText = aiName;
            
            let logBox = document.getElementById("log");
            logBox.innerHTML += `<div style="color:#e74c3c; font-weight:bold; animation: fadeIn 0.5s;">ğŸ”¥ ${aiName}: $${aiBid.toLocaleString()}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
            
            document.getElementById("playerBidInput").value = aiBid + 500000;
            return true;
        }
        return false;
    }

    function endAuction(playerWon) {
        clearInterval(auctionInterval);
        const resultDiv = document.getElementById("result");
        const logDiv = document.getElementById("log");
        const horse = auctionData.horse;
        
        let finalMessage = "";

        if (playerWon) {
            if(myHorses.length >= 30) {
                finalMessage = `<h2 style="color:#e74c3c">AHIR DOLU!</h2><p>AhÄ±rÄ±nÄ±zda yer olmadÄ±ÄŸÄ± iÃ§in iÅŸlem iptal edildi.</p>`;
            } else {
                spendMoney(auctionData.currentBid); 
                horse.price = auctionData.currentBid;
                myHorses.push(horse);
                updateUI();
                finalMessage = `<h2 style="color:#2ecc71">TEBRÄ°KLER!</h2><p>${horse.name} artÄ±k sizin! ($${auctionData.currentBid.toLocaleString()})</p>`;
            }
        } else if (playerWon === false) {
            finalMessage = `<h2 style="color:#e74c3c">SATILDI!</h2><p>At, ${auctionData.leadingBidder} tarafÄ±ndan $${auctionData.currentBid.toLocaleString()} fiyatla alÄ±ndÄ±.</p>`;
        } else { 
             finalMessage = `<h2 style="color:#f1c40f">Ä°PTAL</h2><p>Teklif gelmediÄŸi iÃ§in satÄ±ÅŸ iptal.</p>`;
        }

        logDiv.style.display = 'none';
        resultDiv.innerHTML = finalMessage + `<button class="bid-btn" style="background:#00ffff; color: #000; margin-top: 15px;" onclick="closeAuctionModal()">DEVAM ET</button>`;
        resultDiv.style.display = 'block';
    }

    window.skipAuction = function() {
        if(auctionData.leadingBidder === 'Kimse') endAuction(null); 
        else if (auctionData.leadingBidder !== 'Siz') endAuction(false); 
        else {
            tryAiBid();
            if(auctionData.leadingBidder === 'Siz') endAuction(true);
        }
    }

    window.applyUploadedImage = function() {
        const input = document.getElementById('imageUpload');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                if(auctionData.horse) {
                    auctionData.horse.customImage = e.target.result;
                    document.getElementById("horseDisplay").innerHTML = generateAuctionHorseCard(auctionData.horse);
                    alert("GÃ¶rsel eklendi!");
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    window.applyUploadedImage = function() {
        const input = document.getElementById('imageUpload');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                if(auctionData.horse) {
                    auctionData.horse.customImage = e.target.result;
                    document.getElementById("horseDisplay").innerHTML = generateAuctionHorseCard(auctionData.horse);
                    alert("GÃ¶rsel uygulandÄ±! Bu atÄ± alÄ±rsanÄ±z yeni gÃ¶rseli kullanacaktÄ±r.");
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    // --- YARIÅ VE HAFTA DÃ–NGÃœSÃœ (EKSÄ°K PARÃ‡ALAR BURADA) ---

    window.startRaceAnimation = function() {
    document.getElementById("modalOverlay").style.display = "none";
    
    // LogolarÄ± ve Renkleri TanÄ±mlayalÄ±m
    const sponsors = [
        { name: "PEGASUS", color: "#005392", textColor: "#fff" },
        { name: "KOÃ‡", color: "#e30613", textColor: "#fff" },
        { name: "THY", color: "#231f20", textColor: "#fff" },
        { name: "ÃœLKER", color: "#d01c22", textColor: "#fff" },
        { name: "VESTEL", color: "#000", textColor: "#fff" },
        { name: "TRENDYOL", color: "#f27a1a", textColor: "#fff" }
    ];
    
    // Senin aktif sponsorun varsa en baÅŸa ekle
    if(stableSponsor && stableSponsor.name) {
        sponsors.unshift({ name: stableSponsor.name.toUpperCase(), color: "#2ecc71", textColor: "#000" });
    }

    // HTML oluÅŸturma
    let adHtml = '<div class="ad-boards-container">';
    sponsors.forEach(s => {
        adHtml += `
            <div class="ad-board" style="background-color: ${s.color}; color: ${s.textColor}; border-color: rgba(255,255,255,0.3);">
                <span>${s.name}</span>
            </div>`;
    });
    adHtml += '</div>';

    const race = activeRace;
    // window.startRaceAnimation Ä°Ã‡Ä°NDEKÄ° KISIM:
    
    let html = `
        <h2 style="color:#f1c40f; text-align:center;">ğŸ YARIÅ BAÅLIYOR: ${race.name}</h2>
        
        <div id="raceTrack" class="race-track-container">
            <div id="raceCommentary" style="position:absolute; top:40%; left:0; width:100%; text-align:center; color:#fff; font-size:20px; z-index:20; text-shadow: 2px 2px 4px #000;">
                Spiker: Atlar start makinesine girdi...
            </div>
            ${adHtml} 
        </div> 
        <div class="tribune-panel"></div>
        `;
    
    document.getElementById("mainDisplay").innerHTML = html;
    setTimeout(simulateRace, 3000); 
}

    window.checkWeekReport = function() {
        let totalRaces = activeRaces.length;
        let registeredRaces = activeRaces.filter(r => r.registeredUserHorses && r.registeredUserHorses.length > 0).length;

        if (registeredRaces > 0) {
            if (!confirm(`Bu hafta ${registeredRaces} yarÄ±ÅŸa kayÄ±tlÄ± atÄ±nÄ±z var. HaftayÄ± simÃ¼le edip yarÄ±ÅŸ sonuÃ§larÄ±nÄ± gÃ¶rmek ister misiniz?`)) {
                return;
            }
        }
        processWeek();
    }


    function simulateRace() {
        const race = activeRace;
        if (!race || !race.runners || race.runners.length === 0) return;
        
        race.runners.forEach((r, idx) => { if (r.originalLane === undefined) r.originalLane = idx + 1; });

        let injuryReports = [];

        race.runners.forEach(r => {
            let h = r.horse;
            let j = r.jockey;
            
            // SAKATLIK RÄ°SKÄ° HESABI
            let injuryRisk = 0.01; 
            if (h.condition < 40) injuryRisk += 0.05;
            if (race.weather === 'Ã‡amurlu') injuryRisk += 0.03;
            if (r.tactic === 'agresif') injuryRisk += 0.02;
            if (r.isUser && facilities.blacksmith) injuryRisk -= (facilities.blacksmith.level * 0.005);

            // SakatlÄ±k KontrolÃ¼
            if (r.isUser && Math.random() < injuryRisk && !h.isElite) {
                let injury = applyInjury(h);
                r.isDNF = true; // YarÄ±ÅŸÄ± bitiremedi
                r.score = -1; 
                injuryReports.push(`ğŸš‘ ${h.name} yarÄ±ÅŸta sakatlandÄ±: ${injury.name}!`);
            } else {
                r.isDNF = false;
                let surfaceBonus = (h.surface === race.surface) ? 1.1 : 1.0; 
                let weatherMultiplier = (race.weather === 'YaÄŸmurlu' || race.weather === 'Ã‡amurlu') ? (0.8 + (j.rainSkill / 250)) : 1;
                let traitBonus = (h.trait && h.trait.id === 'hirsli') ? 1.05 : 1;
                let sprintFactor = (r.tactic === 'agresif') ? 1.1 : (r.tactic === 'bekle' ? 0.95 : 1);
                let staminaFactor = (r.tactic === 'bekle') ? 1.1 : (r.tactic === 'agresif' ? 0.95 : 1);
                let distanceRatio = (race.dist - 1200) / 1200; 
                let sprintWeight = 1.5 - (0.7 * distanceRatio); 
                let staminaWeight = 0.5 + (0.7 * distanceRatio); 
                let avgJockeySkill = (j.paceControl + j.sprintFinish + j.whipUsage) / 3;
                let jockeyMultiplier = (avgJockeySkill / 80) + 0.1; 
                let totalScore = ((h.sprint * sprintWeight * sprintFactor) + (h.stamina * staminaWeight * staminaFactor)) / 2;
                r.score = totalScore * jockeyMultiplier * surfaceBonus * weatherMultiplier * traitBonus * (rand(95, 105) / 100); 
            }
        });

        race.runners.sort((a, b) => b.score - a.score);

        const bestScore = race.runners[0].score;
        const worstScore = race.runners.filter(r => !r.isDNF).length > 0 ? race.runners.filter(r => !r.isDNF).pop().score : 10;
        const replayId = 'replay_' + Date.now();
        
        const raceResults = race.runners.map((r, index) => {
            r.rank = r.isDNF ? 99 : index + 1; 
            let earnings = 0;
            if (!r.isDNF) {
                if (index === 0) earnings = race.prize * 0.60;
                else if (index === 1) earnings = race.prize * 0.20;
                else if (index === 2) earnings = race.prize * 0.10;
                else if (index === 3) earnings = race.prize * 0.05;
            }
            r.earnings = Math.floor(earnings);
            
            if (r.isUser) {
                if(isNaN(money)) money = 0;
                if (!r.isDNF) {
                    addMoney(r.earnings);
                    let jockeyObj = hiredJockeys.find(j => j.id === r.jockey.id) || allJockeys.find(j => j.id === r.jockey.id);
                    if(jockeyObj) spendMoney((r.earnings * JOKEY_COMMISSION[jockeyObj.type]));
                    
                    let baseTime = race.dist / 16.5; 
                    let finishTime = baseTime + (r.rank * 0.3) + (Math.random() * 0.5);
                    let mm = Math.floor(finishTime / 60);
                    let ss = Math.floor(finishTime % 60);
                    let ms = Math.floor((finishTime - Math.floor(finishTime)) * 100);
                    let degreeStr = `${mm}.${ss < 10 ? '0' : ''}${ss}.${ms < 10 ? '0' : ''}${ms}`;
                    
                    // GÃ¼ncellenmiÅŸ satÄ±r:
r.horse.history.push({ 
    raceName: race.name, 
    dist: race.dist, 
    surface: race.surface, 
    degree: degreeStr, 
    rank: r.rank, 
    earnings: r.earnings, 
    week: week, 
    jockey: r.jockey.name, 
    replayId: replayId,
    isCustomCup: race.isCustomCup // <--- YENÄ° EKLENEN KISIM BU
});
                    
                    let ratingChange = r.rank === 1 ? 5 : (r.rank <= 3 ? 2 : (r.rank > 5 ? -2 : 0));
                    r.horse.rating = Math.max(40, r.horse.rating + ratingChange);
                    r.horse.condition = Math.max(10, r.horse.condition - rand(20, 40));
                } else {
                    r.horse.history.push({ raceName: race.name, dist: race.dist, surface: race.surface, degree: "DNF", rank: "SakatlandÄ±", earnings: 0, week: week, jockey: r.jockey.name, replayId: replayId });
                    r.horse.condition = 5; 
                    r.horse.rating = Math.max(30, r.horse.rating - 5);
                }
            }
            
            let duration = 12;
            if (!r.isDNF) {
                let scoreRange = bestScore - worstScore;
                let normalized = scoreRange > 0 ? (bestScore - r.score) / scoreRange : 0;
                duration = 12 + (normalized * 5);
            } else { duration = 30; }

            return { name: r.horse.name, rank: r.rank, earnings: r.earnings, isUser: r.isUser, colorFilter: r.horse.colorFilter, lane: r.originalLane, duration: duration, isDNF: r.isDNF };
        });
        
        raceReplays[replayId] = { raceName: race.name, dist: race.dist, weather: race.weather, runners: raceResults };
        if(injuryReports.length > 0) { weeklyLogs.push(...injuryReports); alert(injuryReports.join("\n")); }
        showRaceResults(raceResults, race.name);
    }

    function processWeek() {
    // --- FÄ°NANSAL GÃœNCELLEMELER ---
    if(bankLoan > 0) {
        let interest = Math.floor(bankLoan * 0.02);
        bankLoan += interest;
        weeklyLogs.push(`ğŸ¦ [BANKA] Borcunuza $${interest.toLocaleString()} faiz iÅŸledi. Toplam BorÃ§: $${bankLoan.toLocaleString()}`);
    }

    marketRates.gold = Math.floor(marketRates.gold * (1 + rand(-3, 4)/100)); 
    marketRates.forex = Math.floor(marketRates.forex * (1 + rand(-5, 6)/100));
    marketRates.stocks = Math.floor(marketRates.stocks * (1 + rand(-10, 12)/100));

    if(stableSponsor.weeksLeft > 0) {
        addMoney(stableSponsor.weeklyIncome);
        stableSponsor.weeksLeft--;
        weeklyLogs.push(`ğŸ“¢ [SPONSOR] ${stableSponsor.name} haftalÄ±k Ã¶demeyi yaptÄ±: +$${stableSponsor.weeklyIncome.toLocaleString()}`);
        if(stableSponsor.weeksLeft === 0) {
            stableSponsor.name = null;
            weeklyLogs.push(`âš ï¸ [SPONSOR] Sponsorluk anlaÅŸmasÄ± sona erdi! Yeni sponsor bulun.`);
        }
    }

    if (myHippodrome) {
        let actualAudience = Math.floor(myHippodrome.capacity * (myHippodrome.popularity / 100) * (rand(80, 120)/100));
        let gateIncome = actualAudience * myHippodrome.ticketPrice;
        let foodIncome = actualAudience * (myHippodrome.restaurantLevel * 20);
        let totalIncome = gateIncome + foodIncome;
        addMoney(totalIncome);
        weeklyLogs.push(`ğŸŸï¸ [HÄ°PODROM] ${myHippodrome.name}: ${actualAudience.toLocaleString()} seyirci geldi. Toplam HasÄ±lat: +$${totalIncome.toLocaleString()}`);
    }

    // --- 1. YAÅLANMA VE DURUM KONTROLÃœ (DÃœZELTÄ°LMÄ°Å) ---
    myHorses.forEach(h => {
        
            h.age = Math.floor(h.age); // KÃ¼surat varsa temizler
        

        h.condition = Math.min(100, h.condition + rand(5, 15) * facilities.clinic.level);
        if (h.isInjured) h.injuryWeeks--;
        if (h.injuryWeeks <= 0) h.isInjured = false;
        
        let lastRace = h.history.find(r => r.week === week - 1);
        if (lastRace) {
            weeklyLogs.push(`[YARIÅ] ${h.name}: ${lastRace.raceName} koÅŸusunda ${lastRace.rank}. oldu. KazanÃ§: $${lastRace.earnings.toLocaleString()}.`);
        }
    });

    // --- 2. OTOMATÄ°K ANTRENMAN ---
    if (hiredTrainer) {
        if (money < TRAINER_SALARY) { hiredTrainer = false; weeklyLogs.push("MaaÅŸ Ã¶denemediÄŸi iÃ§in AntrenÃ¶r iÅŸten ayrÄ±ldÄ±!"); }
        else {
            spendMoney(TRAINER_SALARY);
            myHorses.filter(h => !h.isInjured && h.condition >= 50).forEach(h => {
                if (h.sprint < h.maxSprint || h.stamina < h.maxStamina) {
                    let gain = (facilities.training.level * 0.5) + 0.5;
                    h.sprint = Math.min(h.maxSprint, h.sprint + gain);
                    h.stamina = Math.min(h.maxStamina, h.stamina + gain);
                    h.condition = Math.max(10, h.condition - rand(15, 25));
                    weeklyLogs.push(`[ANTRENÃ–R] ${h.name} baÅŸarÄ±yla antrenman yaptÄ±.`);
                }
            });
        }
    }
    
    // --- 3. JOKEY SÃ–ZLEÅMELERÄ° ---
    hiredJockeys.forEach(j => {
        j.contractWeeks--;
        spendMoney(JOKEY_BASE_SALARY / SEASON_LENGTH); 
        if (j.sponsor) addMoney(100); 

        if (j.trainingWeeks > 0) {
            j.trainingWeeks--;
            if (j.trainingWeeks === 0) {
                j[j.trainingTargetKey] = Math.min(120, j[j.trainingTargetKey] + j.trainingTarget);
                j.skill = Math.round((j.paceControl + j.sprintFinish + j.whipUsage) / 3);
            }
        }
    });
    hiredJockeys = hiredJockeys.filter(j => j.contractWeeks > 0);
    
    // --- 4. HAFTA Ä°LERLEMESÄ° ---
    if (week >= SEASON_LENGTH) {
        endSeasonGala();
        return; 
    } else {
        week++;
    }

    generateWeeklyRaces();
    autoRegisterHorses(); 
    refreshMarket(); 
    updateUI(); 
    generateNewsContent();
    weeklyLogs = []; 
}

    // --- YENÄ°LENMÄ°Å SONUÃ‡ VE KUTLAMA SÄ°STEMÄ° ---
    window.showRaceResults = function(results, raceName) {
        // 1. ANÄ°MASYON KISMI (Pistteki atlarÄ±n hareketi)
        const track = document.getElementById("raceTrack");
        if (track) {
            track.innerHTML = '';
            if (activeRace.weather === 'YaÄŸmurlu') track.innerHTML += `<div class="rain-overlay"></div>`;
            
            let visualRunners = [...results].sort((a,b) => a.lane - b.lane);
            
            visualRunners.forEach(r => { 
                let textColor = r.isUser ? '#f1c40f' : '#fff'; 
                let laneHtml = `
                    <div class="lane">
                        <div class="horse-container" id="horse_lane_${r.lane}" style="transition: left ${r.duration.toFixed(2)}s linear;">
                            <img src="resimler/at.gif" class="horse-gif" style="filter:${r.colorFilter}">
                            <span style="font-size:12px; color:${textColor}; margin-left:5px;">${r.name}</span>
                        </div>
                        <div class="finish-line"></div>
                    </div>`;
                track.innerHTML += laneHtml;
            });

            setTimeout(() => {

    // --- SESÄ° BURAYA EKLÄ°YORUZ ---
    if(typeof sesNal !== 'undefined') {
        sesNal.currentTime = 0; 
        sesNal.play().catch(e => console.log("Ses hatasÄ±:", e));
    }
    // -----------------------------

    visualRunners.forEach(r => {
        let el = document.getElementById(`horse_lane_${r.lane}`);
        if (el) el.style.left = "85%";
    });
}, 100); 
        }
        
        // 2. KAZANANI BUL VE KUTLAMA YAP
        const longestDuration = results.reduce((max, r) => Math.max(max, r.duration), 0);
        
        // YarÄ±ÅŸ bittiÄŸinde (TÃ¼m atlar varÄ±nca) Ã§alÄ±ÅŸacak kÄ±sÄ±m:
        setTimeout(() => {
            
            // --- Ä°ÅTE BURASI! SESÄ° BURADA SUSTURUYORUZ ---
            if(typeof sesNal !== 'undefined') {
                sesNal.pause();       // Sesi durdur
                sesNal.currentTime = 0; // BaÅŸa sar
            }
            // ---------------------------------------------

            // KazananÄ± bul (SÄ±ralamasÄ± 1 olan)
            let winner = results.find(r => r.rank === 1);
            
            // ÅAMPÄ°YONLUK EKRANINI AÃ‡ (Konfeti patlat!)
            showChampionCelebration(winner);

            // 4 saniye sonra otomatik olarak normal tabloyu hazÄ±rla
            // (Ama kullanÄ±cÄ± tÄ±klayÄ±p kapatÄ±rsa daha erken de gÃ¶rebilir)
            window.pendingResults = results; // SonuÃ§larÄ± hafÄ±zaya al
            window.pendingRaceName = raceName;
            
        }, longestDuration * 1000 + 1000); 
    }

    // --- YENÄ° EKLENEN KUTLAMA FONKSÄ°YONLARI ---
    window.showChampionCelebration = function(winner) {
        let overlay = document.getElementById("championOverlay");
        document.getElementById("champHorseName").innerText = winner.name;
        document.getElementById("champPrize").innerText = "KAZANÃ‡: $" + winner.earnings.toLocaleString();
        document.getElementById("champHorseImg").style.filter = winner.colorFilter || 'none';
        
        overlay.style.display = "flex";
        startConfetti(); // Konfetiyi baÅŸlat
    }

    window.closeChampionModal = function() {
        document.getElementById("championOverlay").style.display = "none";
        stopConfetti(); // Konfetiyi durdur
        
        // Åampiyonluk ekranÄ± kapanÄ±nca NORMAL TABLOYU gÃ¶ster
        if(window.pendingResults) {
            showFinalTable(window.pendingResults, window.pendingRaceName);
            window.pendingResults = null; 
        }
    }

    // --- ESKÄ° TABLO GÃ–STERÄ°MÄ° (ArtÄ±k buraya taÅŸÄ±ndÄ±) ---
    window.showFinalTable = function(results, raceName) {
        let html = `<button class="close-btn" onclick="document.getElementById('modalOverlay').style.display='none'">X</button><h2 style="color:#f1c40f; text-align:center;">ğŸ† SONUÃ‡LAR: ${raceName}</h2>`;
        html += `<table><tr><th>SÄ±ra</th><th>At</th><th>Derece</th><th>KazanÃ§</th><th>Tekrar</th></tr>`;
        
        results.sort((a, b) => a.rank - b.rank).forEach(r => {
            let style = r.isUser ? 'style="color:#f1c40f; font-weight:bold;"' : '';
            let icon = r.rank === 1 ? 'ğŸ‘‘' : `${r.rank}.`;
            // Dereceyi bulmak iÃ§in geÃ§miÅŸe bakÄ±yoruz (Ã§Ã¼nkÃ¼ results iÃ§inde hesaplanmadÄ±ysa)
            let degree = "---";
            if(r.isUser) {
                // Kendi atÄ±mÄ±zsa geÃ§miÅŸten Ã§ek
                let lastRec = myHorses.find(h=>h.name===r.name).history.slice(-1)[0];
                if(lastRec) degree = lastRec.degree;
            } else {
                // Rakipse rastgele bir derece uydur (gÃ¶rsel iÃ§in)
                degree = (1.10 + (Math.random()*0.1)).toFixed(2);
            }

            html += `<tr ${style}><td>${icon}</td><td>${r.name}</td><td>${degree}</td><td>$${r.earnings.toLocaleString()}</td><td><button class="btn-action" onclick="playReplay('${Object.keys(raceReplays).pop()}')">ğŸ“º</button></td></tr>`;
        });
        html += `</table>`;

        // BAHÄ°S SONUÃ‡LARI
        let betReport = `<h3 style="color:#2ecc71; margin-top:20px;">ğŸ’° BAHÄ°S SONUÃ‡LARI</h3>`;
        if (activeBets.length > 0) {
            activeBets.forEach(bet => {
                let won = false;
                let winMultiplier = 1;
                
                if (bet.type === 'ganyan') {
                    let winner = results.find(r => r.rank === 1);
                    if (winner && winner.name === bet.names[0]) { won = true; winMultiplier = 5.0; }
                } 
                else if (bet.type === 'ikili') {
                    let first = results.find(r => r.rank === 1);
                    let second = results.find(r => r.rank === 2);
                    if (first.name === bet.names[0] && second.name === bet.names[1]) { won = true; winMultiplier = 15.0; }
                }

                if (won) {
                    let winAmount = Math.floor(bet.stake * winMultiplier);
                    addMoney( winAmount);
                    betReport += `<p style="color:#2ecc71;">âœ… KAZANDINIZ (${bet.desc})! KazanÃ§: $${winAmount.toLocaleString()}</p>`;
                } else {
                    betReport += `<p style="color:#e74c3c;">âŒ KAYBETTÄ°NÄ°Z (${bet.desc}).</p>`;
                }
            });
        } else { betReport += `<p style="color:#7f8c8d;">Bahis yok.</p>`; }
        
        html += betReport;
        html += `<button class="next-btn" style="margin-top:20px; width:100%;" onclick="document.getElementById('modalOverlay').style.display='none'; showRaceCenter(); updateUI();">TAMAM</button>`;
        
        document.getElementById("modalBody").innerHTML = html;
        document.getElementById("modalOverlay").style.display = "flex";
        activeBets = [];
        updateUI();
    }

    // --- KONFETÄ° MOTORU ---
    let confettiInterval;
    function startConfetti() {
        const colors = ['#f1c40f', '#e74c3c', '#3498db', '#2ecc71', '#9b59b6'];
        const container = document.getElementById('confettiContainer');
        container.innerHTML = ''; // Temizle
        
        confettiInterval = setInterval(() => {
            const el = document.createElement('div');
            el.classList.add('confetti');
            el.style.left = Math.random() * 100 + 'vw';
            el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            el.style.animationDuration = (Math.random() * 2 + 2) + 's'; // 2-4 saniye arasÄ± dÃ¼ÅŸÃ¼ÅŸ
            container.appendChild(el);
            
            // Ekrandan Ã§Ä±kÄ±nca sil (Performans iÃ§in)
            setTimeout(() => { el.remove(); }, 4000);
        }, 50); // Her 50ms'de bir yeni konfeti
    }

    function stopConfetti() {
        clearInterval(confettiInterval);
        document.getElementById('confettiContainer').innerHTML = '';
    }

    if(!loadGame()) { generateJockeys(); generateWeeklyRaces(); refreshMarket(); generateOpponents(); }
    if(allJockeys.length === 0) generateJockeys();
    updateUI(); 
    showStable(); 
    
    updateNewsTicker();
    setInterval(updateNewsTicker, 30000); 
// --- GENETÄ°K LABORATUVARI FONKSÄ°YONLARI ---
window.openLabModal = function() {
    let candidates = myHorses.filter(h => !h.trait); // Ã–zelliksiz atlarÄ± bul
    
    if (candidates.length === 0) return alert("Åu an ahÄ±rÄ±nÄ±zda Ã¶zelliÄŸi olmayan (Ã¶zelliksiz) bir at yok. Sadece Ã¶zelliksiz atlara iÅŸlem yapÄ±labilir.");

    let horseOptions = candidates.map(h => `<option value="${h.id}">${h.name} (${h.age}y)</option>`).join("");
    
    let traitOptions = `
        <option value="cimci">ğŸŒ¿ Ã‡imci ($50.000)</option>
        <option value="kumcu">ğŸœï¸ Kumcu ($50.000)</option>
        <option value="sprinter">âš¡ Sprinter ($75.000)</option>
        <option value="maraton">ğŸ”ï¸ Maratoncu ($75.000)</option>
        <option value="hirsli">ğŸ˜¡ HÄ±rslÄ± ($100.000)</option>
    `;

    let html = `
        <button class="close-btn" onclick="document.getElementById('modalOverlay').style.display='none'">X</button>
        <h2 style="color:#8e44ad; text-align:center;">ğŸ§¬ GENETÄ°K LABORATUVARI</h2>
        <p style="text-align:center; color:#ccc;">Uzman doktorlarÄ±mÄ±z atÄ±nÄ±za yeni yetenekler kazandÄ±rabilir.</p>
        
        <div style="background:#222; padding:20px; border-radius:10px; border:1px solid #8e44ad;">
            <label style="color:#fff;">1. AtÄ± SeÃ§:</label>
            <select id="labHorseSelect" style="width:100%; padding:10px; margin-bottom:15px; background:#000; color:#fff;">${horseOptions}</select>
            
            <label style="color:#fff;">2. Eklenecek Ã–zellik (Operasyon):</label>
            <select id="labTraitSelect" style="width:100%; padding:10px; margin-bottom:15px; background:#000; color:#fff;">${traitOptions}</select>
            
            <div style="text-align:center; margin-top:10px;">
                <button class="menu-btn" style="background:#8e44ad; width:100%; font-size:16px;" onclick="performSurgery()">ğŸ’‰ OPERASYONU BAÅLAT</button>
            </div>
        </div>
    `;
    document.getElementById("modalBody").innerHTML = html;
    document.getElementById("modalOverlay").style.display = "flex";
}

window.performSurgery = function() {
    let horseId = document.getElementById("labHorseSelect").value;
    let traitCode = document.getElementById("labTraitSelect").value;
    let cost = 0; let traitName = ""; let traitDesc = "";

    if(traitCode === 'cimci') { cost=50000; traitName='Ã‡imci'; traitDesc='Ã‡im pistte performans artar.'; }
    else if(traitCode === 'kumcu') { cost=50000; traitName='Kumcu'; traitDesc='Kum pistte performans artar.'; }
    else if(traitCode === 'sprinter') { cost=75000; traitName='Sprinter'; traitDesc='KÄ±sa mesafede uÃ§ar.'; }
    else if(traitCode === 'maraton') { cost=75000; traitName='Maratoncu'; traitDesc='Uzun mesafede yorulmaz.'; }
    else if(traitCode === 'hirsli') { cost=100000; traitName='HÄ±rslÄ±'; traitDesc='YarÄ±ÅŸta +5 Puan ekstra.'; }

    if(money < cost) return alert(`Bu operasyon iÃ§in paranÄ±z yetersiz! Gerekli: $${cost.toLocaleString()}`);

    let h = myHorses.find(x => x.id == horseId);
    if(!h) return;

    if(!confirm(`${h.name} adlÄ± ata ${traitName} Ã¶zelliÄŸi eklenecek. Tutar: $${cost.toLocaleString()}. OnaylÄ±yor musunuz?`)) return;

    spendMoney( cost);
    h.trait = { id: traitCode, name: traitName, desc: traitDesc, type: 'pos' };
    
    // %10 Risk: Doktor hata yaparsa kondisyon dÃ¼ÅŸer
    if(Math.random() < 0.1) { 
        h.condition = Math.max(10, h.condition - 30);
        alert(`âš ï¸ Operasyon baÅŸarÄ±lÄ± oldu ANCAK at biraz hÄ±rpalandÄ±. Kondisyonu dÃ¼ÅŸtÃ¼.`);
    } else {
        alert(`âœ… BAÅARILI! ${h.name} artÄ±k bir ${traitName}!`);
    }

    updateUI();
    document.getElementById("modalOverlay").style.display = 'none';
    showStable(); 
}
// --- YENÄ° PARALI VE KARAKTERLÄ° TÄ°PSTER SÄ°STEMÄ° (MANTIK) ---

const TIPSTERS = {
    riza: { name: "Mahalleli RÄ±za", cost: 100, role: "SÃ¼rprizci", accuracy: 0.2 }, 
    mert: { name: "Analist Mert", cost: 500, role: "Ä°statistikÃ§i", accuracy: 0.6 }, 
    hincal: { name: "Ãœstad HÄ±ncal", cost: 2000, role: "Otorite", accuracy: 0.9 }
};

window.buyTip = function(type) {
    let tipster = TIPSTERS[type];
    
    if (money < tipster.cost) {
        return alert(`${tipster.name} ile konuÅŸmak iÃ§in paran yetersiz! (Gerekli: $${tipster.cost})`);
    }

    if (!activeRace || !activeRace.runners || activeRace.runners.length === 0) return;

    if(!confirm(`${tipster.name} ($${tipster.cost}) dinlemek istiyor musun?`)) return;
    spendMoney( tipster.cost);
    updateUI();

    let tempRunners = [...activeRace.runners];
    
    // Gizli gÃ¼Ã§ hesaplama
    tempRunners.forEach(r => {
        let p = r.horse.sprint + r.horse.stamina;
        if(r.horse.surface === activeRace.surface) p *= 1.1; 
        r.hiddenPower = p; 
    });
    
    tempRunners.sort((a,b) => b.hiddenPower - a.hiddenPower);

    let pick;
    let comment = "";

    if (type === 'hincal') {
        pick = tempRunners[0]; 
        comment = "Bak yeÄŸenim, iÃ§eriden aldÄ±ÄŸÄ±m bilgi saÄŸlam. Bu at bugÃ¼n uÃ§acak, banko!";
    } 
    else if (type === 'mert') {
        let slice = tempRunners.slice(0, 3);
        pick = slice[Math.floor(Math.random() * slice.length)];
        comment = "Ä°statistikler ve son idman dereceleri bu atÄ± iÅŸaret ediyor. Formu Ã§ok yÃ¼ksek.";
    } 
    else { 
        if (Math.random() > 0.5) {
            pick = tempRunners[Math.floor(Math.random() * tempRunners.length)];
        } else {
            let badHorses = tempRunners.slice(-3);
            pick = badHorses[Math.floor(Math.random() * badHorses.length)];
        }
        comment = "Kahvede Ã§ocuklar sÃ¶yledi, bu atÄ±n oranÄ± yÃ¼ksek ama bombayÄ± patlatÄ±r demedi deme!";
    }

    let resultDiv = document.getElementById("tipResultArea");
    resultDiv.style.display = "block";
    resultDiv.innerHTML = `
        <div style="border-left: 4px solid ${type === 'hincal' ? '#e74c3c' : (type === 'mert' ? '#3498db' : '#f1c40f')}; background:#222; padding:10px;">
            <h4 style="margin:0; color:#fff;">${tipster.name} Diyor ki:</h4>
            <p style="font-style:italic; color:#bdc3c7; margin:5px 0;">"${comment}"</p>
            <div style="font-size:18px; font-weight:bold; color:#2ecc71;">ğŸ‘‰ ${pick.horse.name} (${pick.jockey.name})</div>
        </div>
    `;
}
// --- JOKEY SÃ–ZLEÅME VE FESÄ°H FONKSÄ°YONLARI ---

window.signContract = function(jockeyId) {
    // 1. Kontenjan Dolu mu?
    if (hiredJockeys.length >= MAX_HIRED_JOCKEYS) {
        return alert(`Kadro dolu! Maksimum ${MAX_HIRED_JOCKEYS} jokey ile Ã§alÄ±ÅŸabilirsiniz. Ã–nce birini kovmalÄ±sÄ±nÄ±z.`);
    }

    // 2. Jokeyi Bul
    let j = allJockeys.find(x => x.id === jockeyId);
    if (!j) return alert("Hata: Jokey bulunamadÄ±.");

    // 3. Para KontrolÃ¼
    // Ä°mza parasÄ± standart: $10.000 (JOKEY_BASE_SALARY sabiti)
    if (money < JOKEY_BASE_SALARY) {
        return alert(`SÃ¶zleÅŸme Ã¼creti ($${JOKEY_BASE_SALARY.toLocaleString()}) iÃ§in paranÄ±z yetersiz!`);
    }

    // 4. Onay ve Ä°ÅŸlem
    if(!confirm(`${j.name} ile sÃ¶zleÅŸme imzalamak istiyor musunuz? (Tutar: $${JOKEY_BASE_SALARY.toLocaleString()})`)) return;

    spendMoney( JOKEY_BASE_SALARY);
    j.isContracted = true;
    j.contractWeeks = SEASON_LENGTH; // 48 Hafta sÃ¶zleÅŸme
    hiredJockeys.push(j);

    alert(`âœï¸ Tebrikler! ${j.name} ile sÃ¶zleÅŸme imzalandÄ±.`);
    updateUI();
    showJockeyManagement(); // EkranÄ± yenile
}

window.terminateContract = function(jockeyId) {
    let index = hiredJockeys.findIndex(x => x.id === jockeyId);
    if (index === -1) return;

    let j = hiredJockeys[index];
    let penalty = 2500; // Kovma tazminatÄ±

    if (!confirm(`${j.name} ile yollarÄ± ayÄ±rmak istiyor musunuz? Tazminat bedeli: $${penalty.toLocaleString()}`)) return;

    if (money < penalty) return alert("Tazminat Ã¶deyecek paranÄ±z yok!");

    spendMoney( penalty);
    j.isContracted = false;
    j.contractWeeks = 0;
    j.trainingWeeks = 0; // EÄŸitimi de iptal olur
    hiredJockeys.splice(index, 1); // Listeden Ã§Ä±kar

    alert(`SÃ¶zleÅŸme feshedildi. GÃ¼le gÃ¼le ${j.name}!`);
    updateUI();
    showJockeyManagement(); // EkranÄ± yenile
}
// --- EKSÄ°K OLAN FONKSÄ°YON: JOKEY YÃ–NETÄ°M PENCERESÄ° ---
    window.openJockeyModal = function(jockeyId) {
        let j = hiredJockeys.find(x => x.id === jockeyId);
        if(!j) return;

        // EÄŸitim Durumu KontrolÃ¼ (EÄŸer eÄŸitimdeyse uyarÄ± gÃ¶ster)
        let trainingStatus = j.trainingWeeks > 0
            ? `<div style="background:#f39c12; color:#000; padding:10px; border-radius:5px; margin-bottom:10px; font-weight:bold; text-align:center; box-shadow:0 0 10px rgba(243, 156, 18, 0.5);">
                 âš ï¸ BU JOKEY ÅU AN EÄÄ°TÄ°MDE! (Kalan: ${j.trainingWeeks} Hafta)
               </div>`
            : '';

        // Sponsor Durumu (Varsa iptal butonu, yoksa bul butonu)
        let sponsorHtml = j.sponsor
            ? `<div style="border:1px solid #2ecc71; padding:10px; margin-top:10px; border-radius:5px; background:rgba(46, 204, 113, 0.1);">
                 <h4 style="color:#2ecc71; margin:0;">SPONSOR: ${j.sponsor}</h4>
                 <p style="font-size:12px; margin:5px 0; color:#fff;">HaftalÄ±k Gelir: +$100</p>
                 <button class="btn-sell" style="width:100%; margin-top:5px;" onclick="removeSponsor(${j.id})">SÃ¶zleÅŸmeyi Ä°ptal Et</button>
               </div>`
            : `<button class="btn-action" style="width:100%; margin-top:10px; background:#8e44ad;" onclick="addSponsor(${j.id})">
                 ğŸ“¢ SPONSOR BUL ($1.000)
               </button>`;

        // Yetenek BarlarÄ± Ä°Ã§in YardÄ±mcÄ± Fonksiyon
        const getBar = (val, max=120) => {
            let color = val > 90 ? '#f1c40f' : (val > 70 ? '#2ecc71' : '#e74c3c');
            return `<div class="skill-bar-container"><div class="skill-bar-fill" style="width:${Math.min(100, (val/max)*100)}%; background:${color}"></div></div>`;
        };

        let html = `
            <button class="close-btn" onclick="document.getElementById('modalOverlay').style.display='none'">X</button>
            <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                <h2 style="color:#e67e22; text-align:center; margin:0;">${j.name.toUpperCase()}</h2>
                <span class="jockey-type type-${j.type.toLowerCase()}" style="font-size:12px;">${j.type}</span>
            </div>
            <div style="text-align:center; color:#aaa; font-size:12px; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
                YaÅŸ: ${j.age} | MaaÅŸ: $${(JOKEY_BASE_SALARY/48).toFixed(0)}/hafta
            </div>

            ${trainingStatus}

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div style="background:#1a252f; padding:15px; border-radius:8px; border:1px solid #34495e;">
                    <h3 style="color:#3498db; border-bottom:1px solid #444; padding-bottom:5px; margin-top:0;">ğŸ“Š YETENEKLER</h3>
                    
                    <div style="margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; font-size:12px;">
                            <span>Tempo KontrolÃ¼</span> <span style="color:#fff">${j.paceControl.toFixed(0)}</span>
                        </div>
                        ${getBar(j.paceControl)}
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; font-size:12px;">
                            <span>Sprint GÃ¼cÃ¼</span> <span style="color:#fff">${j.sprintFinish.toFixed(0)}</span>
                        </div>
                        ${getBar(j.sprintFinish)}
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; font-size:12px;">
                            <span>KÄ±rbaÃ§ KullanÄ±mÄ±</span> <span style="color:#fff">${j.whipUsage.toFixed(0)}</span>
                        </div>
                        ${getBar(j.whipUsage)}
                    </div>

                    <div style="margin-top:15px; font-size:12px; color:#bdc3c7; text-align:center; background:#000; padding:5px; border-radius:4px;">
                        YaÄŸmur Becerisi: <strong style="color:#3498db">%${j.rainSkill}</strong>
                    </div>
                </div>

                <div style="background:#1a252f; padding:15px; border-radius:8px; border:1px solid #34495e;">
                    <h3 style="color:#e67e22; border-bottom:1px solid #444; padding-bottom:5px; margin-top:0;">ğŸ‹ï¸ Ã–ZEL EÄÄ°TÄ°M</h3>
                    <p style="font-size:11px; color:#aaa; margin-bottom:10px;">EÄŸitim sÃ¼resince jokey yarÄ±ÅŸlara katÄ±lamaz.</p>

                    <button class="menu-btn" style="font-size:11px; margin-bottom:5px; width:100%; text-align:left;" onclick="startJockeyTraining(${j.id}, 'TempolamaDersi')" ${j.trainingWeeks > 0 ? 'disabled style="opacity:0.5"' : ''}>
                        ğŸ§  <strong>Tempolama Dersi</strong> ($5.000)<br>
                        <span style="color:#2ecc71">+5 Yetenek (4 Hafta)</span>
                    </button>
                    
                    <button class="menu-btn" style="font-size:11px; margin-bottom:5px; width:100%; text-align:left;" onclick="startJockeyTraining(${j.id}, 'SprintAntr')" ${j.trainingWeeks > 0 ? 'disabled style="opacity:0.5"' : ''}>
                        âš¡ <strong>Sprint AntrenmanÄ±</strong> ($10.000)<br>
                        <span style="color:#2ecc71">+8 Yetenek (8 Hafta)</span>
                    </button>
                    
                    <button class="menu-btn" style="font-size:11px; margin-bottom:5px; width:100%; text-align:left;" onclick="startJockeyTraining(${j.id}, 'KÄ±rbaÃ§UstalÄ±ÄŸÄ±')" ${j.trainingWeeks > 0 ? 'disabled style="opacity:0.5"' : ''}>
                        ğŸ‡ <strong>KÄ±rbaÃ§ UstalÄ±ÄŸÄ±</strong> ($20.000)<br>
                        <span style="color:#2ecc71">+12 Yetenek (12 Hafta)</span>
                    </button>
                </div>
            </div>

            <div style="margin-top:20px;">
                <h3 style="color:#2ecc71; border-bottom:1px solid #444;">ğŸ’¸ EKONOMÄ° & SPONSORLUK</h3>
                ${sponsorHtml}
            </div>
        `;

        document.getElementById("modalBody").innerHTML = html;
        document.getElementById("modalOverlay").style.display = "flex";
    }
// --- [YENÄ°] OYUNCU ATI SATIÅ SÄ°STEMÄ° ---

// --- [GELÄ°ÅMÄ°Å] OYUNCU ATI SATIÅ SÄ°STEMÄ° V2 ---

// AtÄ±n GerÃ§ek DeÄŸerini Hesaplayan Matematiksel Fonksiyon
function calculateHorseValue(h) {
    let power = h.sprint + h.stamina;
    let basePrice = power * 200; // Temel Ã§arpan
    let multiplier = 1;

    // GÃ¼Ã§ arttÄ±kÃ§a fiyatÄ± KATLA
    if (power > 300) multiplier = 3;      // Ä°yi At
    if (power > 380) multiplier = 8;      // Elit At
    if (power > 440) multiplier = 15;     // Efsane At (Ferrari)
    
    // GenÃ§ atlar (2-3 yaÅŸ) daha deÄŸerlidir
    let ageBonus = (h.age <= 3) ? 1.5 : (h.age > 6 ? 0.7 : 1.0);
    
    // KazanÄ±lan yarÄ±ÅŸlar fiyatÄ± uÃ§urur
    let winCount = h.history.filter(r => r.rank === 1).length;
    let winBonus = 1 + (winCount * 0.2); // Her galibiyet %20 deÄŸer katar

    let finalValue = Math.floor(basePrice * multiplier * ageBonus * winBonus);
    return finalValue;
}

window.openPlayerAuction = function(horseId) {
    let h = myHorses.find(x => x.id == horseId);
    if (!h) return;
    
    let estimatedValue = calculateHorseValue(h);
    // AÃ§Ä±lÄ±ÅŸ fiyatÄ± tahmini deÄŸerin %30'u olsun ki kapÄ±ÅŸma olsun
    let startPrice = Math.floor(estimatedValue * 0.3); 

    let html = `
        <button class="close-btn" onclick="document.getElementById('modalOverlay').style.display='none'">X</button>
        <h2 style="color:#9b59b6; text-align:center; text-shadow:0 0 10px #8e44ad;">ğŸ”¨ BÃœYÃœK MÃœZAYEDE: ${h.name.toUpperCase()}</h2>
        
        <div style="display:flex; align-items:center; justify-content:center; gap:20px; margin-bottom:20px;">
            <img src="resimler/at.gif" style="filter:${h.colorFilter}; height:120px; border:3px solid #f1c40f; border-radius:10px; box-shadow:0 0 20px #f1c40f;">
            <div style="text-align:left;">
                <p>âš¡ HÄ±z: <span style="color:#f1c40f; font-weight:bold;">${h.sprint.toFixed(0)}</span></p>
                <p>ğŸ›¡ï¸ GÃ¼Ã§: <span style="color:#f1c40f; font-weight:bold;">${h.stamina.toFixed(0)}</span></p>
                <p>ğŸ† Galibiyet: ${h.history.filter(r => r.rank === 1).length}</p>
                <p style="color:#aaa; font-size:12px;">Uzman Tahmini DeÄŸer: $${estimatedValue.toLocaleString()}</p>
            </div>
        </div>

        <div style="text-align:center; margin-bottom:20px;">
            <p style="font-size:24px; font-weight:bold; color:#fff;">AÃ‡ILIÅ FÄ°YATI: <span style="color:#2ecc71;">$${startPrice.toLocaleString()}</span></p>
        </div>

        <div id="auctionLog" style="background:#000; height:200px; overflow-y:auto; padding:15px; border:2px solid #555; margin-bottom:15px; font-family:'Courier New'; font-size:14px; box-shadow:inset 0 0 20px #000;">
            <div style="color:#777;">Salon doluyor... AlÄ±cÄ±lar yerlerini alÄ±yor...</div>
        </div>

        <button id="startAuctionBtn" class="menu-btn" style="width:100%; background:#27ae60; padding:15px; font-size:18px;" onclick="startBiddingProcess('${h.id}', ${startPrice})">ğŸ”¥ AÃ‡IK ARTIRMAYI BAÅLAT</button>
        
        <audio id="bidSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
    `;
    document.getElementById("modalBody").innerHTML = html;
    document.getElementById("modalOverlay").style.display = "flex";
}

window.startBiddingProcess = function(horseId, startPrice) {
    document.getElementById("startAuctionBtn").style.display = 'none';
    let h = myHorses.find(x => x.id == horseId);
    let logBox = document.getElementById("auctionLog");
    let soundEffect = document.getElementById("bidSound");
    soundEffect.volume = 0.5;

    // Zengin AlÄ±cÄ±lar Listesi
    const BUYERS = [
        { name: "Godolphin ğŸ”µ", color: "#3498db" },
        { name: "Coolmore ğŸŸ£", color: "#9b59b6" },
        { name: "Juddmonte ğŸŸ¢", color: "#2ecc71" },
        { name: "Shadwell ğŸŸ¡", color: "#f1c40f" },
        { name: "Aga Khan ğŸ”´", color: "#e74c3c" },
        { name: "Japon YatÄ±rÄ±mcÄ± ğŸ‡¯ğŸ‡µ", color: "#fff" },
        { name: "Katar Åeyhi ğŸ‡¶ğŸ‡¦", color: "#8e44ad" }
    ];

    let currentPrice = startPrice;
    let trueValue = calculateHorseValue(h);
    // At Ã§ok iyiyse deÄŸerinin %150'sine kadar Ã§Ä±kabilirler (Ã‡Ä±lgÄ±nlÄ±k payÄ±)
    let maxLimit = trueValue * (h.isElite ? rand(1.2, 1.8) : rand(1.0, 1.2)); 
    
    let bidCount = 0;
    // En az 10, en fazla 25 tur sÃ¼rsÃ¼n
    let maxBids = rand(10, 25); 
    let currentBidder = null;

    let bidInterval = setInterval(() => {
        bidCount++;
        
        // Fiyat arttÄ±rma mantÄ±ÄŸÄ±
        // Hala limitin altÄ±ndaysa ve tur sayÄ±sÄ± bitmediyse devam et
        if (currentPrice < maxLimit && bidCount < maxBids) {
            
            // Rastgele bir alÄ±cÄ± seÃ§ (Son teklif verenden farklÄ± olsun)
            let candidate;
            do { candidate = pick(BUYERS); } while (currentBidder && candidate.name === currentBidder.name);
            currentBidder = candidate;

            // Fiyat artÄ±ÅŸÄ±: AtÄ±n deÄŸerine gÃ¶re 10k ile 100k arasÄ± arttÄ±rÄ±rlar
            let raise = Math.floor(currentPrice * rand(5, 15) / 100); 
            currentPrice += raise;

            // GÃ¶rsel Efektler
            if(soundEffect) { soundEffect.currentTime = 0; soundEffect.play().catch(e=>{}); } // Ses
            
            let logHtml = `
                <div style="margin-top:5px; border-bottom:1px dashed #333; padding-bottom:2px; animation: flash 0.5s;">
                    <span style="color:#777;">[${bidCount}. Teklif]</span> 
                    <strong style="color:${currentBidder.color}; font-size:16px;">${currentBidder.name}</strong> 
                    fiyatÄ± yÃ¼kseltti: 
                    <span style="color:#2ecc71; font-weight:bold; font-size:16px;">$${currentPrice.toLocaleString()}</span>
                    <span style="color:#f1c40f; font-weight:bold;"> GONG! ğŸ””</span>
                </div>`;
            
            logBox.innerHTML += logHtml;
            logBox.scrollTop = logBox.scrollHeight;

            // Son turlara girince heyecan artsÄ±n
            if (bidCount > maxBids - 3) {
                logBox.innerHTML += `<div style="color:#e74c3c; font-weight:bold;">âš ï¸ SATIYORUM... SATTIM... SAT...</div>`;
            }

        } else {
            // Ä°hale Bitti
            clearInterval(bidInterval);
            finishExcitingAuction(h, currentPrice, currentBidder.name);
        }
    }, 1200); // Her 1.2 saniyede bir yeni teklif (TadÄ±nÄ± Ã§Ä±karalÄ±m)
}

function finishExcitingAuction(horse, finalPrice, buyerName) {
    let logBox = document.getElementById("auctionLog");
    
    let html = `
        <div style="background:#2ecc71; color:#000; padding:15px; margin-top:20px; text-align:center; border-radius:10px; animation: popIn 0.5s;">
            <h1 style="margin:0;">ğŸ”¨ SATILDI!</h1>
            <p style="font-size:18px;">${buyerName}, <strong>$${finalPrice.toLocaleString()}</strong> BEDELLE KAZANDI!</p>
        </div>
    `;
    logBox.innerHTML += html;
    logBox.scrollTop = logBox.scrollHeight;
    
    let modalBody = document.getElementById("modalBody");
    // "ParayÄ± Al" butonunu ekle
    let btnDiv = document.createElement("div");
    btnDiv.innerHTML = `
        <button class="menu-btn" style="width:100%; margin-top:15px; background:#f39c12; color:#000; font-size:20px; border:2px solid #fff; padding:20px;" onclick="completeTransfer('${horse.id}', ${finalPrice}, '${buyerName}')">
            ğŸ’° PARAYI KASAYA KOY (+$${finalPrice.toLocaleString()})
        </button>`;
    modalBody.appendChild(btnDiv);
}

window.completeTransfer = function(horseId, price, buyerName) {
    let hIndex = myHorses.findIndex(x => x.id == horseId);
    if (hIndex === -1) return;
    
    let h = myHorses[hIndex];
    
    // 1. ParayÄ± al
    addMoney( price);
    
    // 2. AtÄ± "Rakipler" listesine transfer et
    // Ã–NEMLÄ°: "breeder" etiketini ekliyoruz ki sonra prim alabilelim!
    h.breeder = "Player"; 
    h.stable = buyerName; // Yeni sahibi
    
    allOpponents.push(h); // ArtÄ±k rakibimiz oldu
    myHorses.splice(hIndex, 1); // Bizden gitti
    
    alert(`Tebrikler! ${h.name}, ${buyerName} ekÃ¼risine satÄ±ldÄ±.\nKasa: +$${price.toLocaleString()}\n\nBÄ°LGÄ°: Bu at yarÄ±ÅŸ kazandÄ±ÄŸÄ±nda sana %10 YetiÅŸtiricilik Primi gelecek!`);
    
    document.getElementById("modalOverlay").style.display = "none";
    updateUI();
    showStable();
}
// --- [DETAYLI & YORUMLU] GAZETE SÄ°STEMÄ° V4 ---

function generateNewsContent() {
    // 1. HaftalÄ±k Performans Analizi
    let winners = [];
    let placers = []; // 2. ve 3. olanlar
    let losers = [];
    let sales = [];
    let earnings = 0;

    // LoglarÄ± Tara ve Grupla
    if (!weeklyLogs) weeklyLogs = [];
    
    weeklyLogs.forEach(log => {
        if (log.includes("1. oldu")) {
            let parts = log.split(":");
            let horseName = parts[0].replace("[YARIÅ] ", "").trim();
            let raceName = parts[1].split("koÅŸusunda")[0].trim();
            winners.push({horse: horseName, race: raceName});
        }
        else if (log.includes("2. oldu") || log.includes("3. oldu")) {
            let parts = log.split(":");
            let horseName = parts[0].replace("[YARIÅ] ", "").trim();
            let rank = log.includes("2. oldu") ? "2." : "3.";
            placers.push({horse: horseName, rank: rank});
        }
        else if (log.includes("satÄ±ldÄ±")) {
            sales.push(log); // SatÄ±ÅŸ logunu direkt al
        }
        else if (log.includes("KazanÃ§")) {
             // KazancÄ± Ã§ekmeye Ã§alÄ±ÅŸ (Regex veya split ile)
             // BasitÃ§e log iÃ§inde geÃ§iyorsa saymayalÄ±m, detaylarda yazarÄ±z.
        }
    });

    // 2. MANÅET VE HÄ°KAYE OLUÅTURMA
    let headline = "";
    let story = "";
    let image = "resimler/at.gif"; 
    let sideNews = "";

    // A) GAZÄ° HAFTASI (Ã–zel)
    if (week === 26) {
        headline = "BÃœYÃœK GÃœN: GAZÄ° KOÅUSU!";
        story = "TÃ¼m TÃ¼rkiye'nin kilitlendiÄŸi, Ulu Ã–nder Mustafa Kemal AtatÃ¼rk adÄ±na koÅŸulan dev derbi bugÃ¼n. Åampiyonlar piste Ã§Ä±kÄ±yor. Nefesler tutuldu, gÃ¶zler start hakeminde.";
        sideNews = "Hipodrom tarihi gÃ¼nlerinden birini yaÅŸÄ±yor.";
    }
    // B) SATIÅ VARSA (Tycoon Haberi)
    else if (sales.length > 0) {
        headline = "TRANSFERDE REKOR Ä°MZA!";
        story = "YarÄ±ÅŸ dÃ¼nyasÄ± bu satÄ±ÅŸÄ± konuÅŸuyor. Eray EkÃ¼risi, yetiÅŸtirdiÄŸi ÅŸampiyon safkanÄ± astronomik bir bedelle elden Ã§Ä±kardÄ±. " + sales[0] + " Bu hamlenin piyasayÄ± nasÄ±l etkileyeceÄŸi merak konusu.";
        sideNews = "Kasaya giren devasa nakit, yeni yatÄ±rÄ±mlarÄ±n habercisi mi?";
    }
    // C) KAZANAN VARSA (Zafer Haberi)
    else if (winners.length > 0) {
        let star = winners[0];
        headline = `${star.horse.toUpperCase()} FIRTINASI ESTÄ°!`;
        
        // Hikayeyi detaylandÄ±r (Loop ile)
        story = `Haftaya damgasÄ±nÄ± vuran isim **${star.horse}** oldu. ${star.race} mÃ¼cadelesinde sergilediÄŸi performans, otoriterlerden tam not aldÄ±. `;
        
        if (winners.length > 1) {
            story += `Ancak kutlamalar bununla sÄ±nÄ±rlÄ± kalmadÄ±. **${winners[1].horse}** de kazandÄ±ÄŸÄ± zaferle ekÃ¼rinin gÃ¼cÃ¼nÃ¼ kanÄ±tladÄ±. `;
        }
        
        if (placers.length > 0) {
            story += `Ã–te yandan **${placers[0].horse}** fotofiniÅŸte ÅŸanssÄ±z bir ÅŸekilde ${placers[0].rank} kalarak tabelada yer buldu. Form durumu yÃ¼kseliÅŸte.`;
        } else {
            story += "EkÃ¼rinin diÄŸer safkanlarÄ± ise gelecek yarÄ±ÅŸlar iÃ§in umut verdi.";
        }
        
        sideNews = "Bahis severler, bu ekÃ¼rinin atlarÄ±nÄ± kuponlarÄ±ndan eksik etmiyor.";
    }
    // D) SADECE TABELA VARSA (Teselli)
    else if (placers.length > 0) {
        headline = "ZAFER TEÄET GEÃ‡TÄ°!";
        story = `Bu hafta ÅŸans melekleri sahada deÄŸildi. **${placers[0].horse}** harika koÅŸmasÄ±na raÄŸmen yarÄ±ÅŸÄ± ${placers[0].rank} tamamladÄ±. `;
        if (placers.length > 1) {
            story += `Benzer bir kaderi **${placers[1].horse}** de paylaÅŸtÄ±. AntrenÃ¶r ekibi, 'AtlarÄ±mÄ±z formda, sadece biraz ÅŸansa ihtiyacÄ±mÄ±z var' aÃ§Ä±klamasÄ±nÄ± yaptÄ±.`;
        }
        sideNews = "Pistlerin zemini bu hafta sÃ¼rpriz sonuÃ§lara neden oldu.";
    }
    // E) HÄ°Ã‡BÄ°R ÅEY YOKSA (Sessiz Hafta)
    else {
        const HEADLINES = ["SESSÄ°ZLÄ°K HAKÄ°M", "FIRTINA Ã–NCESÄ° SESSÄ°ZLÄ°K", "ANTRENMAN HAFTASI"];
        headline = pick(HEADLINES);
        story = "Pistlerde sakin bir hafta geride kaldÄ±. EkÃ¼ri, Ã¶nÃ¼mÃ¼zdeki haftalardaki bÃ¼yÃ¼k kupalar iÃ§in gÃ¼Ã§ depoluyor. Sabah idmanlarÄ±nda dereceler oldukÃ§a iyi gÃ¶rÃ¼nÃ¼yor.";
        sideNews = "Meteoroloji uyardÄ±: Ã–nÃ¼mÃ¼zdeki hafta yaÄŸÄ±ÅŸ bekleniyor.";
    }

    // Gazete HTML BasÄ±mÄ±
    let paperHTML = `
        <div class="newspaper-modal">
            <div class="newspaper-header">
                <h1 class="newspaper-name">YARIÅ POSTASI</h1>
                <div class="newspaper-meta">
                    <span>SayÄ±: ${week + (year-1)*48}</span>
                    <span>YÄ±l: ${year} | Hafta: ${week-1}</span> 
                    <span>FiyatÄ±: 10 TL</span>
                </div>
            </div>

            <div class="headline" style="text-transform:uppercase;">${headline}</div>

            <div class="main-article">
                <div style="flex:1;">
                    <img src="${image}" style="width:100%; filter:grayscale(1) contrast(1.2); border:1px solid #000; padding:3px;">
                    <small style="display:block; text-align:center; font-style:italic; margin-top:5px;">HaftanÄ±n karesi</small>
                </div>
                <div class="article-text" style="flex:2;">
                    <strong style="font-size:30px; float:left; margin-right:8px; line-height:0.8;">${story.charAt(0)}</strong>
                    ${story.substring(1)}
                    <br><br>
                    <div style="background:#eee; padding:5px; border:1px dashed #999; font-size:12px;">
                        <strong>HAFTANIN RAPORU:</strong><br>
                        ${weeklyLogs.length > 0 ? weeklyLogs.slice(0,4).join('<br>') + (weeklyLogs.length>4 ? '...' : '') : 'Ã–zel bir hareketlilik yok.'}
                    </div>
                </div>
            </div>

            <div class="side-news">
                <strong>KULÄ°S BÄ°LGÄ°SÄ°:</strong> ${sideNews}
            </div>

            <button class="continue-btn" onclick="closeNewspaper()">OKUDUM, DEVAM ET >></button>
        </div>
    `;

    document.getElementById("modalBody").innerHTML = paperHTML;
    document.getElementById("modalOverlay").style.display = "flex";
}

function closeNewspaper() {
    document.getElementById("modalOverlay").style.display = "none";
    
    // Gazete kapanÄ±nca normal ahÄ±r ekranÄ±nÄ± gÃ¼ncelle
    updateUI();
    showStable();
}
// --- GÃœVENLÄ°K KONTROLÃœ ---
    // EÄŸer para bozulduysa (NaN) dÃ¼zelt
    if (isNaN(money) || money === null) {
        console.log("Para hatasÄ± tespit edildi, dÃ¼zeltiliyor...");
        money = 50000000;
        updateUI();
    }
// --- [YENÄ°] MÃœZE VE EMEKLÄ°LÄ°K SÄ°STEMÄ° ---

window.retireHorse = function(horseId) {
    let h = myHorses.find(x => x.id == horseId);
    if (!h) return;

    // Emeklilik ÅartÄ± (Ä°steÄŸe baÄŸlÄ±, istersen kaldÄ±rabilirsin)
    // Sadece ÅŸampiyonlar mÃ¼zeye girsin diyorsan bunu kullan:
    /* let wins = h.history.filter(r => r.rank === 1).length;
    if (wins < 1) return alert("Bu at henÃ¼z hiÃ§ yarÄ±ÅŸ kazanmadÄ±. MÃ¼zeye girmeyi hak etmiyor!"); 
    */

    if(!confirm(`${h.name} isimli safkanÄ± emekli edip MÃœZEYE kaldÄ±rmak istiyor musunuz?\n\nUYARI: Emekli olan at bir daha yarÄ±ÅŸamaz ve satÄ±lamaz. Sadece mÃ¼zede sergilenir.`)) return;

    // Ä°statistikleri Hesapla
    let totalEarnings = h.history.reduce((a,b)=>a+b.earnings, 0);
    let totalWins = h.history.filter(r => r.rank === 1).length;
    let g1Wins = h.history.filter(r => r.rank === 1 && (r.raceName.includes("G1") || r.raceName.includes("Gazi") || r.raceName.includes("Cup"))).length;

    // AtÄ± MÃ¼zeye Kopyala
    let legend = {
        name: h.name,
        image: h.customImage || 'resimler/at.gif',
        colorFilter: h.colorFilter,
        totalEarnings: totalEarnings,
        totalWins: totalWins,
        g1Wins: g1Wins,
        peakRating: h.rating,
        retireDate: `YÄ±l ${year}, Hafta ${week}`,
        sireName: h.sireName,
        damName: h.damName
    };

    museumHorses.push(legend);

    // AhÄ±rdan Sil
    myHorses = myHorses.filter(x => x.id != horseId);
    
    alert(`${h.name} artÄ±k bir efsane! MÃ¼zede yerini aldÄ±.`);
    updateUI();
    showStable();
}

window.showMuseum = function() {
    let html = `
        <div style="text-align:center; margin-bottom:20px;">
            <h1 style="color:#ffd700; text-shadow:0 0 20px #d4af37; margin:0;">ğŸ›ï¸ EFSANELER MÃœZESÄ°</h1>
            <p style="color:#aaa;">Bu haranÄ±n tarihine adÄ±nÄ± altÄ±n harflerle yazdÄ±ranlar.</p>
        </div>
        <div class="stable-grid">`;

    if (museumHorses.length === 0) {
        html += `<div style="grid-column: 1/-1; text-align:center; padding:50px; color:#555; border:2px dashed #333;">
            <h3>MÃ¼ze HenÃ¼z BoÅŸ...</h3>
            <p>EfsaneleÅŸen atlarÄ±nÄ±zÄ± ahÄ±r menÃ¼sÃ¼nden "EMEKLÄ° ET" diyerek buraya taÅŸÄ±yabilirsiniz.</p>
        </div>`;
    }

    // Efsaneleri en Ã§ok kazanca gÃ¶re sÄ±rala
    museumHorses.sort((a,b) => b.totalEarnings - a.totalEarnings).forEach(legend => {
        html += `
        <div style="background: linear-gradient(135deg, #000 0%, #1a1a1a 100%); border: 2px solid #ffd700; border-radius: 15px; padding: 20px; box-shadow: 0 0 25px rgba(255, 215, 0, 0.15); text-align:center; position:relative; overflow:hidden;">
            
            <div style="position:absolute; top:10px; right:-30px; background:#ffd700; color:#000; padding:5px 30px; transform:rotate(45deg); font-weight:bold; font-size:10px; box-shadow:0 5px 10px rgba(0,0,0,0.5);">EFSANE</div>

            <img src="${legend.image}" style="width:100px; height:100px; filter:${legend.colorFilter}; border-radius:50%; border:3px solid #ffd700; margin-bottom:15px; background:rgba(255,215,0,0.1);">
            
            <h2 style="color:#ffd700; margin:0 0 5px 0; text-transform:uppercase; letter-spacing:1px;">${legend.name}</h2>
            <small style="color:#777;">${legend.retireDate} tarihinde emekli oldu.</small>
            
            <div style="margin-top:20px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; text-align:left; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                <div style="color:#aaa;">ğŸ† Toplam Zafer:</div> <div style="color:#fff; font-weight:bold; text-align:right;">${legend.totalWins}</div>
                <div style="color:#aaa;">ğŸŒŸ G1 / Kupa:</div> <div style="color:#ffd700; font-weight:bold; text-align:right;">${legend.g1Wins}</div>
                <div style="color:#aaa;">ğŸ“ˆ Zirve GÃ¼Ã§:</div> <div style="color:#fff; font-weight:bold; text-align:right;">${legend.peakRating} HP</div>
                <div style="color:#aaa;">ğŸ’° KazanÃ§:</div> <div style="color:#2ecc71; font-weight:bold; text-align:right;">$${legend.totalEarnings.toLocaleString()}</div>
            </div>

            <div style="margin-top:15px; font-size:11px; color:#555;">
                Baba: ${legend.sireName} | Anne: ${legend.damName}
            </div>
        </div>`;
    });

    html += `</div>`;
    document.getElementById("mainDisplay").innerHTML = html;
}
// --- [YENÄ°] HÄ°PODROM TYCOON VE Ã–ZEL YARIÅ MODÃœLÃœ ---

window.showHippodromeTycoon = function() {
    // Gelir ve Maliyet HesaplarÄ±
    let estimatedAudience = Math.floor(myHippodrome.capacity * (myHippodrome.popularity / 100));
    let gateIncome = estimatedAudience * myHippodrome.ticketPrice;
    let foodIncome = estimatedAudience * (myHippodrome.restaurantLevel * 20); 
    let totalEst = gateIncome + foodIncome;
    let standCost = myHippodrome.level * 250000;
    let restCost = (myHippodrome.restaurantLevel + 1) * 150000;

    // Gelecek Program Listesi
    let scheduleList = "";
    if (scheduledRaces.length > 0) {
        scheduledRaces.sort((a,b) => a.runWeek - b.runWeek).forEach(item => {
            scheduleList += `<div style="background:#000; padding:5px; margin-top:5px; font-size:11px; border-left:3px solid #f1c40f;">
                Hafta <strong>${item.runWeek}</strong>: ${item.race.name} ($${item.race.prize.toLocaleString()})
            </div>`;
        });
    } else {
        scheduleList = `<div style="color:#777; font-size:11px; margin-top:5px;">HenÃ¼z planlanmÄ±ÅŸ bir yarÄ±ÅŸ yok.</div>`;
    }

    let html = `
        <div style="text-align:center; margin-bottom:10px;">
            <h1 style="color:#00ffff; text-shadow:0 0 20px #00ffff; margin:0; text-transform:uppercase;">ğŸŸï¸ ${myHippodrome.name} YÃ–NETÄ°MÄ°</h1>
            <button class="btn-action" style="font-size:10px; background:#555;" onclick="renameHippodrome()">âœï¸ Ä°SMÄ° DEÄÄ°ÅTÄ°R</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div style="background:#1a252f; padding:10px; border:2px solid #34495e; border-radius:10px;">
                <h3 style="color:#f1c40f; border-bottom:1px solid #555; padding-bottom:5px; margin-top:0;">ğŸ—ï¸ TESÄ°S DURUMU</h3>
                <p style="font-size:12px;">ğŸŸï¸ TribÃ¼n: <strong>Lv ${myHippodrome.level}</strong> (${myHippodrome.capacity.toLocaleString()})</p>
                <p style="font-size:12px;">ğŸ” Restoran: <strong>Lv ${myHippodrome.restaurantLevel}</strong></p>
                <p style="font-size:12px;">â­ PopÃ¼larite: <strong>%${myHippodrome.popularity}</strong></p>
                
                <div style="background:#000; padding:5px; margin-top:5px; border-radius:5px; color:#2ecc71; font-size:12px;">
                    HaftalÄ±k Gelir: ~$${totalEst.toLocaleString()}
                </div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button class="menu-btn" style="flex:1; font-size:9px;" onclick="upgradeStand(${standCost})">TribÃ¼n ($${standCost.toLocaleString()})</button>
                    <button class="menu-btn" style="flex:1; font-size:9px;" onclick="upgradeRestaurant(${restCost})">Restoran ($${restCost.toLocaleString()})</button>
                </div>
                <h4 style="color:#3498db; border-bottom:1px solid #555; margin-top:15px; font-size:12px;">ğŸ“… GELECEK PROGRAM</h4>
                ${scheduleList}
            </div>

            <div style="background:#1a252f; padding:10px; border:2px solid #e74c3c; border-radius:10px;">
                <h3 style="color:#e74c3c; border-bottom:1px solid #555; padding-bottom:5px; margin-top:0;">ğŸ† YARIÅ ORGANÄ°ZASYONU</h3>
                
                <label style="font-size:11px; color:#aaa;">YarÄ±ÅŸ AdÄ±:</label>
                <input type="text" id="customRaceName" value="${myHippodrome.name} KupasÄ±" style="width:95%; margin-bottom:5px;">
                
                <div style="display:flex; gap:5px;">
                    <div style="flex:1">
                         <label style="font-size:11px; color:#aaa;">Ã–dÃ¼l ($):</label>
                         <input type="number" id="customRacePrize" value="150000" min="10000" style="width:90%;">
                    </div>
                    <div style="flex:1">
                         <label style="font-size:11px; color:#aaa;">Hafta:</label>
                         <input type="number" id="customRaceWeek" value="${week}" min="${week}" max="48" style="width:90%; color:#f1c40f;">
                    </div>
                </div>

                <div style="margin-top:5px; border-top:1px dashed #555; padding-top:5px;">
                    <label style="font-size:11px; color:#aaa;">ğŸ Åartlar & KÄ±sÄ±tlamalar:</label>
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <select id="customRaceAge" style="flex:1; background:#000; color:#fff; font-size:11px;">
                            <option value="all">TÃ¼m YaÅŸlar (AÃ§Ä±k)</option>
                            <option value="2">Sadece 2 YaÅŸlÄ±lar</option>
                            <option value="3">Sadece 3 YaÅŸlÄ±lar</option>
                            <option value="3plus">3 ve YukarÄ± Ä°ngilizler</option>
                            <option value="4plus">4 ve YukarÄ± Araplar</option>
                        </select>
                        
                        <select id="customRaceRating" style="flex:1; background:#000; color:#fff; font-size:11px;">
                            <option value="open">Serbest (0-9999 HP)</option>
                            <option value="maiden">Maiden (0-45 HP)</option>
                            <option value="h15">Handikap 15 (20-70 HP)</option>
                            <option value="h16">Handikap 16 (40-90 HP)</option>
                            <option value="kv">KÄ±sa Vade (60-110 HP)</option>
                            <option value="grup">Grup Seviyesi (90+ HP)</option>
                        </select>
                    </div>

                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                         <select id="customRaceDist" style="flex:1; background:#000; color:#fff; font-size:11px;">
                            <option value="1200">1200m Sprint</option>
                            <option value="1400">1400m</option>
                            <option value="1600">1600m Orta</option>
                            <option value="1900">1900m</option>
                            <option value="2100">2100m</option>
                            <option value="2400">2400m Maraton</option>
                        </select>
                        <select id="customRaceSurf" style="flex:1; background:#000; color:#fff; font-size:11px;">
                            <option value="Ã‡im">Ã‡im Pist</option>
                            <option value="Kum">Kum Pist</option>
                        </select>
                    </div>
                    
                    <div style="background:#333; padding:5px; border-radius:5px; margin-top:5px;">
                        <label style="cursor:pointer; display:flex; align-items:center; gap:10px; font-size:12px; color:#f1c40f;">
                            <input type="checkbox" id="customRaceIsCup"> ğŸ† BU BÄ°R KUPA TÃ–RENÄ°DÄ°R
                        </label>
                    </div>
                </div>

                <button class="menu-btn" style="background:#e74c3c; margin-top:10px; width:100%;" onclick="createCustomRace()">
                    ğŸ”¥ YARIÅI KUR VE KAYDET
                </button>
            </div>
        </div>
    `;
    document.getElementById("mainDisplay").innerHTML = html;
}

window.renameHippodrome = function() {
    let newName = prompt("Hipodromunuzun yeni adÄ± ne olsun?", myHippodrome.name);
    if(newName && newName.trim() !== "") {
        myHippodrome.name = newName.trim().toUpperCase();
        showHippodromeTycoon();
    }
}

window.upgradeStand = function(cost) {
    if(money < cost) return alert("Yetersiz Bakiye!");
    spendMoney( cost);
    myHippodrome.level++;
    myHippodrome.capacity += 2000; // Her seviyede 2000 kiÅŸi artar
    myHippodrome.popularity = Math.min(100, myHippodrome.popularity + 5);
    alert("TribÃ¼nler bÃ¼yÃ¼tÃ¼ldÃ¼! Kapasite arttÄ±.");
    updateUI();
    showHippodromeTycoon();
}

window.upgradeRestaurant = function(cost) {
    if(money < cost) return alert("Yetersiz Bakiye!");
    spendMoney( cost);
    myHippodrome.restaurantLevel++;
    myHippodrome.popularity = Math.min(100, myHippodrome.popularity + 3);
    alert("Yeni restoran aÃ§Ä±ldÄ±! Seyirciler daha Ã§ok harcayacak.");
    updateUI();
    showHippodromeTycoon();
}

window.createCustomRace = function() {
    let rName = document.getElementById("customRaceName").value;
    let rPrize = parseInt(document.getElementById("customRacePrize").value);
    let rDist = parseInt(document.getElementById("customRaceDist").value);
    let rSurf = document.getElementById("customRaceSurf").value;
    let rWeek = parseInt(document.getElementById("customRaceWeek").value);
    
    // YENÄ° INPUTLARIN DEÄERLERÄ°NÄ° ALIYORUZ
    let rAgeCode = document.getElementById("customRaceAge").value;
    let rRatingCode = document.getElementById("customRaceRating").value;
    let isCup = document.getElementById("customRaceIsCup").checked;

    if(money < rPrize) return alert("KasanÄ±zda bu Ã¶dÃ¼lÃ¼ verecek kadar para yok!");
    if(rPrize < 10000) return alert("En az $10.000 Ã¶dÃ¼l koymalÄ±sÄ±nÄ±z.");
    if(rWeek < week) return alert("GeÃ§miÅŸ haftaya yarÄ±ÅŸ koyamazsÄ±nÄ±z!");
    if(rWeek > 48) return alert("Sezon 48 hafta sÃ¼rÃ¼yor.");

    // YAÅ MANTIÄINI KUR
    let ageLimit = null;
    let isAgePlus = false; // "ve YukarÄ±" mÄ±?

    if (rAgeCode === "2") { ageLimit = 2; }
    else if (rAgeCode === "3") { ageLimit = 3; }
    else if (rAgeCode === "3plus") { ageLimit = 3; isAgePlus = true; } // 3 ve YukarÄ±
    else if (rAgeCode === "4plus") { ageLimit = 4; isAgePlus = true; } // 4 ve YukarÄ±

    // HANDÄ°KAP/PUAN MANTIÄINI KUR
    let minR = 0;
    let maxR = 9999;

    if (rRatingCode === "maiden") { minR = 0; maxR = 45; }
    else if (rRatingCode === "h15") { minR = 20; maxR = 70; }
    else if (rRatingCode === "h16") { minR = 40; maxR = 90; }
    else if (rRatingCode === "kv") { minR = 60; maxR = 110; }
    else if (rRatingCode === "grup") { minR = 90; maxR = 9999; }

    let confirmMsg = (rWeek === week) 
        ? `Bu hafta koÅŸulacak: ${rName}\nÃ–dÃ¼l: $${rPrize.toLocaleString()}\nÅartlar: ${rRatingCode.toUpperCase()}\nOnaylÄ±yor musunuz?`
        : `Hafta ${rWeek} iÃ§in planlanacak: ${rName}\nTutar: $${rPrize.toLocaleString()} bloklanacak.\nOnaylÄ±yor musunuz?`;

    if(!confirm(confirmMsg)) return;

    spendMoney(rPrize); 

    // YarÄ±ÅŸ Nesnesi
    let newRace = {
        id: 'custom_' + Date.now(),
        name: isCup ? "ğŸ† " + rName : "â˜… " + rName, 
        category: isCup ? "Ã–ZEL KUPA" : "Ã–zel Organizasyon",
        dist: rDist,
        surface: rSurf,
        city: myHippodrome.name, 
        prize: rPrize,
        
        // Yeni KÄ±sÄ±tlamalar
        minRating: minR,
        maxRating: maxR,
        ageLimit: ageLimit,
        isAgePlus: isAgePlus,
        
        // MÃ¼zeye gidebilmesi iÃ§in Ã¶zel bayrak
        isCustomCup: isCup, 

        weather: "GÃ¼neÅŸli", 
        tooltip: `ORGANÄ°ZATÃ–R: SÄ°Z\nÃ–dÃ¼l: $${rPrize.toLocaleString()}\nÅart: ${rAgeCode} | HP: ${minR}-${maxR}`,
        registeredUserHorses: []
    };

    if (rWeek === week) {
        activeRaces.unshift(newRace);
        alert("YarÄ±ÅŸ bÃ¼ltene eklendi! Hemen gidip atÄ±nÄ±zÄ± kaydedin.");
        showRaceCenter();
    } else {
        scheduledRaces.push({ runWeek: rWeek, race: newRace });
        alert(`YarÄ±ÅŸ Hafta ${rWeek} programÄ±na alÄ±ndÄ±!`);
        showHippodromeTycoon();
    }
    updateUI();
}
// --- YENÄ° FÄ°NANS MERKEZÄ° MODÃœLÃœ ---

window.showFinanceCenter = function() {
    // Toplam VarlÄ±k HesabÄ±
    let goldVal = investments.gold * marketRates.gold;
    let forexVal = investments.forex * marketRates.forex;
    let stockVal = investments.stocks * marketRates.stocks;
    let totalAssets = money + goldVal + forexVal + stockVal;
    let netWorth = totalAssets - bankLoan;
    
    // Kredi Limiti HesabÄ± (Kredi skoruna gÃ¶re)
    let creditLimit = creditScore * 500; 
    let availableCredit = Math.max(0, creditLimit - bankLoan);

    // Sponsor Durumu
    let sponsorHtml = stableSponsor.name 
        ? `<div style="background:#2ecc71; color:#000; padding:10px; border-radius:5px; margin-bottom:10px;">
             <strong>âœ… AKTÄ°F: ${stableSponsor.name}</strong><br>
             HaftalÄ±k: $${stableSponsor.weeklyIncome.toLocaleString()} | Kalan: ${stableSponsor.weeksLeft} Hafta
           </div>`
        : `<button class="menu-btn" style="background:#e67e22; width:100%;" onclick="findStableSponsor()">ğŸ“¢ ANA SPONSOR ARA ($5.000)</button>`;

    let html = `
        <div style="text-align:center; margin-bottom:20px;">
            <h1 style="color:#2ecc71; text-shadow:0 0 20px #27ae60; margin:0;">ğŸ¦ WALL STREET (FÄ°NANS)</h1>
            <p style="color:#aaa;">ParanÄ± yÃ¶net, kredi Ã§ek veya borsada risk al.</p>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div style="background:#1a252f; padding:15px; border:2px solid #7f8c8d; border-radius:10px;">
                <h3 style="color:#bdc3c7; border-bottom:1px solid #555; margin-top:0;">ğŸ¦ VAKIFBANK KREDÄ°</h3>
                <p>Mevcut BorÃ§: <span style="color:#e74c3c; font-weight:bold;">$${bankLoan.toLocaleString()}</span></p>
                <p>Kredi Notun: <strong>${creditScore}</strong> (Limit: $${creditLimit.toLocaleString()})</p>
                <p style="font-size:11px; color:#aaa;">HaftalÄ±k Faiz OranÄ±: %2</p>
                
                <div style="background:#000; padding:10px; margin-bottom:10px;">
                    <label>Tutar ($):</label>
                    <input type="number" id="bankAmount" value="50000" style="width:90%;">
                </div>
                
                <div style="display:flex; gap:5px;">
                    <button class="menu-btn" style="background:#27ae60; flex:1;" onclick="takeLoan()">KREDÄ° Ã‡EK</button>
                    <button class="menu-btn" style="background:#c0392b; flex:1;" onclick="payLoan()">BORÃ‡ Ã–DE</button>
                </div>
            </div>

            <div style="background:#1a252f; padding:15px; border:2px solid #e67e22; border-radius:10px;">
                <h3 style="color:#e67e22; border-bottom:1px solid #555; margin-top:0;">ğŸ“¢ FORMA SPONSORLUÄU</h3>
                <p style="font-size:12px; color:#ccc;">AhÄ±rÄ±nÄ±za sponsor alarak dÃ¼zenli gelir elde edin.</p>
                ${sponsorHtml}
            </div>
        </div>

        <div style="background:#1a252f; padding:15px; border:2px solid #f1c40f; border-radius:10px; margin-top:20px;">
            <h3 style="color:#f1c40f; border-bottom:1px solid #555; margin-top:0; display:flex; justify-content:space-between;">
                ğŸ“ˆ YATIRIM BORSASI
                <span style="font-size:12px; color:#fff;">Net VarlÄ±k: $${netWorth.toLocaleString()}</span>
            </h3>
            
            <table style="width:100%; text-align:center; font-size:13px;">
                <tr style="color:#aaa;">
                    <th>EnstrÃ¼man</th>
                    <th>Birim Fiyat</th>
                    <th>Sahip OlduÄŸun</th>
                    <th>DeÄŸer ($)</th>
                    <th>Ä°ÅŸlem</th>
                </tr>
                <tr>
                    <td style="color:#ffd700;">ğŸ¥‡ ALTIN</td>
                    <td>$${marketRates.gold}</td>
                    <td>${investments.gold} gr</td>
                    <td>$${goldVal.toLocaleString()}</td>
                    <td>
                        <button class="btn-action" onclick="tradeInvestment('gold', 'buy')">AL</button>
                        <button class="btn-sell" onclick="tradeInvestment('gold', 'sell')">SAT</button>
                    </td>
                </tr>
                <tr>
                    <td style="color:#2ecc71;">ğŸ’µ DÃ–VÄ°Z (USD)</td>
                    <td>$${marketRates.forex}</td>
                    <td>${investments.forex} Birim</td>
                    <td>$${forexVal.toLocaleString()}</td>
                    <td>
                        <button class="btn-action" onclick="tradeInvestment('forex', 'buy')">AL</button>
                        <button class="btn-sell" onclick="tradeInvestment('forex', 'sell')">SAT</button>
                    </td>
                </tr>
                <tr>
                    <td style="color:#3498db;">ğŸ“Š HÄ°SSE (BIST)</td>
                    <td>$${marketRates.stocks}</td>
                    <td>${investments.stocks} Lot</td>
                    <td>$${stockVal.toLocaleString()}</td>
                    <td>
                        <button class="btn-action" onclick="tradeInvestment('stocks', 'buy')">AL</button>
                        <button class="btn-sell" onclick="tradeInvestment('stocks', 'sell')">SAT</button>
                    </td>
                </tr>
            </table>
        </div>
    `;
    document.getElementById("mainDisplay").innerHTML = html;
}

window.takeLoan = function() {
    let amt = parseInt(document.getElementById("bankAmount").value);
    let creditLimit = creditScore * 500;
    let available = creditLimit - bankLoan;

    if(amt <= 0) return alert("GeÃ§erli bir tutar girin.");
    if(amt > available) return alert(`Kredi limitiniz yetersiz! Ã‡ekebileceÄŸiniz max: $${available.toLocaleString()}`);

    addMoney( amt);
    bankLoan += amt;
    alert(`$${amt.toLocaleString()} kredi hesabÄ±nÄ±za yattÄ±. HayÄ±rlÄ± iÅŸler!`);
    updateUI();
    showFinanceCenter();
}

window.payLoan = function() {
    let amt = parseInt(document.getElementById("bankAmount").value);
    if(amt <= 0) return alert("GeÃ§erli bir tutar girin.");
    if(amt > money) return alert("ParanÄ±z yetersiz!");
    if(amt > bankLoan) amt = bankLoan; // Fazla Ã¶derse borcu kapatÄ±r

    spendMoney( amt);
    bankLoan -= amt;
    
    // BorÃ§ Ã¶dedikÃ§e kredi notu artar
    creditScore += Math.floor(amt / 10000); 
    
    alert(`$${amt.toLocaleString()} borÃ§ Ã¶dendi. Kredi notunuz arttÄ±!`);
    updateUI();
    showFinanceCenter();
}

window.tradeInvestment = function(type, action) {
    let price = marketRates[type];
    
    if(action === 'buy') {
        // Ne kadarlÄ±k alacak? (KullanÄ±cÄ±ya sormak yerine 1 birim veya 10 birim mantÄ±ÄŸÄ± yapabiliriz ama
        // kolaylÄ±k olsun diye "ParanÄ±n %10'u ile al" mantÄ±ÄŸÄ± kuralÄ±m veya prompt aÃ§alÄ±m)
        let amountStr = prompt(`${type.toUpperCase()} Birim FiyatÄ±: $${price}. KaÃ§ adet almak istiyorsunuz?`);
        if(!amountStr) return;
        let amount = parseInt(amountStr);
        let cost = amount * price;
        
        if(money < cost) return alert("Yetersiz Bakiye!");
        spendMoney( cost);
        investments[type] += amount;
        alert("YatÄ±rÄ±m yapÄ±ldÄ±!");
    } 
    else {
        // SatÄ±ÅŸ
        let amountStr = prompt(`${type.toUpperCase()} Birim FiyatÄ±: $${price}. KaÃ§ adet satmak istiyorsunuz? (Mevcut: ${investments[type]})`);
        if(!amountStr) return;
        let amount = parseInt(amountStr);
        
        if(amount > investments[type]) return alert("Elinizde bu kadar yok!");
        investments[type] -= amount;
        addMoney( amount * price);
        alert("SatÄ±ÅŸ gerÃ§ekleÅŸti ve para hesaba geÃ§ti.");
    }
    updateUI();
    showFinanceCenter();
}

window.findStableSponsor = function() {
    if(money < 5000) return alert("Sponsor gÃ¶rÃ¼ÅŸmeleri iÃ§in $5.000 bÃ¼tÃ§e ayÄ±rmalÄ±sÄ±nÄ±z.");
    spendMoney( 5000);

    let companies = [
        { name: "KoÃ§ Holding", income: rand(10000, 20000), weeks: 10 },
        { name: "TÃ¼rk Hava YollarÄ±", income: rand(15000, 25000), weeks: 8 },
        { name: "Ãœlker", income: rand(5000, 10000), weeks: 20 },
        { name: "Vestel", income: rand(8000, 15000), weeks: 12 },
        { name: "Trendyol", income: rand(20000, 30000), weeks: 6 } // KÄ±sa ama Ã§ok para
    ];

    let offer = pick(companies);
    
    if(confirm(`TEKLÄ°F GELDÄ°!\n\nÅirket: ${offer.name}\nHaftalÄ±k Ã–deme: $${offer.income.toLocaleString()}\nSÃ¼re: ${offer.weeks} Hafta\n\nKabul ediyor musunuz?`)) {
        stableSponsor = { name: offer.name, weeklyIncome: offer.income, weeksLeft: offer.weeks };
        alert("AnlaÅŸma saÄŸlandÄ±! Ä°lk Ã¶deme haftaya.");
    } else {
        alert("Teklifi reddettiniz.");
    }
    updateUI();
    showFinanceCenter();
}
// --- SEZON FÄ°NALÄ° VE Ã–DÃœL TÃ–RENÄ° ---
function endSeasonGala() {
    // 1. Ä°statistikleri Hesapla
    let allHorses = [...myHorses, ...allOpponents];
    
    // YÄ±lÄ±n AtÄ± (En Ã§ok kazanan)
    let horseOfTheYear = allHorses.sort((a,b) => {
        let earnA = a.history.filter(r => Math.ceil(r.week/48) === year).reduce((t,r)=>t+r.earnings,0);
        let earnB = b.history.filter(r => Math.ceil(r.week/48) === year).reduce((t,r)=>t+r.earnings,0);
        return earnB - earnA;
    })[0];

    // Sizin Ä°statistikleriniz
    let myTotalEarnings = myHorses.reduce((acc, h) => {
        return acc + h.history.filter(r => Math.ceil(r.week/48) === year).reduce((t,r)=>t+r.earnings,0);
    }, 0);
    
    let myTotalWins = myHorses.reduce((acc, h) => {
        return acc + h.history.filter(r => Math.ceil(r.week/48) === year && r.rank === 1).length;
    }, 0);

    // Menajer PuanÄ±
    let managerRating = "Ã‡IRAK";
    if(myTotalEarnings > 1000000) managerRating = "PROFESYONEL";
    if(myTotalEarnings > 5000000) managerRating = "DÃœNYA KLASI";
    if(myTotalEarnings > 20000000) managerRating = "EFSANE";

    // 2. HTML Ä°Ã§eriÄŸi HazÄ±rla
    let html = `
        <div style="text-align:center; color:#fff;">
            <h1 style="color:#f1c40f; text-shadow:0 0 20px #f1c40f; font-size:40px; margin-bottom:10px;">âœ¨ SEZON ${year} FÄ°NALÄ° âœ¨</h1>
            <p style="color:#aaa;">Bir yÄ±l daha geride kaldÄ±. Ä°ÅŸte sezonun en iyileri!</p>
            
            <div style="display:flex; justify-content:center; gap:20px; margin-top:30px;">
                <div style="background:linear-gradient(to bottom, #d35400, #000); padding:20px; border:2px solid #e67e22; border-radius:15px; width:45%;">
                    <div style="font-size:50px;">ğŸ¦„</div>
                    <h3 style="color:#e67e22; margin:10px 0;">YILIN ATI</h3>
                    <div style="font-size:24px; font-weight:bold;">${horseOfTheYear.name}</div>
                    <div style="color:#aaa; font-size:12px;">Sahibi: ${horseOfTheYear.stable || 'SÄ°Z'}</div>
                </div>

                <div style="background:linear-gradient(to bottom, #2980b9, #000); padding:20px; border:2px solid #3498db; border-radius:15px; width:45%;">
                    <div style="font-size:50px;">ğŸ¤µ</div>
                    <h3 style="color:#3498db; margin:10px 0;">MENAJER KARNESÄ°</h3>
                    <div style="text-align:left; padding-left:20px;">
                        <p>ğŸ’° KazanÃ§: <span style="color:#fff;">$${myTotalEarnings.toLocaleString()}</span></p>
                        <p>ğŸ† Kupa: <span style="color:#fff;">${myTotalWins}</span></p>
                        <p>ğŸŒŸ Unvan: <span style="color:#f1c40f; font-weight:bold;">${managerRating}</span></p>
                    </div>
                </div>
            </div>

            <br><br>
            <button class="next-btn" style="font-size:22px; padding:20px 50px; background:#27ae60; border-color:#2ecc71;" onclick="startNewSeason()">
                ğŸš€ YENÄ° SEZONA BAÅLA (YIL ${year + 1})
            </button>
        </div>
    `;

    document.getElementById("modalBody").innerHTML = html;
    document.getElementById("modalOverlay").style.display = "flex";
    
    // Konfeti BaÅŸlat
    if(typeof startConfetti === "function") startConfetti();
}

function startNewSeason() {
    year++;
    week = 1;
    
    // AtlarÄ± yaÅŸlandÄ±r
    myHorses.forEach(h => { h.age = Math.floor(h.age) + 1; });
    allOpponents.forEach(h => { h.age = Math.floor(h.age) + 1; });

    // Rakipleri ve PazarÄ± yenile
    generateOpponents();
    refreshMarket();
    
    // Log ekle
    weeklyLogs.push(`ğŸ† YENÄ° YIL KUTLU OLSUN! HoÅŸgeldin ${year}. Sezon.`);
    
    // Konfetiyi durdur ve kapat
    if(typeof stopConfetti === "function") stopConfetti();
    document.getElementById("modalOverlay").style.display = "none";
    
    // Yeni haftayÄ± baÅŸlat
    generateWeeklyRaces();
    updateUI();
    
    // KÃ¼Ã§Ã¼k bir hediye
    addMoney(100000);
    alert(`Yeni sezon hediyesi olarak federasyondan hesabÄ±nÄ±za $100.000 yatÄ±rÄ±ldÄ±! BaÅŸarÄ±lar!`);
}
// --- ALTILI GANYAN MODÃœLÃœ ---
let jackpotAmount = 2500000; // BaÅŸlangÄ±Ã§ Ä°kramiyesi: 2.5 Milyon $
let ganyanBulletin = []; // O haftanÄ±n bÃ¼lteni

function openGanyanModal() {
    // BÃ¼lteni oluÅŸtur (Her hafta rastgele 6 ayak)
    ganyanBulletin = [];
    for(let i=1; i<=6; i++) {
        let runners = [];
        let horseCount = rand(8, 12); // Her ayakta 8-12 at koÅŸsun
        for(let k=0; k<horseCount; k++) {
            let power = rand(50, 100); // AtÄ±n gÃ¼cÃ¼
            runners.push({ id: k, name: generateHorseName(), power: power, odds: (100/power).toFixed(2) });
        }
        ganyanBulletin.push({ leg: i, runners: runners });
    }

    // HTML'i hazÄ±rla
    let legsHtml = "";
    ganyanBulletin.forEach(leg => {
        let options = leg.runners.map(r => `<option value="${r.id}">(${r.odds}) ${r.name}</option>`).join("");
        legsHtml += `
            <div class="ganyan-leg">
                <h4>AYAK ${leg.leg} (1${rand(2,9)}00m)</h4>
                <select id="ganyan_pick_${leg.leg}" class="ganyan-select">${options}</select>
                <small style="color:#555">Favori: ${leg.runners.sort((a,b)=>b.power-a.power)[0].name}</small>
            </div>
        `;
    });

    let html = `
        <button class="close-btn" onclick="document.getElementById('modalOverlay').style.display='none'">X</button>
        <div class="ganyan-ticket">
            <h1 style="text-align:center; margin:0;">TÃœRKÄ°YE JOKEY KULÃœBÃœ</h1>
            <h3 style="text-align:center; margin:5px 0;">ALTILI GANYAN KUPONU</h3>
            <div class="jackpot-display">ğŸ’° DEVREDEN Ä°KRAMÄ°YE: $${jackpotAmount.toLocaleString()}</div>
            
            <div class="ganyan-grid">${legsHtml}</div>
            
            <div style="text-align:center; margin-top:20px; border-top:2px dashed #000; padding-top:10px;">
                <p>Kupon Bedeli: <strong>$500</strong></p>
                <button class="menu-btn" style="background:#000; color:#fff; width:50%;" onclick="playGanyan()">ğŸ° KUPONU YATIR VE BAÅLAT</button>
            </div>
        </div>
    `;
    
    document.getElementById("modalBody").innerHTML = html;
    document.getElementById("modalOverlay").style.display = "flex";
}

function playGanyan() {
    if(money < 500) return alert("Kupon bedeli ($500) iÃ§in paranÄ±z yetersiz!");
    
    // SeÃ§imleri al
    let picks = [];
    for(let i=1; i<=6; i++) {
        let val = document.getElementById(`ganyan_pick_${i}`).value;
        picks.push(parseInt(val));
    }

    if(!confirm("Kuponu onaylÄ±yor musunuz? Bedel: $500")) return;
    spendMoney(500);

    // YarÄ±ÅŸlarÄ± SimÃ¼le Et (Hemen sonuÃ§lansÄ±n)
    let winners = [];
    let correctCount = 0;
    
    // SonuÃ§ EkranÄ± Ä°Ã§in HTML HazÄ±rlÄ±ÄŸÄ±
    let resultHTML = `<button class="close-btn" onclick="document.getElementById('modalOverlay').style.display='none'">X</button>
                      <h2 style="color:#f1c40f; text-align:center">ğŸ ALTILI GANYAN SONUÃ‡LARI</h2>
                      <div class="ganyan-ticket" style="background:#222; color:#fff; border-top-color:#f1c40f;">`;

    ganyanBulletin.forEach((leg, index) => {
        // KazananÄ± belirle (GÃ¼ce dayalÄ± ÅŸans)
        let totalPower = leg.runners.reduce((a,b) => a + b.power, 0);
        let randomPoint = Math.random() * totalPower;
        let runningSum = 0;
        let winner = null;
        
        for(let r of leg.runners) {
            runningSum += r.power;
            if(randomPoint <= runningSum) { winner = r; break; }
        }
        if(!winner) winner = leg.runners[leg.runners.length-1]; // GÃ¼venlik

        // Kontrol et
        let userPickId = picks[index];
        let userHorse = leg.runners.find(r => r.id === userPickId);
        let isCorrect = (userHorse.id === winner.id);
        if(isCorrect) correctCount++;

        let icon = isCorrect ? "âœ…" : "âŒ";
        let color = isCorrect ? "#2ecc71" : "#e74c3c";

        resultHTML += `
            <div style="border-bottom:1px solid #444; padding:10px; display:flex; justify-content:space-between; align-items:center;">
                <span><strong>${leg.leg}. AYAK:</strong> Kazanan <span style="color:#f1c40f">${winner.name}</span></span>
                <span style="color:${color}; font-weight:bold;">${icon} Senin SeÃ§imin: ${userHorse.name}</span>
            </div>
        `;
    });

    resultHTML += `</div>`;

    // Ã–dÃ¼l KontrolÃ¼
    if(correctCount === 6) {
        // BÃœYÃœK Ä°KRAMÄ°YE!
        addMoney(jackpotAmount);
        resultHTML += `<div style="text-align:center; margin-top:20px;">
            <h1 style="color:#2ecc71; font-size:40px; animation:pulse 0.5s infinite;">ğŸ‰ TEBRÄ°KLER! 6'LIYI BÄ°LDÄ°NÄ°Z! ğŸ‰</h1>
            <p style="font-size:24px; color:#fff;">KAZANILAN TUTAR: $${jackpotAmount.toLocaleString()}</p>
        </div>`;
        jackpotAmount = 2500000; // Ä°kramiyeyi sÄ±fÄ±rla (varsayÄ±lan deÄŸere)
        if(typeof startConfetti === "function") startConfetti(); // Konfeti patlat
    } else {
        // Kaybettin
        // Ä°kramiye artar (Devreder)
        let rollOver = rand(50000, 200000);
        jackpotAmount += rollOver;
        resultHTML += `<div style="text-align:center; margin-top:20px;">
            <h2 style="color:#e74c3c;">${correctCount}/6 BÄ°LDÄ°NÄ°Z.</h2>
            <p style="color:#aaa;">Maalesef kaybettiniz. Ä°kramiye haftaya devretti!</p>
            <p style="color:#f1c40f;">Yeni Devreden Tutar: $${jackpotAmount.toLocaleString()}</p>
        </div>`;
    }
    
    resultHTML += `<button class="menu-btn" style="width:100%; margin-top:20px;" onclick="document.getElementById('modalOverlay').style.display='none'; if(typeof stopConfetti === 'function') stopConfetti();">TAMAM</button>`;

    document.getElementById("modalBody").innerHTML = resultHTML;
}
// --- RÄ°SK VE SAKATLIK HESAPLAYICI ---
function calculateRisk(horse, race) {
    let risk = 0; // %0 ile baÅŸlar
    let warnings = [];

    // 1. Kondisyon Riski (En Ã¶nemlisi)
    if (horse.condition < 30) { risk += 40; warnings.push("At Ã§ok yorgun (Kondisyon <%30)"); }
    else if (horse.condition < 50) { risk += 15; warnings.push("AtÄ±n dinlenmeye ihtiyacÄ± var"); }

    // 2. Pist ve Hava Riski
    if (race.weather === 'Ã‡amurlu') {
        risk += 15;
        if (horse.surface === 'Ã‡im') { risk += 10; warnings.push("Ã‡imci at Ã‡amurda zorlanÄ±r"); }
        else warnings.push("Zemin Ã§ok aÄŸÄ±r (Ã‡amur)");
    }
    else if (race.weather === 'YaÄŸmurlu') { risk += 5; }

    // 3. YaÅŸlÄ±lÄ±k Riski
    if (horse.age >= 6) { risk += 10; warnings.push("YaÅŸlÄ± atlarda sakatlÄ±k riski yÃ¼ksek"); }

    return { percent: Math.min(80, risk), messages: warnings };
}
// --- [YENÄ°] V33 PEDÄ°GRÄ° (SOY AÄACI) SÄ°STEMÄ° ---

// Efsane Ä°sim Ãœretici (GeÃ§miÅŸ kuÅŸaklar iÃ§in)
function generateLegendName(gender) {
    // Efsane AygÄ±rlar
    const sires = ["Northern Dancer", "Secretariat", "Bold Ruler", "Nearco", "Native Dancer", "Mr. Prospector", "Storm Cat", "Galileo", "Sadler's Wells", "Frankel", "Deep Impact", "Seattle Slew", "American Pharoah", "Justify", "Bold Pilot"];
    // Efsane KÄ±sraklar
    const dams = ["Somethingroyal", "Urban Sea", "La Troienne", "Miesque", "Zenyatta", "Winx", "Black Caviar", "Ruffian", "Personal Ensign", "Rachel Alexandra", "Goldikova", "Enable"];
    
    // Rastgele seÃ§ (pick fonksiyonu yoksa manuel seÃ§)
    const list = gender === 'male' ? sires : dams;
    return list[Math.floor(Math.random() * list.length)];
}

window.openPedigree = function(horseId) {
    const h = myHorses.find(x => x.id == horseId);
    if (!h) return;

    // 1. KUÅAK (BÄ°ZÄ°M AT)
    // AtÄ±n bilgilerini alÄ±yoruz

    // 2. KUÅAK (ANNE - BABA)
    // EÄŸer oyun iÃ§inde Ã¼retildiyse kayÄ±tlÄ± ismi al, yoksa efsanelerden tÃ¼ret
    let sireName = h.sireName || generateLegendName('male');
    let damName = h.damName || generateLegendName('female');

    // 3. KUÅAK (DEDELER VE NÄ°NELER) - BurasÄ± "Lore" (Hikaye) kÄ±smÄ±
    // Her at iÃ§in rastgele efsaneler seÃ§iyoruz
    let sireSire = generateLegendName('male'); 
    let sireDam = generateLegendName('female');
    let damSire = generateLegendName('male');
    let damDam = generateLegendName('female');

    // HTML OLUÅTURMA (MODERN AÄAÃ‡)
    let html = `
    <div class="pedigree-tree">
        <div class="gen-col" style="flex:1.5;">
            <div class="ped-box ${h.gender === 'AygÄ±r' ? 'sire-box' : 'dam-box'}" style="transform:scale(1.1); border-color:#f1c40f; box-shadow:0 0 15px rgba(241,196,15,0.3);">
                <div class="ped-role">SEÃ‡Ä°LEN SAFKAN</div>
                <div class="ped-name" style="font-size:20px; color:#f1c40f;">${h.name.toUpperCase()}</div>
                <div class="ped-stat">${h.rating} Puan | ${h.gender}</div>
            </div>
        </div>

        <div class="gen-col">
            <div class="ped-box sire-box">
                <div class="ped-role">BABA (SIRE)</div>
                <div class="ped-name">${sireName}</div>
                <div class="ped-stat">Champion Bloodline</div>
            </div>
            <div class="ped-box dam-box">
                <div class="ped-role">ANNE (DAM)</div>
                <div class="ped-name">${damName}</div>
                <div class="ped-stat">Elite Broodmare</div>
            </div>
        </div>

        <div class="gen-col">
            <div class="ped-box sire-box"><div class="ped-role">BABA'NIN BABASI</div><div class="ped-name">${sireSire}</div></div>
            <div class="ped-box dam-box"><div class="ped-role">BABA'NIN ANNESÄ°</div><div class="ped-name">${sireDam}</div></div>
            <div class="ped-box sire-box"><div class="ped-role">ANNE'NÄ°N BABASI</div><div class="ped-name">${damSire}</div></div>
            <div class="ped-box dam-box"><div class="ped-role">ANNE'NÄ°N ANNESÄ°</div><div class="ped-name">${damDam}</div></div>
        </div>
    </div>
    
    <div style="margin-top:25px; padding:10px; background:#111; border-radius:8px; font-size:12px; color:#aaa; text-align:center; border:1px dashed #333;">
        ğŸ§¬ <strong>DNA ANALÄ°ZÄ°:</strong> Bu atÄ±n damarlarÄ±nda <strong>${sireSire}</strong> ve <strong>${damSire}</strong> gibi efsanelerin kanÄ± dolaÅŸÄ±yor.
        Potansiyel HÄ±z MirasÄ±: %${Math.floor(Math.random()*20)+80}.
    </div>
    `;

    document.getElementById("pedigreeTreeDisplay").innerHTML = html;
    document.getElementById("pedigreeModal").style.display = 'flex';
}

window.closePedigreeModal = function() {
    document.getElementById("pedigreeModal").style.display = 'none';
}
// --- EKSÄ°K OLAN KAZANÃ‡ HESAPLAMA FONKSÄ°YONU ---
function calculateTotalEarnings(horse) {
    if(!horse.history) return 0;
    // AtÄ±n geÃ§miÅŸindeki tÃ¼m kazanÃ§larÄ± topla
    return horse.history.reduce((total, race) => total + (race.earnings || 0), 0);
}
// --- ADMIN PANELÄ° FONKSÄ°YONLARI ---
window.showAdminPanel = function() {
    // YaÅŸ gruplarÄ±na gÃ¶re en iyi deÄŸerleri bul
    let best2yo = myHorses.filter(h => Math.floor(h.age) === 2);
    let best3plus = myHorses.filter(h => Math.floor(h.age) >= 3);

    let max2yo = best2yo.length > 0 ? Math.max(...best2yo.map(h => h.sprint)) : 150;
    let max3plus = best3plus.length > 0 ? Math.max(...best3plus.map(h => h.sprint)) : 200;
    
    let html = `
        <div style="background:#1a1a1a; padding:20px; border:2px solid #e74c3c; border-radius:10px; color:white;">
            <h2 style="color:#e74c3c; text-align:center; margin-bottom:20px;">ğŸ› ï¸ ADMIN & YAÅ KATEGORÄ° PANELÄ°</h2>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="menu-btn" style="background:#c0392b; color:white; border:none; padding:15px;" 
                    onclick="syncBotsByCategory()">ğŸ”¥ RAKÄ°PLERÄ° YAÅA GÃ–RE EÅÄ°TLE</button>
                
                <button class="menu-btn" style="background:#d35400; color:white; border:none; padding:15px;" 
                    onclick="addMoney(10000000); alert('10M Para Eklendi!')">ğŸ’° +10M PARA EKLE</button>
            </div>
            
            <div style="margin-top:20px; text-align:center; background:#222; padding:10px; border-radius:5px;">
                <p style="color:#2ecc71; margin:5px 0;">ğŸ¥ 2 YaÅŸlÄ± Zirven: <b>${Math.floor(max2yo)} HP</b></p>
                <p style="color:#3498db; margin:5px 0;">ğŸ 3+ YaÅŸlÄ± Zirven: <b>${Math.floor(max3plus)} HP</b></p>
                <small style="color:#aaa;">(Rakipler artÄ±k kendi yaÅŸ grubuna gÃ¶re gÃ¼ncellenecek)</small>
            </div>
            
            <button class="next-btn" style="width:100%; margin-top:15px; background:#444;" 
                onclick="document.getElementById('modalOverlay').style.display='none'">PANELÄ° KAPAT</button>
        </div>
    `;
    document.getElementById("modalBody").innerHTML = html;
    document.getElementById("modalOverlay").style.display = "flex";
};

// Rakipleri senin seviyene Ã§eken fonksiyon
window.syncBotsByCategory = function() {
    if (myHorses.length === 0) return alert("Ã–nce en az bir atÄ±nÄ±z olmalÄ±!");
    
    // Senin ahÄ±rÄ±ndaki yaÅŸ grubu liderlerini bul
    let my2yo = myHorses.filter(h => Math.floor(h.age) === 2);
    let my3plus = myHorses.filter(h => Math.floor(h.age) >= 3);

    let max2yoSprint = my2yo.length > 0 ? Math.max(...my2yo.map(h => h.sprint)) : 150;
    let max3plusSprint = my3plus.length > 0 ? Math.max(...my3plus.map(h => h.sprint)) : 200;
    
    allOpponents.forEach(opp => {
        let age = Math.floor(opp.age);
        let targetSprint, targetStamina;

        if (age === 2) {
            // 2 yaÅŸlÄ± botlarÄ± senin en iyi 2 yaÅŸlÄ±na gÃ¶re ayarla
            targetSprint = max2yoSprint;
            targetStamina = max2yoSprint * 0.9; 
        } else {
            // 3 ve yukarÄ± yaÅŸtaki botlarÄ± senin en iyi yaÅŸlÄ± atÄ±na gÃ¶re ayarla
            targetSprint = max3plusSprint;
            targetStamina = max3plusSprint;
        }

        // Dengeleme: Hedefin %95 ile %105'i arasÄ± bir gÃ¼Ã§ ver
        opp.sprint = Math.floor(targetSprint * (rand(95, 105) / 100));
        opp.stamina = Math.floor(targetStamina * (rand(95, 105) / 100));
        opp.maxSprint = opp.sprint + 50;
        opp.maxStamina = opp.stamina + 50;
        opp.rating = rand(targetSprint < 200 ? 50 : 100, 140);
    });
    
    alert("Rakipler yaÅŸ gruplarÄ±na gÃ¶re ayrÄ±ÅŸtÄ±rÄ±larak gÃ¼ncellendi! ArtÄ±k ÅŸampiyonlarÄ±n kendi liginde yarÄ±ÅŸacak.");
    document.getElementById('modalOverlay').style.display = 'none';
};
</script> 
<div id="championOverlay" class="champion-overlay" onclick="closeChampionModal()">
    <div id="confettiContainer"></div>
    <div class="champion-card">
        <div class="champion-inner">
            <h1 class="champ-title">ğŸ† ÅAMPÄ°YON! ğŸ†</h1>
            <div id="champHorseName" class="champ-horse-name">ATIN ADI</div>
            <img src="resimler/at.gif" id="champHorseImg" style="height:150px; border-radius:50%; border:4px solid #f1c40f; margin-bottom:20px;">
            <br>
            <div id="champPrize" class="champ-prize">KAZANÃ‡: $100,000</div>
            <p style="color:#aaa; font-size:12px; margin-top:20px;">(Devam etmek iÃ§in ekrana tÄ±kla)</p>
        </div>
    </div>
</div>
</script>
 <div id="pedigreeModal" class="modal-overlay" style="display:none; z-index:99999; background:rgba(0,0,0,0.85);">
    <div class="pedigree-modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; padding-bottom:10px;">
            <h2 style="color:#f1c40f; margin:0;">ğŸ§¬ SOY AÄACI DETAYI</h2>
            <button onclick="closePedigreeModal()" style="background:none; border:none; color:#fff; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div id="pedigreeTreeDisplay"></div>
        <div style="text-align:center; margin-top:15px;">
            <button class="menu-btn" onclick="closePedigreeModal()">KAPAT</button>
        </div>
    </div>
</div>
</body>
</html>
</body>
</html>